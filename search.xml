<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>æ ¡å›­ç¤¾åŒºè®ºå›é¡¹ç›®ä¹‹ ElasticSearch</title>
      <link href="/2023/03/07/ElasticSearch/"/>
      <url>/2023/03/07/ElasticSearch/</url>
      
        <content type="html"><![CDATA[<h1 id="Elasticsearchç®€ä»‹"><a href="#Elasticsearchç®€ä»‹" class="headerlink" title="Elasticsearchç®€ä»‹"></a>Elasticsearchç®€ä»‹</h1><ul><li>ä¸€ä¸ªåˆ†å¸ƒå¼çš„ã€Restful é£æ ¼çš„æœç´¢å¼•æ“ã€‚ </li><li>æ”¯æŒå¯¹å„ç§ç±»å‹çš„æ•°æ®çš„æ£€ç´¢ã€‚ </li><li>æœç´¢é€Ÿåº¦å¿«ï¼Œå¯ä»¥æä¾›å®æ—¶çš„æœç´¢æœåŠ¡ã€‚ </li><li>ä¾¿äºæ°´å¹³æ‰©å±•ï¼Œæ¯ç§’å¯ä»¥å¤„ç† PB çº§æµ·é‡æ•°æ®ã€‚ </li><li>Elasticsearch æœ¯è¯­<ul><li>ç´¢å¼•ã€ç±»å‹ã€æ–‡æ¡£ã€å­—æ®µ</li><li>é›†ç¾¤ã€èŠ‚ç‚¹ã€åˆ†ç‰‡ã€å‰¯æœ¬ã€‚</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Spring Boot </tag>
            
            <tag> ElasticSearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ ¡å›­ç¤¾åŒºè®ºå›é¡¹ç›®ä¹‹ Kafka</title>
      <link href="/2023/03/07/community5/"/>
      <url>/2023/03/07/community5/</url>
      
        <content type="html"><![CDATA[<p>ğŸŒŸ æœ¬å¸–è®°å½• Spring Boot æ•´åˆ Kafka å®ç°æ ¡å›­ç¤¾åŒºè®ºå›é¡¹ç›®çš„å‘é€ç³»ç»Ÿé€šçŸ¥ã€æ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥çš„åŠŸèƒ½ã€‚</p><p>ğŸŒŸ å‡†å¤‡å·¥ä½œï¼š</p><ol><li>å¼•å…¥ Kafka ä¾èµ–åˆ° pom.xml æ–‡ä»¶ä¸­ï¼š</li></ol><pre><code class="xml">&lt;dependency&gt;    &lt;groupId&gt;org.springframework.kafka&lt;/groupId&gt;    &lt;artifactId&gt;spring-kafka&lt;/artifactId&gt;&lt;/dependency&gt;</code></pre><ol start="2"><li>åœ¨ application.properties æ–‡ä»¶ä¸­é…ç½® Kafka çš„ server å’Œ consumerï¼š</li></ol><pre><code class="properties"># KafkaPropertiesspring.kafka.bootstrap-servers=localhost:9092spring.kafka.consumer.group-id=community-consumer-groupspring.kafka.consumer.enable-auto-commit=truespring.kafka.consumer.auto-commit-interval=3000</code></pre><ol start="3"><li>è®¿é—® Kafkaï¼š</li></ol><p>ç”Ÿäº§è€…</p><pre><code>kafkaTemplate.send(topic, data);</code></pre><p>æ¶ˆè´¹è€…</p><pre><code>@KafkaListener(topic = &#123;&quot;test&quot;&#125;)</code></pre><pre><code>public void handleMessage(ConsumerRecord record)&#123;&#125;</code></pre><h1 id="1-å‘é€ç³»ç»Ÿé€šçŸ¥"><a href="#1-å‘é€ç³»ç»Ÿé€šçŸ¥" class="headerlink" title="1. å‘é€ç³»ç»Ÿé€šçŸ¥"></a>1. å‘é€ç³»ç»Ÿé€šçŸ¥</h1><ol><li>è§¦å‘äº‹ä»¶ï¼šè¯„è®ºåå‘å¸ƒé€šçŸ¥ï¼›ç‚¹èµåå‘å¸ƒé€šçŸ¥ï¼›å…³æ³¨åå‘å¸ƒé€šçŸ¥ã€‚</li><li>å¤„ç†äº‹ä»¶ï¼šå°è£…äº‹ä»¶å¯¹è±¡ï¼›å¼€å‘äº‹ä»¶çš„ç”Ÿäº§è€…ï¼›å¼€å‘äº‹ä»¶çš„æ¶ˆè´¹è€…ã€‚</li></ol><h2 id="åˆ›å»ºå®ä½“ç±»-Event"><a href="#åˆ›å»ºå®ä½“ç±»-Event" class="headerlink" title="åˆ›å»ºå®ä½“ç±» Event"></a>åˆ›å»ºå®ä½“ç±» Event</h2><ul><li>å°è£…äº‹ä»¶å¯¹è±¡ï¼ŒåŒ…æ‹¬ä¸»é¢˜ã€ç”¨æˆ· idã€å®ä½“ç±»å‹ã€å®ä½“ idã€å®ä½“ç”¨æˆ· id ä»¥åŠä¸€ä¸ª map é›†åˆå­˜æ”¾å…¶å®ƒä¿¡æ¯ã€‚</li></ul><pre><code class="java">public class Event &#123;    private String topic;    private int userId;    private int entityType;    private int entityId;    private int entityUserId;    private Map&lt;String, Object&gt; data = new HashMap&lt;&gt;();    public String getTopic() &#123;        return topic;    &#125;    public Event setTopic(String topic) &#123;        this.topic = topic;        return this;    &#125;    public int getUserId() &#123;        return userId;    &#125;    public Event setUserId(int userId) &#123;        this.userId = userId;        return this;    &#125;    public int getEntityType() &#123;        return entityType;    &#125;    public Event setEntityType(int entityType) &#123;        this.entityType = entityType;        return this;    &#125;    public int getEntityId() &#123;        return entityId;    &#125;    public Event setEntityId(int entityId) &#123;        this.entityId = entityId;        return this;    &#125;    public int getEntityUserId() &#123;        return entityUserId;    &#125;    public Event setEntityUserId(int entityUserId) &#123;        this.entityUserId = entityUserId;        return this;    &#125;    public Map&lt;String, Object&gt; getData() &#123;        return data;    &#125;    public Event setData(String key, Object value) &#123;        this.data.put(key, value);        return this;    &#125;&#125;</code></pre><h2 id="æ›´æ–°æ¥å£-CommunityConstant"><a href="#æ›´æ–°æ¥å£-CommunityConstant" class="headerlink" title="æ›´æ–°æ¥å£ CommunityConstant"></a>æ›´æ–°æ¥å£ CommunityConstant</h2><ul><li>åœ¨æ¥å£ä¸­æ–°å¢ä¸‰ä¸ªå¸¸é‡ï¼Œä»£è¡¨ä¸‰ä¸ªä¸»é¢˜ï¼šè¯„è®ºã€ç‚¹èµã€å…³æ³¨ã€‚</li></ul><pre><code class="java">/** * ä¸»é¢˜: è¯„è®º */String TOPIC_COMMENT = &quot;comment&quot;;/** * ä¸»é¢˜: ç‚¹èµ */String TOPIC_LIKE = &quot;like&quot;;/** * ä¸»é¢˜: å…³æ³¨ */String TOPIC_FOLLOW = &quot;follow&quot;;</code></pre><h2 id="åˆ›å»ºäº‹ä»¶ç”Ÿäº§è€…ç±»-EventProducer"><a href="#åˆ›å»ºäº‹ä»¶ç”Ÿäº§è€…ç±»-EventProducer" class="headerlink" title="åˆ›å»ºäº‹ä»¶ç”Ÿäº§è€…ç±» EventProducer"></a>åˆ›å»ºäº‹ä»¶ç”Ÿäº§è€…ç±» EventProducer</h2><ul><li>æ–°å¢æ–¹æ³• <code>fireEvent(Event event)</code> ï¼šé€šè¿‡ Event è·å–äº‹ä»¶ç±»å‹ï¼Œå¹¶å°†å…¶å°è£…æˆ JSON æ•°æ®ï¼Œç„¶åè°ƒç”¨æ³¨å…¥çš„ KafkaTemplate å®ä¾‹çš„æ–¹æ³• <code>send()</code> å‘é€ã€‚</li></ul><pre><code class="java">@Componentpublic class EventProducer &#123;    @Autowired    private KafkaTemplate kafkaTemplate;    // å¤„ç†äº‹ä»¶    public void fireEvent(Event event) &#123;        // å°†äº‹ä»¶å‘å¸ƒåˆ°æŒ‡å®šçš„ä¸»é¢˜        kafkaTemplate.send(event.getTopic(), JSONObject.toJSONString(event));    &#125;&#125;</code></pre><h2 id="æ›´æ–°è¡¨ç°å±‚çš„-CommentControllerã€LikeControllerã€FollowController"><a href="#æ›´æ–°è¡¨ç°å±‚çš„-CommentControllerã€LikeControllerã€FollowController" class="headerlink" title="æ›´æ–°è¡¨ç°å±‚çš„ CommentControllerã€LikeControllerã€FollowController"></a>æ›´æ–°è¡¨ç°å±‚çš„ CommentControllerã€LikeControllerã€FollowController</h2><ul><li>æ³¨å…¥ EventProducer å®ä¾‹ã€‚</li><li>é‡æ„è¡¨ç°å±‚ CommentController ç±»çš„æ–¹æ³• <code>addComment()</code>  ï¼Œå°è£… Event å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ EventProducer ç±»çš„ <code>fireEvent()</code>  æ–¹æ³•å‘å¸ƒé€šçŸ¥ã€‚</li></ul><pre><code class="java">@PostMapping(&quot;/add/&#123;discussPostId&#125;&quot;)public String addComment(@PathVariable(&quot;discussPostId&quot;) int discussPostId, Comment comment) &#123;    comment.setUserId(hostHolder.getUser().getId());    comment.setStatus(0);    comment.setCreateTime(new Date());    commentService.addComment(comment);    // è§¦å‘è¯„è®ºäº‹ä»¶    Event event = new Event()            .setTopic(TOPIC_COMMENT)            .setUserId(hostHolder.getUser().getId())            .setEntityType(comment.getEntityType())            .setEntityId(comment.getEntityId())            .setData(&quot;postId&quot;, discussPostId);    if (comment.getEntityType() == ENTITY_TYPE_POST) &#123;        DiscussPost target = discussPostService.findDiscussPostById(comment.getEntityId());        event.setEntityUserId(target.getUserId());    &#125; else if (comment.getEntityType() == ENTITY_TYPE_COMMENT) &#123;        Comment target = commentService.findCommentById(comment.getEntityId());        event.setEntityUserId(target.getUserId());    &#125;    eventProducer.fireEvent(event);    return &quot;redirect:/discuss/detail/&quot; + discussPostId;&#125;</code></pre><ul><li>é‡æ„è¡¨ç°å±‚ LikeController ç±»çš„æ–¹æ³• <code>like()</code>  ï¼Œå°è£… Event å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ EventProducer ç±»çš„ <code>fireEvent()</code>  æ–¹æ³•å‘å¸ƒé€šçŸ¥ã€‚</li></ul><pre><code class="java">@PostMapping(&quot;/like&quot;)@ResponseBodypublic String like(int entityType, int entityId, int entityUserId, int postId) &#123;    User user = hostHolder.getUser();    // ç‚¹èµ    likeService.like(user.getId(), entityType, entityId, entityUserId);    // æ•°é‡    long likeCount = likeService.findEntityLikeCount(entityType, entityId);    // çŠ¶æ€    int likeStatus = likeService.findEntityLikeStatus(user.getId(), entityType, entityId);    // è¿”å›çš„ç»“æœ    Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();    map.put(&quot;likeCount&quot;, likeCount);    map.put(&quot;likeStatus&quot;, likeStatus);    // è§¦å‘ç‚¹èµäº‹ä»¶    if (likeStatus == 1) &#123;        Event event = new Event()                .setTopic(TOPIC_LIKE)                .setUserId(hostHolder.getUser().getId())                .setEntityType(entityType)                .setEntityId(entityId)                .setEntityUserId(entityUserId)                .setData(&quot;postId&quot;, postId);        eventProducer.fireEvent(event);    &#125;    return CommunityUtil.getJSONString(0, null, map);&#125;</code></pre><ul><li>é‡æ„è¡¨ç°å±‚ FollowController ç±»çš„æ–¹æ³• <code>follow()</code> ï¼Œå°è£… Event å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ EventProducer ç±»çš„ <code>fireEvent()</code>  æ–¹æ³•å‘å¸ƒé€šçŸ¥ã€‚</li></ul><pre><code class="java">@PostMapping(&quot;/follow&quot;)@ResponseBodypublic String follow(int entityType, int entityId) &#123;    User user = hostHolder.getUser();    followService.follow(user.getId(), entityType, entityId);    // è§¦å‘å…³æ³¨äº‹ä»¶    Event event = new Event()            .setTopic(TOPIC_FOLLOW)            .setUserId(hostHolder.getUser().getId())            .setEntityType(entityType)            .setEntityId(entityId)            .setEntityUserId(entityId);    eventProducer.fireEvent(event);    return CommunityUtil.getJSONString(0, &quot;å·²å…³æ³¨!&quot;);&#125;</code></pre><h2 id="åˆ›å»ºäº‹ä»¶æ¶ˆè´¹è€…ç±»-EventConsumer"><a href="#åˆ›å»ºäº‹ä»¶æ¶ˆè´¹è€…ç±»-EventConsumer" class="headerlink" title="åˆ›å»ºäº‹ä»¶æ¶ˆè´¹è€…ç±» EventConsumer"></a>åˆ›å»ºäº‹ä»¶æ¶ˆè´¹è€…ç±» EventConsumer</h2><ul><li>æ³¨å…¥ MessageService å®ä¾‹ã€‚</li><li>æ–°å¢æ–¹æ³• <code>handleCommentMessage(ConsumerRecord record)</code> ï¼šé€šè¿‡ <code>@KafkaListener</code> æ³¨è§£ï¼Œtopic åŒ…æ‹¬äº†è¯„è®ºã€ç‚¹èµå’Œå…³æ³¨ã€‚ä» record ä¸­è·å–ä¿¡æ¯ï¼Œå°è£…æˆ Message å¯¹è±¡ç„¶åè°ƒç”¨æ–¹æ³• <code>addMessage()</code> æ’å…¥æ•°æ®åº“ã€‚</li></ul><pre><code class="java">@Componentpublic class EventConsumer implements CommunityConstant &#123;    private static final Logger logger = LoggerFactory.getLogger(EventConsumer.class);    @Autowired    private MessageService messageService;    @KafkaListener(topics = &#123;TOPIC_COMMENT, TOPIC_LIKE, TOPIC_FOLLOW&#125;)    public void handleCommentMessage(ConsumerRecord record) &#123;        if (record == null || record.value() == null) &#123;            logger.error(&quot;æ¶ˆæ¯çš„å†…å®¹ä¸ºç©º!&quot;);            return;        &#125;        Event event = JSONObject.parseObject(record.value().toString(), Event.class);        if (event == null) &#123;            logger.error(&quot;æ¶ˆæ¯æ ¼å¼é”™è¯¯!&quot;);            return;        &#125;        // å‘é€ç«™å†…é€šçŸ¥        Message message = new Message();        message.setFromId(SYSTEM_USER_ID);        message.setToId(event.getEntityUserId());        message.setConversationId(event.getTopic());        message.setCreateTime(new Date());        Map&lt;String, Object&gt; content = new HashMap&lt;&gt;();        content.put(&quot;userId&quot;, event.getUserId());        content.put(&quot;entityType&quot;, event.getEntityType());        content.put(&quot;entityId&quot;, event.getEntityId());        if (!event.getData().isEmpty()) &#123;            for (Map.Entry&lt;String, Object&gt; entry : event.getData().entrySet()) &#123;                content.put(entry.getKey(), entry.getValue());            &#125;        &#125;        message.setContent(JSONObject.toJSONString(content));        messageService.addMessage(message);    &#125;&#125;</code></pre><h1 id="2-æ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥"><a href="#2-æ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥" class="headerlink" title="2. æ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥"></a>2. æ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥</h1><ol><li>é€šçŸ¥åˆ—è¡¨ï¼šæ˜¾ç¤ºè¯„è®ºã€ç‚¹èµã€å…³æ³¨ä¸‰ç§ç±»å‹çš„é€šçŸ¥ã€‚</li><li>é€šçŸ¥è¯¦æƒ…ï¼šåˆ†é¡µæ˜¾ç¤ºæŸä¸€ç±»ä¸»é¢˜æ‰€åŒ…å«çš„é€šçŸ¥ã€‚</li><li>æœªè¯»æ¶ˆæ¯ï¼šåœ¨é¡µé¢å¤´éƒ¨æ˜¾ç¤ºæ‰€æœ‰æœªè¯»æ¶ˆæ¯çš„æ•°é‡ã€‚</li></ol><h2 id="æ›´æ–°æ¥å£-MessageMapper"><a href="#æ›´æ–°æ¥å£-MessageMapper" class="headerlink" title="æ›´æ–°æ¥å£ MessageMapper"></a>æ›´æ–°æ¥å£ MessageMapper</h2><ul><li>æ–°å¢æ–¹æ³• <code>selectLatestNotice(int userId, String topic)</code> ï¼ŒæŸ¥è¯¢æŸä¸»é¢˜æœ€æ–°çš„é€šçŸ¥ã€‚</li><li>æ–°å¢æ–¹æ³• <code>selectNoticeCount(int userId, String topic)</code> ï¼ŒæŸ¥è¯¢æŸä¸»é¢˜é€šçŸ¥çš„æ•°é‡ã€‚</li><li>æ–°å¢æ–¹æ³• <code>selectNoticeUnreadCount(int userId, String topic)</code> ï¼ŒæŸ¥è¯¢æœªè¯»é€šçŸ¥çš„æ•°é‡ã€‚</li></ul><pre><code class="java">// æŸ¥è¯¢æŸä¸ªä¸»é¢˜ä¸‹æœ€æ–°çš„é€šçŸ¥Message selectLatestNotice(int userId, String topic);// æŸ¥è¯¢æŸä¸ªä¸»é¢˜æ‰€åŒ…å«çš„é€šçŸ¥æ•°é‡int selectNoticeCount(int userId, String topic);// æŸ¥è¯¢æœªè¯»çš„é€šçŸ¥çš„æ•°é‡int selectNoticeUnreadCount(int userId, String topic);</code></pre><ul><li>åœ¨ <code>message-mapper.xml</code> é…ç½®ä¸‰ä¸ªæ–¹æ³•çš„ sql è¯­å¥ï¼Œå…¶ä¸­æŸ¥è¯¢æœªè¯»é€šçŸ¥æ—¶ä½¿ç”¨ if åŠ¨æ€è¯­å¥ï¼Œå¦‚æœæ²¡æœ‰ä¼ å…¥ topic å°±æŸ¥è¯¢æœªè¯»æ€»é‡ã€‚</li></ul><pre><code class="xml">&lt;sql id=&quot;selectFields&quot;&gt;    id, from_id, to_id, conversation_id, content, status, create_time&lt;/sql&gt;&lt;select id=&quot;selectLatestNotice&quot; resultType=&quot;Message&quot;&gt;    select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt;    from message    where id in (        select max(id) from message        where status != 2        and from_id = 1        and to_id = #&#123;userId&#125;        and conversation_id = #&#123;topic&#125;    )&lt;/select&gt;&lt;select id=&quot;selectNoticeCount&quot; resultType=&quot;int&quot;&gt;    select count(id) from message    where status != 2    and from_id = 1    and to_id = #&#123;userId&#125;    and conversation_id = #&#123;topic&#125;&lt;/select&gt;&lt;select id=&quot;selectNoticeUnreadCount&quot; resultType=&quot;int&quot;&gt;    select count(id) from message    where status = 0    and from_id = 1    and to_id = #&#123;userId&#125;    &lt;if test=&quot;topic!=null&quot;&gt;        and conversation_id = #&#123;topic&#125;    &lt;/if&gt;&lt;/select&gt;</code></pre><h2 id="æ›´æ–°ä¸šåŠ¡å±‚çš„-MessageService-ç±»"><a href="#æ›´æ–°ä¸šåŠ¡å±‚çš„-MessageService-ç±»" class="headerlink" title="æ›´æ–°ä¸šåŠ¡å±‚çš„ MessageService ç±»"></a>æ›´æ–°ä¸šåŠ¡å±‚çš„ MessageService ç±»</h2><ul><li>æ–°å¢æ–¹æ³• <code>findLatestNotice()</code> ï¼Œè°ƒç”¨æ–¹æ³• <code>selectLatestNotice()</code> æŸ¥è¯¢æœ€æ–°é€šçŸ¥ã€‚</li><li>æ–°å¢æ–¹æ³• <code>findNoticeCount()</code> ï¼Œè°ƒç”¨æ–¹æ³• <code>selectNoticeCount()</code> æŸ¥è¯¢æŸä¸»é¢˜é€šçŸ¥çš„æ•°é‡ã€‚</li><li>æ–°å¢æ–¹æ³• <code>findNoticeUnreadCount()</code> ï¼Œè°ƒç”¨æ–¹æ³• <code>selectNoticeUnreadCount()</code> æŸ¥è¯¢æœªè¯»é€šçŸ¥çš„æ•°é‡ã€‚</li></ul><pre><code class="java">public Message findLatestNotice(int userId, String topic) &#123;    return messageMapper.selectLatestNotice(userId, topic);&#125;public int findNoticeCount(int userId, String topic) &#123;    return messageMapper.selectNoticeCount(userId, topic);&#125;public int findNoticeUnreadCount(int userId, String topic) &#123;    return messageMapper.selectNoticeUnreadCount(userId, topic);&#125;</code></pre><h2 id="æ›´æ–°è¡¨ç°å±‚çš„-MessageController-ç±»"><a href="#æ›´æ–°è¡¨ç°å±‚çš„-MessageController-ç±»" class="headerlink" title="æ›´æ–°è¡¨ç°å±‚çš„ MessageController ç±»"></a>æ›´æ–°è¡¨ç°å±‚çš„ MessageController ç±»</h2><ul><li>æ–°å¢æ–¹æ³• <code>getNoticeList()</code> ï¼šè·å–é€šçŸ¥åˆ—è¡¨ã€‚<ul><li>è°ƒç”¨ä¸šåŠ¡å±‚çš„ MessageService ç±»çš„æ–¹æ³•æŸ¥è¯¢è¯„è®ºã€ç‚¹èµã€å…³æ³¨çš„é€šçŸ¥ï¼Œå°†å…¶å°è£…åœ¨ä¸€ä¸ª HashMap é›†åˆä¸­ç„¶åæ·»åŠ åˆ° Model å¯¹è±¡ä¸­ã€‚</li><li>è°ƒç”¨ä¸šåŠ¡å±‚çš„ MessageService ç±»çš„æ–¹æ³•æŸ¥è¯¢ç§ä¿¡å’Œé€šçŸ¥çš„æ€»æœªè¯»æ•°é‡ï¼Œæ·»åŠ åˆ° Model å¯¹è±¡ä¸­ã€‚</li><li>è¿”å› <code>notice.html</code> é¡µé¢ã€‚</li></ul></li></ul><pre><code class="java">@GetMapping(&quot;/notice/list&quot;)public String getNoticeList(Model model) &#123;    User user = hostHolder.getUser();    // æŸ¥è¯¢è¯„è®ºç±»é€šçŸ¥    Message message = messageService.findLatestNotice(user.getId(), TOPIC_COMMENT);    Map&lt;String, Object&gt; messageVO = new HashMap&lt;&gt;();    if (message != null) &#123;        messageVO.put(&quot;message&quot;, message);        String content = HtmlUtils.htmlUnescape(message.getContent());        Map&lt;String, Object&gt; data = JSONObject.parseObject(content, HashMap.class);        messageVO.put(&quot;user&quot;, userService.findUserById((Integer) data.get(&quot;userId&quot;)));        messageVO.put(&quot;entityType&quot;, data.get(&quot;entityType&quot;));        messageVO.put(&quot;entityId&quot;, data.get(&quot;entityId&quot;));        messageVO.put(&quot;postId&quot;, data.get(&quot;postId&quot;));        int count = messageService.findNoticeCount(user.getId(), TOPIC_COMMENT);        messageVO.put(&quot;count&quot;, count);        int unread = messageService.findNoticeUnreadCount(user.getId(), TOPIC_COMMENT);        messageVO.put(&quot;unread&quot;, unread);    &#125;    model.addAttribute(&quot;commentNotice&quot;, messageVO);    // æŸ¥è¯¢ç‚¹èµç±»é€šçŸ¥    message = messageService.findLatestNotice(user.getId(), TOPIC_LIKE);    messageVO = new HashMap&lt;&gt;();    if (message != null) &#123;        messageVO.put(&quot;message&quot;, message);        String content = HtmlUtils.htmlUnescape(message.getContent());        Map&lt;String, Object&gt; data = JSONObject.parseObject(content, HashMap.class);        messageVO.put(&quot;user&quot;, userService.findUserById((Integer) data.get(&quot;userId&quot;)));        messageVO.put(&quot;entityType&quot;, data.get(&quot;entityType&quot;));        messageVO.put(&quot;entityId&quot;, data.get(&quot;entityId&quot;));        messageVO.put(&quot;postId&quot;, data.get(&quot;postId&quot;));        int count = messageService.findNoticeCount(user.getId(), TOPIC_LIKE);        messageVO.put(&quot;count&quot;, count);        int unread = messageService.findNoticeUnreadCount(user.getId(), TOPIC_LIKE);        messageVO.put(&quot;unread&quot;, unread);    &#125;    model.addAttribute(&quot;likeNotice&quot;, messageVO);    // æŸ¥è¯¢å…³æ³¨ç±»é€šçŸ¥    message = messageService.findLatestNotice(user.getId(), TOPIC_FOLLOW);    messageVO = new HashMap&lt;&gt;();    if (message != null) &#123;        messageVO.put(&quot;message&quot;, message);        String content = HtmlUtils.htmlUnescape(message.getContent());        Map&lt;String, Object&gt; data = JSONObject.parseObject(content, HashMap.class);        messageVO.put(&quot;user&quot;, userService.findUserById((Integer) data.get(&quot;userId&quot;)));        messageVO.put(&quot;entityType&quot;, data.get(&quot;entityType&quot;));        messageVO.put(&quot;entityId&quot;, data.get(&quot;entityId&quot;));        int count = messageService.findNoticeCount(user.getId(), TOPIC_FOLLOW);        messageVO.put(&quot;count&quot;, count);        int unread = messageService.findNoticeUnreadCount(user.getId(), TOPIC_FOLLOW);        messageVO.put(&quot;unread&quot;, unread);    &#125;    model.addAttribute(&quot;followNotice&quot;, messageVO);    // æŸ¥è¯¢ç§ä¿¡çš„æ€»æœªè¯»æ•°    int letterUnreadCount = messageService.findLetterUnreadCount(user.getId(), null);    model.addAttribute(&quot;letterUnreadCount&quot;, letterUnreadCount);      // æŸ¥è¯¢é€šçŸ¥çš„æ€»æœªè¯»æ•°    int noticeUnreadCount = messageService.findNoticeUnreadCount(user.getId(), null);    model.addAttribute(&quot;noticeUnreadCount&quot;, noticeUnreadCount);    return &quot;/site/notice&quot;;&#125;</code></pre><h2 id="å†æ¬¡æ›´æ–°æ¥å£-MessageMapper"><a href="#å†æ¬¡æ›´æ–°æ¥å£-MessageMapper" class="headerlink" title="å†æ¬¡æ›´æ–°æ¥å£ MessageMapper"></a>å†æ¬¡æ›´æ–°æ¥å£ MessageMapper</h2><ul><li>æ–°å¢æ–¹æ³• <code>selectNotices()</code> ï¼šæŸ¥è¯¢æŸä¸ªä¸»é¢˜çš„é€šçŸ¥åˆ—è¡¨ã€‚</li><li>åœ¨ <code>message-mapper.xml</code> æ–‡ä»¶ä¸­é…ç½® SQLã€‚</li></ul><pre><code class="java">// æŸ¥è¯¢æŸä¸ªä¸»é¢˜æ‰€åŒ…å«çš„é€šçŸ¥åˆ—è¡¨List&lt;Message&gt; selectNotices(int userId, String topic, int offset, int limit);</code></pre><pre><code class="xml">&lt;select id=&quot;selectNotices&quot; resultType=&quot;Message&quot;&gt;    select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt;    from message    where status != 2    and from_id = 1    and to_id = #&#123;userId&#125;    and conversation_id = #&#123;topic&#125;    order by create_time desc    limit #&#123;offset&#125;, #&#123;limit&#125;&lt;/select&gt;</code></pre><h2 id="å†æ¬¡æ›´æ–°ä¸šåŠ¡å±‚çš„-MessageService-ç±»"><a href="#å†æ¬¡æ›´æ–°ä¸šåŠ¡å±‚çš„-MessageService-ç±»" class="headerlink" title="å†æ¬¡æ›´æ–°ä¸šåŠ¡å±‚çš„ MessageService ç±»"></a>å†æ¬¡æ›´æ–°ä¸šåŠ¡å±‚çš„ MessageService ç±»</h2><p>æ–°å¢æ–¹æ³• <code>findNotices()</code> ï¼šè°ƒç”¨æ–¹æ³• <code>selectNotices()</code> ã€‚</p><pre><code class="java">public List&lt;Message&gt; findNotices(int userId, String topic, int offset, int limit) &#123;    return messageMapper.selectNotices(userId, topic, offset, limit);&#125;</code></pre><h2 id="å†æ¬¡æ›´æ–°ä¸šåŠ¡å±‚çš„-MessageController-ç±»"><a href="#å†æ¬¡æ›´æ–°ä¸šåŠ¡å±‚çš„-MessageController-ç±»" class="headerlink" title="å†æ¬¡æ›´æ–°ä¸šåŠ¡å±‚çš„ MessageController ç±»"></a>å†æ¬¡æ›´æ–°ä¸šåŠ¡å±‚çš„ MessageController ç±»</h2><ul><li>æ–°å¢æ–¹æ³• <code>getNoticeDetail()</code> ï¼š<ul><li>è°ƒç”¨æ–¹æ³• <code>findNotices()</code> è·å–é€šçŸ¥åˆ—è¡¨è¯¦æƒ…ï¼Œå°è£…åˆ° List é›†åˆå¹¶å­˜å…¥ Model å¯¹è±¡ã€‚</li><li>ä»é€šçŸ¥é›†åˆä¸­è·å– id é›†åˆï¼Œè°ƒç”¨æ–¹æ³• <code>readMessage()</code> å°†æ¶ˆæ¯è®¾ä¸ºå·²è¯»ã€‚</li><li>è¿”å› <code>notice-detail.html</code> é¡µé¢ã€‚</li></ul></li></ul><pre><code class="java">@GetMapping(&quot;/notice/detail/&#123;topic&#125;&quot;)public String getNoticeDetail(@PathVariable(&quot;topic&quot;) String topic, Page page, Model model) &#123;    User user = hostHolder.getUser();    page.setLimit(5);    page.setPath(&quot;/notice/detail/&quot; + topic);    page.setRows(messageService.findNoticeCount(user.getId(), topic));    List&lt;Message&gt; noticeList = messageService.findNotices(user.getId(), topic, page.getOffset(), page.getLimit());    List&lt;Map&lt;String, Object&gt;&gt; noticeVoList = new ArrayList&lt;&gt;();    if (noticeList != null) &#123;        for (Message notice : noticeList) &#123;            Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();            // é€šçŸ¥            map.put(&quot;notice&quot;, notice);            // å†…å®¹            String content = HtmlUtils.htmlUnescape(notice.getContent());            Map&lt;String, Object&gt; data = JSONObject.parseObject(content, HashMap.class);            map.put(&quot;user&quot;, userService.findUserById((Integer) data.get(&quot;userId&quot;)));            map.put(&quot;entityType&quot;, data.get(&quot;entityType&quot;));            map.put(&quot;entityId&quot;, data.get(&quot;entityId&quot;));            map.put(&quot;postId&quot;, data.get(&quot;postId&quot;));            // é€šçŸ¥ä½œè€…            map.put(&quot;fromUser&quot;, userService.findUserById(notice.getFromId()));            noticeVoList.add(map);        &#125;    &#125;    model.addAttribute(&quot;notices&quot;, noticeVoList);    // è®¾ç½®å·²è¯»    List&lt;Integer&gt; ids = getLetterIds(noticeList);    if (!ids.isEmpty()) &#123;        messageService.readMessage(ids);    &#125;    return &quot;/site/notice-detail&quot;;&#125;</code></pre><h2 id="åˆ›å»ºè¡¨ç°å±‚çš„æ‹¦æˆªå™¨-MessageInterceptor-ç±»"><a href="#åˆ›å»ºè¡¨ç°å±‚çš„æ‹¦æˆªå™¨-MessageInterceptor-ç±»" class="headerlink" title="åˆ›å»ºè¡¨ç°å±‚çš„æ‹¦æˆªå™¨ MessageInterceptor ç±»"></a>åˆ›å»ºè¡¨ç°å±‚çš„æ‹¦æˆªå™¨ MessageInterceptor ç±»</h2><ul><li>æ³¨å…¥ MessageService å®ä¾‹å’Œ HostHolder å®ä¾‹ã€‚</li><li>é‡å†™æ–¹æ³• <code>postHandle()</code> ï¼ŒæŸ¥è¯¢ç§ä¿¡å’Œé€šçŸ¥çš„æœªè¯»æ•°é‡å’Œï¼Œç„¶åæ·»åŠ åˆ° ModelAndView å¯¹è±¡ã€‚</li></ul><pre><code class="java">@Componentpublic class MessageInterceptor implements HandlerInterceptor &#123;    @Autowired    private HostHolder hostHolder;    @Autowired    private MessageService messageService;    @Override    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception &#123;        User user = hostHolder.getUser();        if (user != null &amp;&amp; modelAndView != null) &#123;            int letterUnreadCount = messageService.findLetterUnreadCount(user.getId(), null);            int noticeUnreadCount = messageService.findNoticeUnreadCount(user.getId(), null);            modelAndView.addObject(&quot;allUnreadCount&quot;, letterUnreadCount + noticeUnreadCount);        &#125;    &#125;&#125;</code></pre><h2 id="æ›´æ–°é…ç½®ç±»-WebConfig"><a href="#æ›´æ–°é…ç½®ç±»-WebConfig" class="headerlink" title="æ›´æ–°é…ç½®ç±» WebConfig"></a>æ›´æ–°é…ç½®ç±» WebConfig</h2><ul><li>æ³¨å…¥ MessageInterceptor å®ä¾‹ã€‚</li><li>åœ¨æ–¹æ³• <code>addInterceptors()</code> ä¸­æ·»åŠ æ‹¦æˆªå™¨ MessageInterceptor å®ä¾‹ã€‚</li></ul><pre><code class="java">@Overridepublic void addInterceptors(InterceptorRegistry registry) &#123;    registry.addInterceptor(alphaInterceptor)            .excludePathPatterns(&quot;/**/*.css&quot;, &quot;/**/*.js&quot;, &quot;/**/*.png&quot;, &quot;/**/*.jpg&quot;, &quot;/**/*.jpeg&quot;)            .addPathPatterns(&quot;/register&quot;, &quot;/login&quot;);    registry.addInterceptor(loginTicketInterceptor)            .excludePathPatterns(&quot;/**/*.css&quot;, &quot;/**/*.js&quot;, &quot;/**/*.png&quot;, &quot;/**/*.jpg&quot;, &quot;/**/*.jpeg&quot;);    registry.addInterceptor(loginRequiredInterceptor)            .excludePathPatterns(&quot;/**/*.css&quot;, &quot;/**/*.js&quot;, &quot;/**/*.png&quot;, &quot;/**/*.jpg&quot;, &quot;/**/*.jpeg&quot;);    registry.addInterceptor(messageInterceptor)            .excludePathPatterns(&quot;/**/*.css&quot;, &quot;/**/*.js&quot;, &quot;/**/*.png&quot;, &quot;/**/*.jpg&quot;, &quot;/**/*.jpeg&quot;);&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Spring Boot </tag>
            
            <tag> Kafka </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ ¡å›­ç¤¾åŒºè®ºå›é¡¹ç›®ä¹‹ Redis</title>
      <link href="/2023/03/07/community4/"/>
      <url>/2023/03/07/community4/</url>
      
        <content type="html"><![CDATA[<p>ğŸŒŸ æœ¬å¸–è®°å½• Spring Boot æ•´åˆ Redis å®ç°æ ¡å›­ç¤¾åŒºè®ºå›é¡¹ç›®çš„ç‚¹èµã€å…³æ³¨åŠŸèƒ½ï¼ŒåŒæ—¶ä¼˜åŒ–äº†ç™»å½•æ¨¡å—ä¸­çš„éªŒè¯ç å­˜å‚¨ã€ç™»å½•å‡­è¯å­˜å‚¨ã€ç”¨æˆ·ä¿¡æ¯ç¼“å­˜åŠŸèƒ½ã€‚</p><p>ğŸŒŸ å‡†å¤‡å·¥ä½œï¼š</p><ol><li>å¼•å…¥ Redis ä¾èµ–åˆ° pom.xml æ–‡ä»¶ä¸­ï¼š</li></ol><pre><code class="xml">&lt;dependency&gt;    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;    &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;&lt;/dependency&gt;</code></pre><ol start="2"><li>åœ¨ application.properties æ–‡ä»¶ä¸­é…ç½® Redisï¼š</li></ol><pre><code class="properties"># RedisPropertiesspring.redis.database=11spring.redis.host=localhostspring.redis.port=6379</code></pre><ol start="3"><li>ç¼–å†™é…ç½®ç±» RedisConfigï¼š</li></ol><pre><code class="java">@Configurationpublic class RedisConfig &#123;    @Bean    public RedisTemplate&lt;String, Object&gt; redisTemplate(RedisConnectionFactory factory) &#123;        RedisTemplate&lt;String, Object&gt; template = new RedisTemplate&lt;&gt;();        template.setConnectionFactory(factory);        // è®¾ç½® key çš„åºåˆ—åŒ–æ–¹å¼        template.setKeySerializer(RedisSerializer.string());        // è®¾ç½® value çš„åºåˆ—åŒ–æ–¹å¼        template.setValueSerializer(RedisSerializer.json());        // è®¾ç½® hash çš„ key çš„åºåˆ—åŒ–æ–¹å¼        template.setHashKeySerializer(RedisSerializer.string());        // è®¾ç½® hash çš„ value çš„åºåˆ—åŒ–æ–¹å¼        template.setHashValueSerializer(RedisSerializer.json());        template.afterPropertiesSet();        return template;    &#125;&#125;</code></pre><h1 id="1-ç‚¹èµ"><a href="#1-ç‚¹èµ" class="headerlink" title="1. ç‚¹èµ"></a>1. ç‚¹èµ</h1><p>ç‚¹èµæ¨¡å—åŒ…å«ï¼š</p><ol><li>ç‚¹èµï¼š(1)æ”¯æŒå¯¹å¸–å­ã€è¯„è®ºè¿›è¡Œç‚¹èµï¼›(2)ç¬¬ä¸€æ¬¡ç‚¹å‡»â€œèµâ€å®Œæˆç‚¹èµæ“ä½œï¼Œç¬¬äºŒæ¬¡ç‚¹å‡»â€œå·²èµâ€å®Œæˆå–æ¶ˆç‚¹èµæ“ä½œã€‚</li><li>é¦–é¡µï¼šç»Ÿè®¡å¸–å­çš„ç‚¹èµæ•°ã€‚</li><li>è¯¦æƒ…é¡µï¼š(1)ç»Ÿè®¡å¸–å­çš„ç‚¹èµæ•°ï¼›(2)æ˜¾ç¤ºç‚¹èµçŠ¶æ€ã€‚</li></ol><h2 id="åˆ›å»ºå·¥å…·ç±»-RedisKeyUtil"><a href="#åˆ›å»ºå·¥å…·ç±»-RedisKeyUtil" class="headerlink" title="åˆ›å»ºå·¥å…·ç±» RedisKeyUtil"></a>åˆ›å»ºå·¥å…·ç±» RedisKeyUtil</h2><ul><li>å®šä¹‰åˆ†éš”ç¬¦ <code>:</code></li><li>å®šä¹‰å®ä½“è·å¾—èµçš„ key å‰ç¼€å¸¸é‡  <code>like:entity</code></li><li>æ–°å¢æ–¹æ³• <code>getEntityLikeKey(int entityType, int entityId)</code>ï¼Œé€šè¿‡å®ä½“ç±»å‹å’Œå®ä½“ id ç”Ÿæˆå¯¹åº”å®ä½“è·å¾—èµçš„ keyï¼Œè¿™ä¸ª key çš„å‘ˆç°å½¢å¼ä¸º <code>like:entity:entityType:entityId</code>ã€‚</li></ul><pre><code class="jade">public class RedisKeyUtil &#123;    private static final String SPLIT = &quot;:&quot;;    private static final String PREFIX_ENTITY_LIKE = &quot;like:entity&quot;;    // æŸä¸ªå®ä½“çš„èµ    // like:entity:entityType:entityId -&gt; set(userId)    public static String getEntityLikeKey(int entityType, int entityId) &#123;        return PREFIX_ENTITY_LIKE + SPLIT + entityType + SPLIT + entityId;    &#125;&#125;</code></pre><h2 id="åˆ›å»ºä¸šåŠ¡å±‚çš„-LikeService-ç±»"><a href="#åˆ›å»ºä¸šåŠ¡å±‚çš„-LikeService-ç±»" class="headerlink" title="åˆ›å»ºä¸šåŠ¡å±‚çš„ LikeService ç±»"></a>åˆ›å»ºä¸šåŠ¡å±‚çš„ LikeService ç±»</h2><ul><li>æ³¨å…¥ <code>RedisTemplate</code> å®ä¾‹</li><li>æ–°å¢æ–¹æ³• <code>like()</code> å®ç°ç‚¹èµåŠŸèƒ½ï¼š<ul><li>é¦–å…ˆï¼Œè°ƒç”¨å·¥å…·ç±» <code>RedisKeyUtil</code> ä¸­çš„æ–¹æ³• <code>getEntityLikeKey()</code> è·å¾—å®ä½“ç‚¹èµçš„ keyï¼›</li><li>ç„¶åï¼Œé€šè¿‡ <code>RedisTemplate</code> çš„å¯¹è±¡ï¼Œè°ƒç”¨ set é›†åˆçš„æ–¹æ³• <code>isMember()</code> æŸ¥è¯¢ userId æ˜¯å¦å­˜åœ¨äºå¯¹åº” key çš„ set é›†åˆä¸­ï¼Œå¦‚æœå­˜åœ¨åˆ™ç§»å‡ºç‚¹èµçš„ç”¨æˆ·é›†åˆï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ·»åŠ åˆ°ç‚¹èµçš„ç”¨æˆ·é›†åˆä¸­ã€‚</li></ul></li><li>æ–°å¢æ–¹æ³• <code>findEntityLikeCount()</code>ï¼šæŸ¥è¯¢æŸå®ä½“çš„ç‚¹èµæ•°ï¼Œé€šè¿‡è°ƒç”¨ set é›†åˆçš„æ–¹æ³•<code>size()</code>æŸ¥è¯¢å…ƒç´ çš„ä¸ªæ•°ã€‚</li><li>æ–°å¢æ–¹æ³• <code>findEntityLikeStatus()</code>ï¼šæŸ¥è¯¢æŸç”¨æˆ·å¯¹æŸå®ä½“çš„ç‚¹èµçŠ¶æ€ï¼Œé€»è¾‘å®ç°åŒæ–¹æ³•<code>like()</code>ï¼Œå³é€šè¿‡è°ƒç”¨ set é›†åˆçš„æ–¹æ³• <code>isMember()</code> å®ç°ã€‚</li></ul><pre><code class="java">@Servicepublic class LikeService &#123;    @Autowired    private RedisTemplate redisTemplate;    // ç‚¹èµ    public void like(int userId, int entityType, int entityId) &#123;        String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);        boolean isMember = redisTemplate.opsForSet().isMember(entityLikeKey, userId);      // åˆ¤æ–­æ˜¯å¦ç‚¹è¿‡èµ        if (isMember) &#123;            redisTemplate.opsForSet().remove(entityLikeKey, userId);        &#125; else &#123;            redisTemplate.opsForSet().add(entityLikeKey, userId);        &#125;    &#125;    // æŸ¥è¯¢æŸå®ä½“ç‚¹èµçš„æ•°é‡    public long findEntityLikeCount(int entityType, int entityId) &#123;        String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);        return redisTemplate.opsForSet().size(entityLikeKey);    &#125;    // æŸ¥è¯¢æŸäººå¯¹æŸå®ä½“çš„ç‚¹èµçŠ¶æ€    public int findEntityLikeStatus(int userId, int entityType, int entityId) &#123;        String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);          // 1 è¡¨ç¤ºå·²èµï¼›0è¡¨ç¤ºæœªèµ        return redisTemplate.opsForSet().isMember(entityLikeKey, userId) ? 1 : 0;    &#125;&#125;</code></pre><h2 id="åˆ›å»ºè¡¨ç°å±‚çš„-LikeController-ç±»"><a href="#åˆ›å»ºè¡¨ç°å±‚çš„-LikeController-ç±»" class="headerlink" title="åˆ›å»ºè¡¨ç°å±‚çš„ LikeController ç±»"></a>åˆ›å»ºè¡¨ç°å±‚çš„ LikeController ç±»</h2><ul><li>æ³¨å…¥ <code>LikeService</code> å’Œ <code>HostHolder</code> å®ä¾‹</li><li>æ–°å¢æ–¹æ³• <code>like()</code>ï¼šå®ç°ç‚¹èµåŠŸèƒ½ï¼Œè°ƒç”¨ä¸šåŠ¡å±‚çš„æ–¹æ³• <code>like()</code> è¿›è¡Œç‚¹èµï¼Œè°ƒç”¨ <code>findEntityLikeCount()</code> å’Œ <code>findEntityLikeStatus()</code> æŸ¥è¯¢ç‚¹èµæ•°å’Œç‚¹èµçŠ¶æ€ï¼Œå¹¶å°è£…åˆ° map é›†åˆä¸­ï¼Œç„¶åé€šè¿‡å·¥å…·ç±»å°è£…æˆ JSON æ•°æ®è¿”å›ã€‚</li></ul><pre><code class="java">@Controllerpublic class LikeController &#123;    @Autowired    private LikeService likeService;    @Autowired    private HostHolder hostHolder;    @PostMapping(&quot;/like&quot;)    @ResponseBody    public String like(int entityType, int entityId) &#123;        User user = hostHolder.getUser();        // ç‚¹èµ        likeService.like(user.getId(), entityType, entityId);        // æ•°é‡        long likeCount = likeService.findEntityLikeCount(entityType, entityId);        // çŠ¶æ€        int likeStatus = likeService.findEntityLikeStatus(user.getId(), entityType, entityId);        // è¿”å›çš„ç»“æœ        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();        map.put(&quot;likeCount&quot;, likeCount);        map.put(&quot;likeStatus&quot;, likeStatus);        return CommunityUtil.getJSONString(0, null, map);    &#125;&#125;</code></pre><h2 id="æ›´æ–°è¡¨ç°å±‚çš„-HomeController-ç±»"><a href="#æ›´æ–°è¡¨ç°å±‚çš„-HomeController-ç±»" class="headerlink" title="æ›´æ–°è¡¨ç°å±‚çš„ HomeController ç±»"></a>æ›´æ–°è¡¨ç°å±‚çš„ HomeController ç±»</h2><ul><li><p>æ³¨å…¥  <code>LikeService</code> å®ä¾‹</p></li><li><p>æ›´æ–°æ–¹æ³•  <code>getIndexPage()</code>ï¼šæ–°å¢æ›´æ–°é¦–é¡µå¸–å­ç‚¹èµæ•°åŠŸèƒ½ï¼Œè°ƒç”¨ä¸šåŠ¡å±‚çš„ <code>LikeService</code> ç±»çš„æ–¹æ³•è·å¾—ç‚¹èµæ•°ï¼Œå¹¶å­˜å‚¨åˆ° map é›†åˆä¸­ã€‚</p></li></ul><pre><code class="java">@GetMapping(&quot;/index&quot;)public String getIndexPage(Model model, Page page) &#123;    // æ–¹æ³•è°ƒç”¨ä¹‹å‰ï¼ŒSpringMVC ä¼šè‡ªåŠ¨å®ä¾‹åŒ– Model å’Œ Pageï¼Œå¹¶å°† Page æ³¨å…¥åˆ° Modelä¸­ã€‚    // æ‰€ä»¥ï¼Œåœ¨ thymeleaf ä¸­å¯ä»¥ç›´æ¥è®¿é—® Page å¯¹è±¡ä¸­çš„æ•°æ®.    page.setRows(discussPostService.findDiscussPostRows(0));    page.setPath(&quot;/index&quot;);    List&lt;DiscussPost&gt; list = discussPostService.findDiscussPosts(0, page.getOffset(), page.getLimit());    List&lt;Map&lt;String, Object&gt;&gt; discussPosts = new ArrayList&lt;&gt;();    if (list != null) &#123;        for (DiscussPost post : list) &#123;            Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();            map.put(&quot;post&quot;, post);            User user = userService.findUserById(post.getUserId());            map.put(&quot;user&quot;, user);            long likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_POST, post.getId());            map.put(&quot;likeCount&quot;, likeCount);            discussPosts.add(map);        &#125;    &#125;    model.addAttribute(&quot;discussPosts&quot;, discussPosts);    return &quot;/index&quot;;&#125;</code></pre><h2 id="æ›´æ–°è¡¨ç°å±‚çš„-DiscussPostController-ç±»"><a href="#æ›´æ–°è¡¨ç°å±‚çš„-DiscussPostController-ç±»" class="headerlink" title="æ›´æ–°è¡¨ç°å±‚çš„ DiscussPostController ç±»"></a>æ›´æ–°è¡¨ç°å±‚çš„ DiscussPostController ç±»</h2><ul><li>æ³¨å…¥  <code>LikeService</code> å®ä¾‹</li><li>æ›´æ–°æ–¹æ³• <code>addDiscussPost()</code>ï¼šæ–°å¢æ›´æ–°è¯¦æƒ…é¡µå¸–å­ï¼ˆè¯„è®ºã€å›å¤ï¼‰çš„ç‚¹èµæ•°åŠŸèƒ½ï¼Œè°ƒç”¨ä¸šåŠ¡å±‚çš„ <code>LikeService</code> ç±»çš„æ–¹æ³•è·å¾—ç‚¹èµæ•°å’Œç‚¹èµçŠ¶æ€ï¼Œå¹¶å°†å…¶å­˜å…¥è§†å›¾å¯¹è±¡ä¸­ã€‚</li></ul><pre><code class="java">@GetMapping(&quot;/detail/&#123;discussPostId&#125;&quot;)public String getDiscussPost(@PathVariable(&quot;discussPostId&quot;) int discussPostId, Model model, Page page) &#123;    // å¸–å­    DiscussPost post = discussPostService.findDiscussPostById(discussPostId);    model.addAttribute(&quot;post&quot;, post);    // ä½œè€…    User user = userService.findUserById(post.getUserId());    model.addAttribute(&quot;user&quot;, user);    // ç‚¹èµæ•°é‡    long likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_POST, discussPostId);    model.addAttribute(&quot;likeCount&quot;, likeCount);    // ç‚¹èµçŠ¶æ€    int likeStatus = hostHolder.getUser() == null ? 0 :            likeService.findEntityLikeStatus(hostHolder.getUser().getId(), ENTITY_TYPE_POST, discussPostId);    model.addAttribute(&quot;likeStatus&quot;, likeStatus);    // è¯„è®ºåˆ†é¡µä¿¡æ¯    page.setLimit(5);    page.setPath(&quot;/discuss/detail/&quot; + discussPostId);    page.setRows(post.getCommentCount());    // è¯„è®º: ç»™å¸–å­çš„è¯„è®º    // å›å¤: ç»™è¯„è®ºçš„è¯„è®º    // è¯„è®ºåˆ—è¡¨    List&lt;Comment&gt; commentList = commentService.findCommentsByEntity(            ENTITY_TYPE_POST, post.getId(), page.getOffset(), page.getLimit());    // è¯„è®ºVOåˆ—è¡¨    List&lt;Map&lt;String, Object&gt;&gt; commentVoList = new ArrayList&lt;&gt;();    if (commentList != null) &#123;        for (Comment comment : commentList) &#123;            // è¯„è®ºVO            Map&lt;String, Object&gt; commentVo = new HashMap&lt;&gt;();            // è¯„è®º            commentVo.put(&quot;comment&quot;, comment);            // ä½œè€…            commentVo.put(&quot;user&quot;, userService.findUserById(comment.getUserId()));            // ç‚¹èµæ•°é‡            likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_COMMENT, comment.getId());            commentVo.put(&quot;likeCount&quot;, likeCount);            // ç‚¹èµçŠ¶æ€            likeStatus = hostHolder.getUser() == null ? 0 :                    likeService.findEntityLikeStatus(hostHolder.getUser().getId(), ENTITY_TYPE_COMMENT, comment.getId());            commentVo.put(&quot;likeStatus&quot;, likeStatus);            // å›å¤åˆ—è¡¨            List&lt;Comment&gt; replyList = commentService.findCommentsByEntity(                    ENTITY_TYPE_COMMENT, comment.getId(), 0, Integer.MAX_VALUE);            // å›å¤VOåˆ—è¡¨            List&lt;Map&lt;String, Object&gt;&gt; replyVoList = new ArrayList&lt;&gt;();            if (replyList != null) &#123;                for (Comment reply : replyList) &#123;                    Map&lt;String, Object&gt; replyVo = new HashMap&lt;&gt;();                    // å›å¤                    replyVo.put(&quot;reply&quot;, reply);                    // ä½œè€…                    replyVo.put(&quot;user&quot;, userService.findUserById(reply.getUserId()));                    // å›å¤ç›®æ ‡                    User target = reply.getTargetId() == 0 ? null : userService.findUserById(reply.getTargetId());                    replyVo.put(&quot;target&quot;, target);                    // ç‚¹èµæ•°é‡                    likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_COMMENT, reply.getId());                    replyVo.put(&quot;likeCount&quot;, likeCount);                    // ç‚¹èµçŠ¶æ€                    likeStatus = hostHolder.getUser() == null ? 0 :                            likeService.findEntityLikeStatus(hostHolder.getUser().getId(), ENTITY_TYPE_COMMENT, reply.getId());                    replyVo.put(&quot;likeStatus&quot;, likeStatus);                    replyVoList.add(replyVo);                &#125;            &#125;            commentVo.put(&quot;replys&quot;, replyVoList);            // å›å¤æ•°é‡            int replyCount = commentService.findCommentCount(ENTITY_TYPE_COMMENT, comment.getId());            commentVo.put(&quot;replyCount&quot;, replyCount);            commentVoList.add(commentVo);        &#125;    &#125;    model.addAttribute(&quot;comments&quot;, commentVoList);    return &quot;/site/discuss-detail&quot;;&#125;</code></pre><h1 id="2-æ”¶åˆ°çš„èµ"><a href="#2-æ”¶åˆ°çš„èµ" class="headerlink" title="2. æ”¶åˆ°çš„èµ"></a>2. æ”¶åˆ°çš„èµ</h1><ol><li>é‡æ„ç‚¹èµåŠŸèƒ½ï¼šä»¥ç”¨æˆ·ä¸º keyï¼Œè®°å½•ç‚¹èµæ•°é‡ï¼›<code>increment(key)</code>ã€<code>decrement(key)</code></li><li>å¼€å‘ä¸ªäººä¸»é¡µï¼šä»¥ç”¨æˆ·ä¸º keyï¼ŒæŸ¥è¯¢ç‚¹èµæ•°ã€‚</li></ol><h2 id="æ›´æ–°å·¥å…·ç±»-RedisUtil"><a href="#æ›´æ–°å·¥å…·ç±»-RedisUtil" class="headerlink" title="æ›´æ–°å·¥å…·ç±» RedisUtil"></a>æ›´æ–°å·¥å…·ç±» RedisUtil</h2><ul><li><p>æ–°å¢ç”¨æˆ·è·å¾—èµ key çš„å‰ç¼€å¸¸é‡ <code>like:user</code></p></li><li><p>æ–°å¢æ–¹æ³• <code>getUserLikeKey(int userId)</code>ï¼Œé€šè¿‡ç”¨æˆ· id ç”Ÿæˆå¯¹åº”ç”¨æˆ·è·å¾—èµçš„ keyã€‚</p></li></ul><pre><code class="java">public class RedisKeyUtil &#123;    private static final String SPLIT = &quot;:&quot;;    private static final String PREFIX_ENTITY_LIKE = &quot;like:entity&quot;;    private static final String PREFIX_USER_LIKE = &quot;like:user&quot;;    // æŸä¸ªå®ä½“çš„èµ    // like:entity:entityType:entityId -&gt; set(userId)    public static String getEntityLikeKey(int entityType, int entityId) &#123;        return PREFIX_ENTITY_LIKE + SPLIT + entityType + SPLIT + entityId;    &#125;    // æŸä¸ªç”¨æˆ·çš„èµ    // like:user:userId -&gt; int    public static String getUserLikeKey(int userId) &#123;        return PREFIX_USER_LIKE + SPLIT + userId;    &#125;&#125;</code></pre><h2 id="æ›´æ–°ä¸šåŠ¡å±‚çš„-LikeServiceç±»"><a href="#æ›´æ–°ä¸šåŠ¡å±‚çš„-LikeServiceç±»" class="headerlink" title="æ›´æ–°ä¸šåŠ¡å±‚çš„ LikeServiceç±»"></a>æ›´æ–°ä¸šåŠ¡å±‚çš„ LikeServiceç±»</h2><ul><li>é‡æ„æ–¹æ³• <code>like()</code>ï¼Œåœ¨å‚æ•°åˆ—è¡¨ä¸­æ–°å¢ï¼šentityUserIdï¼ˆè¡¨ç¤ºè¢«ç‚¹èµç”¨æˆ·çš„ idï¼‰ï¼Œè¯¥å‚æ•°ç”¨æ¥æ›´æ–°ç”¨æˆ·çš„è¢«ç‚¹èµæ•°é‡ã€‚<ul><li>è°ƒç”¨ <code>RedisTemplate</code> çš„å¯¹è±¡çš„æ–¹æ³• <code>execute()</code> å®ç°äº‹åŠ¡ï¼Œä¿è¯è¢«ç‚¹èµç”¨æˆ·ä¸ç‚¹èµç”¨æˆ·çš„æ•°æ®æ›´æ–°ä¿æŒä¸€è‡´ã€‚è°ƒç”¨ <code>isMember()</code> æŸ¥è¯¢ç”¨æˆ·çš„ç‚¹èµçŠ¶æ€ï¼Œä¹‹åè°ƒç”¨ <code>multi()</code> å¼€å¯äº‹åŠ¡ã€‚</li><li>å½“ç”¨æˆ·å·²ç‚¹èµæ—¶ï¼Œè°ƒç”¨æ–¹æ³• <code>remove()</code> å°†å½“å‰ç”¨æˆ·ä»ç‚¹èµçš„ç”¨æˆ·é›†åˆä¸­ç§»é™¤ï¼Œè°ƒç”¨æ–¹æ³• <code>decrement()</code> å°†è¢«ç‚¹èµç”¨æˆ·çš„è¢«ç‚¹èµæ•°å‡å» 1ï¼›å½“ç”¨æˆ·æœªç‚¹èµæ—¶ï¼Œè°ƒç”¨æ–¹æ³• <code>add()</code> å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ°ç‚¹èµçš„ç”¨æˆ·é›†åˆä¸­ï¼Œè°ƒç”¨æ–¹æ³• <code>increment()</code> å°†è¢«ç‚¹èµç”¨æˆ·çš„ç‚¹èµæ•°åŠ ä¸Š 1ã€‚</li></ul></li><li>æ–°å¢æ–¹æ³• <code>findUserLikeCount()</code>ï¼Œä»¥ç”¨æˆ· id ä¸º keyï¼Œè°ƒç”¨æ–¹æ³• <code>get()</code> æŸ¥è¯¢ç”¨æˆ·æ‰€è·ç‚¹èµæ•°ã€‚</li></ul><pre><code class="java">@Servicepublic class LikeService &#123;    @Autowired    private RedisTemplate redisTemplate;    // ç‚¹èµ    public void like(int userId, int entityType, int entityId, int entityUserId) &#123;        redisTemplate.execute(new SessionCallback() &#123;            @Override            public Object execute(RedisOperations operations) throws DataAccessException &#123;                String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);                String userLikeKey = RedisKeyUtil.getUserLikeKey(entityUserId);                boolean isMember = operations.opsForSet().isMember(entityLikeKey, userId);                operations.multi();                if (isMember) &#123;                    operations.opsForSet().remove(entityLikeKey, userId);                    operations.opsForValue().decrement(userLikeKey);                &#125; else &#123;                    operations.opsForSet().add(entityLikeKey, userId);                    operations.opsForValue().increment(userLikeKey);                &#125;                return operations.exec();            &#125;        &#125;);    &#125;    // æŸ¥è¯¢æŸå®ä½“ç‚¹èµçš„æ•°é‡    public long findEntityLikeCount(int entityType, int entityId) &#123;        String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);        return redisTemplate.opsForSet().size(entityLikeKey);    &#125;    // æŸ¥è¯¢æŸäººå¯¹æŸå®ä½“çš„ç‚¹èµçŠ¶æ€    public int findEntityLikeStatus(int userId, int entityType, int entityId) &#123;        String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);        return redisTemplate.opsForSet().isMember(entityLikeKey, userId) ? 1 : 0;    &#125;    // æŸ¥è¯¢æŸä¸ªç”¨æˆ·è·å¾—çš„èµ    public int findUserLikeCount(int userId) &#123;        String userLikeKey = RedisKeyUtil.getUserLikeKey(userId);        Integer count = (Integer) redisTemplate.opsForValue().get(userLikeKey);        return count == null ? 0 : count.intValue();    &#125;&#125;</code></pre><h2 id="æ›´æ–°è¡¨ç°å±‚çš„-LikeController-ç±»"><a href="#æ›´æ–°è¡¨ç°å±‚çš„-LikeController-ç±»" class="headerlink" title="æ›´æ–°è¡¨ç°å±‚çš„ LikeController ç±»"></a>æ›´æ–°è¡¨ç°å±‚çš„ LikeController ç±»</h2><ul><li>æ›´æ–°æ–¹æ³• <code>like()</code>ï¼šåœ¨å‚æ•°åˆ—è¡¨ä¸­æ–°å¢å‚æ•° entityUserIdï¼ˆè¡¨ç¤ºè¢«ç‚¹èµç”¨æˆ·çš„ idï¼‰ã€‚</li></ul><pre><code class="java">@Controllerpublic class LikeController &#123;    @Autowired    private LikeService likeService;    @Autowired    private HostHolder hostHolder;    @PostMapping(&quot;/like&quot;)    @ResponseBody    public String like(int entityType, int entityId, int entityUserId) &#123;        User user = hostHolder.getUser();        // ç‚¹èµ        likeService.like(user.getId(), entityType, entityId, entityUserId);        // æ•°é‡        long likeCount = likeService.findEntityLikeCount(entityType, entityId);        // çŠ¶æ€        int likeStatus = likeService.findEntityLikeStatus(user.getId(), entityType, entityId);        // è¿”å›çš„ç»“æœ        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();        map.put(&quot;likeCount&quot;, likeCount);        map.put(&quot;likeStatus&quot;, likeStatus);        return CommunityUtil.getJSONString(0, null, map);    &#125;&#125;</code></pre><h2 id="æ›´æ–°è¡¨ç°å±‚çš„-UserController-ç±»"><a href="#æ›´æ–°è¡¨ç°å±‚çš„-UserController-ç±»" class="headerlink" title="æ›´æ–°è¡¨ç°å±‚çš„ UserController ç±»"></a>æ›´æ–°è¡¨ç°å±‚çš„ UserController ç±»</h2><ul><li>æ–°å¢æ–¹æ³•<code>getProfilePage()</code>ï¼šè°ƒç”¨ä¸šåŠ¡å±‚çš„æ–¹æ³•æŸ¥è¯¢ç”¨æˆ·å’Œç‚¹èµæ•°ï¼Œå¹¶å°†ä¸¤é¡¹ä¿¡æ¯å­˜å‚¨äº Model å¯¹è±¡ä¸­ã€‚</li></ul><pre><code class="java">// ä¸ªäººä¸»é¡µ@RequestMapping(path = &quot;/profile/&#123;userId&#125;&quot;, method = RequestMethod.GET)public String getProfilePage(@PathVariable(&quot;userId&quot;) int userId, Model model) &#123;    User user = userService.findUserById(userId);    if (user == null) &#123;        throw new RuntimeException(&quot;è¯¥ç”¨æˆ·ä¸å­˜åœ¨!&quot;);    &#125;    // ç”¨æˆ·    model.addAttribute(&quot;user&quot;, user);    // ç‚¹èµæ•°é‡    int likeCount = likeService.findUserLikeCount(userId);    model.addAttribute(&quot;likeCount&quot;, likeCount);    return &quot;/site/profile&quot;;&#125;</code></pre><h1 id="3-å…³æ³¨"><a href="#3-å…³æ³¨" class="headerlink" title="3. å…³æ³¨"></a>3. å…³æ³¨</h1><h2 id="æ›´æ–°å·¥å…·ç±»-RedisUtil-1"><a href="#æ›´æ–°å·¥å…·ç±»-RedisUtil-1" class="headerlink" title="æ›´æ–°å·¥å…·ç±» RedisUtil"></a>æ›´æ–°å·¥å…·ç±» RedisUtil</h2><ul><li>æ–°å¢ç”¨æˆ·å…³æ³¨å®ä½“ï¼ˆå¸–å­ã€è¯„è®ºã€ç”¨æˆ·ç­‰ï¼‰çš„å‰ç¼€å¸¸é‡ followee å’Œç²‰ä¸ï¼ˆç”¨æˆ·ï¼‰çš„å‰ç¼€å¸¸é‡ followerã€‚</li><li>æ–°å¢æ–¹æ³• <code>getFolloweeKey(int userId, int entityType)</code>ï¼Œé€šè¿‡ç”¨æˆ· id å’Œå®ä½“ç±»å‹ç”Ÿæˆç”¨æˆ·å…³æ³¨å®ä½“çš„ keyã€‚</li><li>æ–°å¢æ–¹æ³• <code>getFollowerKey(int entityType, int entityId)</code>ï¼Œé€šè¿‡å®ä½“ç±»å‹å’Œå®ä½“ id ç”Ÿæˆå®ä½“ç”¨æˆ·ç²‰ä¸çš„ keyã€‚</li></ul><pre><code class="java">public class RedisKeyUtil &#123;    private static final String SPLIT = &quot;:&quot;;    private static final String PREFIX_ENTITY_LIKE = &quot;like:entity&quot;;    private static final String PREFIX_USER_LIKE = &quot;like:user&quot;;    private static final String PREFIX_FOLLOWEE = &quot;followee&quot;;    private static final String PREFIX_FOLLOWER = &quot;follower&quot;;    // æŸä¸ªå®ä½“çš„èµ    // like:entity:entityType:entityId -&gt; set(userId)    public static String getEntityLikeKey(int entityType, int entityId) &#123;        return PREFIX_ENTITY_LIKE + SPLIT + entityType + SPLIT + entityId;    &#125;    // æŸä¸ªç”¨æˆ·çš„èµ    // like:user:userId -&gt; int    public static String getUserLikeKey(int userId) &#123;        return PREFIX_USER_LIKE + SPLIT + userId;    &#125;    // æŸä¸ªç”¨æˆ·å…³æ³¨çš„å®ä½“    // followee:userId:entityType -&gt; zset(entityId,now)    public static String getFolloweeKey(int userId, int entityType) &#123;        return PREFIX_FOLLOWEE + SPLIT + userId + SPLIT + entityType;    &#125;    // æŸä¸ªå®ä½“æ‹¥æœ‰çš„ç²‰ä¸    // follower:entityType:entityId -&gt; zset(userId,now)    public static String getFollowerKey(int entityType, int entityId) &#123;        return PREFIX_FOLLOWER + SPLIT + entityType + SPLIT + entityId;    &#125;&#125;</code></pre><h2 id="åˆ›å»ºä¸šåŠ¡å±‚çš„-FollowService-ç±»"><a href="#åˆ›å»ºä¸šåŠ¡å±‚çš„-FollowService-ç±»" class="headerlink" title="åˆ›å»ºä¸šåŠ¡å±‚çš„ FollowService ç±»"></a>åˆ›å»ºä¸šåŠ¡å±‚çš„ FollowService ç±»</h2><ul><li><p>æ–°å¢æ–¹æ³• <code>follow()</code>ï¼Œå½“ç”¨æˆ·å…³æ³¨æŸå®ä½“æ—¶ï¼š</p><ul><li>è°ƒç”¨æ–¹æ³• <code>add() </code>å°†å½“å‰å®ä½“ id å’Œæ—¶é—´ä½œä¸º value å’Œ score åŠ å…¥åˆ°ç”¨æˆ·çš„å…³æ³¨é›†åˆä¸­ã€‚</li><li>è°ƒç”¨æ–¹æ³• <code>add()</code> å°†å½“å‰ç”¨æˆ· id å’Œæ—¶é—´ä½œä¸º value å’Œ score åŠ å…¥åˆ°å®ä½“çš„ç²‰ä¸é›†åˆä¸­ã€‚</li></ul></li><li><p>æ–°å¢æ–¹æ³• <code>unfollow()</code>ï¼Œå½“ç”¨æˆ·å–å…³æŸå®ä½“æ—¶ï¼š</p><ul><li>è°ƒç”¨æ–¹æ³• <code>remove()</code> å°†å½“å‰å®ä½“ä»ç”¨æˆ·çš„å…³æ³¨é›†åˆä¸­ç§»é™¤ã€‚</li><li>è°ƒç”¨æ–¹æ³• <code>remove()</code> å°†ç”¨æˆ·ä»å®ä½“çš„ç²‰ä¸é›†åˆä¸­ç§»é™¤ã€‚</li></ul></li></ul><pre><code class="java">@Servicepublic class FollowService &#123;    @Autowired    private RedisTemplate redisTemplate;    public void follow(int userId, int entityType, int entityId) &#123;        redisTemplate.execute(new SessionCallback() &#123;            @Override            public Object execute(RedisOperations operations) throws DataAccessException &#123;                String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);                String followerKey = RedisKeyUtil.getFollowerKey(entityType, entityId);                operations.multi();                operations.opsForZSet().add(followeeKey, entityId, System.currentTimeMillis());                operations.opsForZSet().add(followerKey, userId, System.currentTimeMillis());                return operations.exec();            &#125;        &#125;);    &#125;    public void unfollow(int userId, int entityType, int entityId) &#123;        redisTemplate.execute(new SessionCallback() &#123;            @Override            public Object execute(RedisOperations operations) throws DataAccessException &#123;                String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);                String followerKey = RedisKeyUtil.getFollowerKey(entityType, entityId);                operations.multi();                operations.opsForZSet().remove(followeeKey, entityId);                operations.opsForZSet().remove(followerKey, userId);                return operations.exec();            &#125;        &#125;);    &#125;&#125;</code></pre><h2 id="åˆ›å»ºè¡¨ç°å±‚çš„-FollowController"><a href="#åˆ›å»ºè¡¨ç°å±‚çš„-FollowController" class="headerlink" title="åˆ›å»ºè¡¨ç°å±‚çš„ FollowController"></a>åˆ›å»ºè¡¨ç°å±‚çš„ FollowController</h2><ul><li>æ–°å¢æ–¹æ³• <code>follow()</code>ï¼šè°ƒç”¨ HostHolder å¯¹è±¡çš„æ–¹æ³•è·å–ç”¨æˆ·ï¼Œè°ƒç”¨ä¸šåŠ¡å±‚çš„ <code>FollowService</code> ç±»çš„å¯¹è±¡çš„æ–¹æ³• <code>follow()</code> å®ç°ç‚¹èµçš„åŠŸèƒ½ã€‚</li><li>æ–°å¢æ–¹æ³• <code>unfollow()</code>ï¼šè°ƒç”¨ HostHolder å¯¹è±¡çš„æ–¹æ³•è·å–ç”¨æˆ·ï¼Œè°ƒç”¨ä¸šåŠ¡å±‚çš„ <code>FollowService</code> ç±»çš„å¯¹è±¡çš„æ–¹æ³• <code>unfollow()</code> å®ç°å–æ¶ˆç‚¹èµçš„åŠŸèƒ½ã€‚</li></ul><pre><code class="java">@Controllerpublic class FollowController &#123;    @Autowired    private FollowService followService;    @Autowired    private HostHolder hostHolder;    @PostMapping(&quot;/follow&quot;)    @ResponseBody    public String follow(int entityType, int entityId) &#123;        User user = hostHolder.getUser();        followService.follow(user.getId(), entityType, entityId);        return CommunityUtil.getJSONString(0, &quot;å·²å…³æ³¨!&quot;);    &#125;    @PostMapping(&quot;/unfollow&quot;)    @ResponseBody    public String unfollow(int entityType, int entityId) &#123;        User user = hostHolder.getUser();        followService.unfollow(user.getId(), entityType, entityId);        return CommunityUtil.getJSONString(0, &quot;å·²å–æ¶ˆå…³æ³¨!&quot;);    &#125;&#125;</code></pre><h1 id="4-ä¸ªäººä¸»é¡µ"><a href="#4-ä¸ªäººä¸»é¡µ" class="headerlink" title="4. ä¸ªäººä¸»é¡µ"></a>4. ä¸ªäººä¸»é¡µ</h1><h2 id="æ›´æ–°ä¸šåŠ¡å±‚çš„-FollowService-ç±»"><a href="#æ›´æ–°ä¸šåŠ¡å±‚çš„-FollowService-ç±»" class="headerlink" title="æ›´æ–°ä¸šåŠ¡å±‚çš„ FollowService ç±»"></a>æ›´æ–°ä¸šåŠ¡å±‚çš„ FollowService ç±»</h2><ul><li><p>æ–°å¢æ–¹æ³• <code>findFolloweeCount()</code>ï¼Œè°ƒç”¨ zset é›†åˆçš„æ–¹æ³•<code>zcard()</code>æŸ¥è¯¢æŸç”¨æˆ·å…³æ³¨çš„å®ä½“æ•°é‡ã€‚</p></li><li><p>æ–°å¢æ–¹æ³• <code>findFollowerCount()</code>ï¼Œè°ƒç”¨ zset é›†åˆçš„æ–¹æ³•<code>zcard()</code>æŸ¥è¯¢æŸå®ä½“çš„ç²‰ä¸æ•°é‡ã€‚</p></li><li><p>æ–°å¢æ–¹æ³• <code>hasFollowed()</code>ï¼Œæ ¹æ® zset é›†åˆçš„æ–¹æ³•<code>zscore()</code>çš„è¿”å›å€¼æŸ¥è¯¢å½“å‰ç”¨æˆ·æ˜¯å¦å…³æ³¨äº†æŸå®ä½“ã€‚</p></li></ul><pre><code class="java">// æŸ¥è¯¢å…³æ³¨çš„å®ä½“çš„æ•°é‡public long findFolloweeCount(int userId, int entityType) &#123;    String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);    return redisTemplate.opsForZSet().zCard(followeeKey);&#125;// æŸ¥è¯¢å®ä½“çš„ç²‰ä¸çš„æ•°é‡public long findFollowerCount(int entityType, int entityId) &#123;    String followerKey = RedisKeyUtil.getFollowerKey(entityType, entityId);    return redisTemplate.opsForZSet().zCard(followerKey);&#125;// æŸ¥è¯¢å½“å‰ç”¨æˆ·æ˜¯å¦å·²å…³æ³¨è¯¥å®ä½“public boolean hasFollowed(int userId, int entityType, int entityId) &#123;    String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);    return redisTemplate.opsForZSet().score(followeeKey, entityId) != null;&#125;</code></pre><h2 id="æ›´æ–°è¡¨ç°å±‚çš„-UserController-ç±»-1"><a href="#æ›´æ–°è¡¨ç°å±‚çš„-UserController-ç±»-1" class="headerlink" title="æ›´æ–°è¡¨ç°å±‚çš„ UserController ç±»"></a>æ›´æ–°è¡¨ç°å±‚çš„ UserController ç±»</h2><ul><li><p>è°ƒç”¨ä¸šåŠ¡å±‚çš„ <code>LikeService</code> ç±»ä¸­çš„æ–¹æ³• <code>findUserLikeCount()</code> æŸ¥è¯¢ç”¨æˆ·è·èµæ•°ï¼Œå¹¶æ·»åŠ åˆ° Model ä¸­ã€‚</p></li><li><p>è°ƒç”¨ä¸šåŠ¡å±‚çš„ <code>FollowService</code> ç±»ä¸­çš„æ–¹æ³• <code>findFolloweeCount()</code> æŸ¥è¯¢å…³æ³¨æ•°é‡ï¼Œè°ƒç”¨æ–¹æ³• <code>findFollowerCount()</code> æŸ¥è¯¢ç²‰ä¸æ•°é‡ï¼Œè°ƒç”¨æ–¹æ³• <code>hasFollowed()</code> æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å…³æ³¨ï¼Œå¹¶å°†ä¸‰é¡¹ä¿¡æ¯å­˜å‚¨äº Model å¯¹è±¡ä¸­ã€‚</p></li><li><p>æ›´æ–°è·å–ä¸ªäººä¸»é¡µæ–¹æ³• <code>getProfilePage()</code>ï¼šæ–°å¢å…³æ³¨æ•°ã€ç²‰ä¸æ•°ã€åˆ¤æ–­æ˜¯å¦å·²å…³æ³¨ï¼Œå¹¶å°†ä¸‰é¡¹ä¿¡æ¯å­˜å‚¨äº Model å¯¹è±¡ä¸­ã€‚</p></li></ul><pre><code class="java">// ä¸ªäººä¸»é¡µ@RequestMapping(path = &quot;/profile/&#123;userId&#125;&quot;, method = RequestMethod.GET)public String getProfilePage(@PathVariable(&quot;userId&quot;) int userId, Model model) &#123;    User user = userService.findUserById(userId);    if (user == null) &#123;        throw new RuntimeException(&quot;è¯¥ç”¨æˆ·ä¸å­˜åœ¨!&quot;);    &#125;    // ç”¨æˆ·    model.addAttribute(&quot;user&quot;, user);    // ç‚¹èµæ•°é‡    int likeCount = likeService.findUserLikeCount(userId);    model.addAttribute(&quot;likeCount&quot;, likeCount);    // å…³æ³¨æ•°é‡    long followeeCount = followService.findFolloweeCount(userId, ENTITY_TYPE_USER);    model.addAttribute(&quot;followeeCount&quot;, followeeCount);    // ç²‰ä¸æ•°é‡    long followerCount = followService.findFollowerCount(ENTITY_TYPE_USER, userId);    model.addAttribute(&quot;followerCount&quot;, followerCount);    // æ˜¯å¦å·²å…³æ³¨    boolean hasFollowed = false;    if (hostHolder.getUser() != null) &#123;        hasFollowed = followService.hasFollowed(hostHolder.getUser().getId(), ENTITY_TYPE_USER, userId);    &#125;    model.addAttribute(&quot;hasFollowed&quot;, hasFollowed);    return &quot;/site/profile&quot;;&#125;</code></pre><h1 id="5-å…³æ³¨åˆ—è¡¨å’Œç²‰ä¸åˆ—è¡¨"><a href="#5-å…³æ³¨åˆ—è¡¨å’Œç²‰ä¸åˆ—è¡¨" class="headerlink" title="5.å…³æ³¨åˆ—è¡¨å’Œç²‰ä¸åˆ—è¡¨"></a>5.å…³æ³¨åˆ—è¡¨å’Œç²‰ä¸åˆ—è¡¨</h1><h2 id="æ›´æ–°ä¸šåŠ¡å±‚çš„-FollowService-ç±»-1"><a href="#æ›´æ–°ä¸šåŠ¡å±‚çš„-FollowService-ç±»-1" class="headerlink" title="æ›´æ–°ä¸šåŠ¡å±‚çš„ FollowService ç±»"></a>æ›´æ–°ä¸šåŠ¡å±‚çš„ FollowService ç±»</h2><ul><li><p>æ–°å¢æ–¹æ³• <code>findFollowees()</code>ï¼šæŸ¥è¯¢ç”¨æˆ·å…³æ³¨åˆ—è¡¨ã€‚é€šè¿‡ zset é›†åˆçš„æ–¹æ³• <code>reverseRange()</code> è·å– value å³å…³æ³¨ç”¨æˆ·çš„ userIdï¼Œå†æŸ¥è¯¢å‡ºå…¶å¯¹åº”çš„ userï¼Œä¹‹åé€šè¿‡ score è·å–å…³æ³¨æ—¶é—´ï¼Œå­˜å…¥ map é›†åˆä¸­ï¼Œå°† map æ·»åŠ åˆ° list åˆ—è¡¨ä¸­å¹¶è¿”å›ã€‚</p></li><li><p>æ–°å¢æ–¹æ³• <code>findFollowers()</code>ï¼šæŸ¥è¯¢ç”¨æˆ·ç²‰ä¸åˆ—è¡¨ã€‚é€šè¿‡ zset é›†åˆçš„æ–¹æ³• <code>reverseRange()</code> è·å– value å³ç²‰ä¸çš„ userIdï¼Œå†æŸ¥è¯¢å‡ºå…¶å¯¹åº”çš„ userï¼Œä¹‹åé€šè¿‡ score è·å–å…³æ³¨æ—¶é—´ï¼Œå­˜å…¥ map é›†åˆä¸­ï¼Œå°† map æ·»åŠ åˆ° list åˆ—è¡¨ä¸­å¹¶è¿”å›ã€‚</p></li><li><p>æ–°å¢æ–¹æ³• <code>hasFollowed()</code>ï¼Œæ ¹æ® zset é›†åˆçš„æ–¹æ³• <code>zscore()</code> çš„è¿”å›å€¼æŸ¥è¯¢å½“å‰ç”¨æˆ·æ˜¯å¦å…³æ³¨äº†æŸå®ä½“ã€‚</p></li></ul><pre><code class="java">// æŸ¥è¯¢æŸç”¨æˆ·å…³æ³¨çš„äººpublic List&lt;Map&lt;String, Object&gt;&gt; findFollowees(int userId, int offset, int limit) &#123;    String followeeKey = RedisKeyUtil.getFolloweeKey(userId, ENTITY_TYPE_USER);    Set&lt;Integer&gt; targetIds = redisTemplate.opsForZSet().reverseRange(followeeKey, offset, offset + limit - 1);    if (targetIds == null) &#123;        return null;    &#125;    List&lt;Map&lt;String, Object&gt;&gt; list = new ArrayList&lt;&gt;();    for (Integer targetId : targetIds) &#123;        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();        User user = userService.findUserById(targetId);        map.put(&quot;user&quot;, user);        Double score = redisTemplate.opsForZSet().score(followeeKey, targetId);        map.put(&quot;followTime&quot;, new Date(score.longValue()));        list.add(map);    &#125;    return list;&#125;// æŸ¥è¯¢æŸç”¨æˆ·çš„ç²‰ä¸public List&lt;Map&lt;String, Object&gt;&gt; findFollowers(int userId, int offset, int limit) &#123;    String followerKey = RedisKeyUtil.getFollowerKey(ENTITY_TYPE_USER, userId);    Set&lt;Integer&gt; targetIds = redisTemplate.opsForZSet().reverseRange(followerKey, offset, offset + limit - 1);    if (targetIds == null) &#123;        return null;    &#125;    List&lt;Map&lt;String, Object&gt;&gt; list = new ArrayList&lt;&gt;();    for (Integer targetId : targetIds) &#123;        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();        User user = userService.findUserById(targetId);        map.put(&quot;user&quot;, user);        Double score = redisTemplate.opsForZSet().score(followerKey, targetId);        map.put(&quot;followTime&quot;, new Date(score.longValue()));        list.add(map);    &#125;    return list;&#125;</code></pre><h2 id="æ›´æ–°è¡¨ç°å±‚çš„-FollowController-ç±»"><a href="#æ›´æ–°è¡¨ç°å±‚çš„-FollowController-ç±»" class="headerlink" title="æ›´æ–°è¡¨ç°å±‚çš„ FollowController ç±»"></a>æ›´æ–°è¡¨ç°å±‚çš„ FollowController ç±»</h2><ul><li>æ–°å¢æ–¹æ³• <code>getFollowees()</code>ï¼Œè·å–å…³æ³¨åˆ—è¡¨ï¼Œå­˜å…¥ Model å¯¹è±¡ä¸­ã€‚</li><li>æ–°å¢æ–¹æ³• <code>getFollowers()</code>ï¼Œè·å–ç²‰ä¸åˆ—è¡¨ï¼Œå­˜å…¥ Model å¯¹è±¡ä¸­ã€‚</li></ul><pre><code class="java">@GetMapping(&quot;/followees/&#123;userId&#125;&quot;)public String getFollowees(@PathVariable(&quot;userId&quot;) int userId, Page page, Model model) &#123;    User user = userService.findUserById(userId);    if (user == null) &#123;        throw new RuntimeException(&quot;è¯¥ç”¨æˆ·ä¸å­˜åœ¨!&quot;);    &#125;    model.addAttribute(&quot;user&quot;, user);    page.setLimit(5);    page.setPath(&quot;/followees/&quot; + userId);    page.setRows((int) followService.findFolloweeCount(userId, ENTITY_TYPE_USER));    List&lt;Map&lt;String, Object&gt;&gt; userList = followService.findFollowees(userId, page.getOffset(), page.getLimit());    if (userList != null) &#123;        for (Map&lt;String, Object&gt; map : userList) &#123;            User u = (User) map.get(&quot;user&quot;);            map.put(&quot;hasFollowed&quot;, hasFollowed(u.getId()));        &#125;    &#125;    model.addAttribute(&quot;users&quot;, userList);    return &quot;/site/followee&quot;;&#125;@GetMapping(&quot;/followers/&#123;userId&#125;&quot;)public String getFollowers(@PathVariable(&quot;userId&quot;) int userId, Page page, Model model) &#123;    User user = userService.findUserById(userId);    if (user == null) &#123;        throw new RuntimeException(&quot;è¯¥ç”¨æˆ·ä¸å­˜åœ¨!&quot;);    &#125;    model.addAttribute(&quot;user&quot;, user);    page.setLimit(5);    page.setPath(&quot;/followers/&quot; + userId);    page.setRows((int) followService.findFollowerCount(ENTITY_TYPE_USER, userId));    List&lt;Map&lt;String, Object&gt;&gt; userList = followService.findFollowers(userId, page.getOffset(), page.getLimit());    if (userList != null) &#123;        for (Map&lt;String, Object&gt; map : userList) &#123;            User u = (User) map.get(&quot;user&quot;);            map.put(&quot;hasFollowed&quot;, hasFollowed(u.getId()));        &#125;    &#125;    model.addAttribute(&quot;users&quot;, userList);    return &quot;/site/follower&quot;;&#125;private boolean hasFollowed(int userId) &#123;    if (hostHolder.getUser() == null) &#123;        return false;    &#125;    return followService.hasFollowed(hostHolder.getUser().getId(), ENTITY_TYPE_USER, userId);&#125;</code></pre><h1 id="6-ä¼˜åŒ–ç™»å½•æ¨¡å—"><a href="#6-ä¼˜åŒ–ç™»å½•æ¨¡å—" class="headerlink" title="6. ä¼˜åŒ–ç™»å½•æ¨¡å—"></a>6. ä¼˜åŒ–ç™»å½•æ¨¡å—</h1><ol><li><p>ä½¿ç”¨ Redis å­˜å‚¨éªŒè¯ç ï¼šéªŒè¯ç éœ€è¦é¢‘ç¹è®¿é—®ä¸åˆ·æ–°ï¼Œå¯¹æ€§èƒ½è¦æ±‚è¾ƒé«˜ï¼›éªŒè¯ç ä¸éœ€è¦æ°¸ä¹…ä¿å­˜ï¼Œé€šå¸¸åœ¨å¾ˆçŸ­çš„æ—¶é—´å†…å°±ä¼šå¤±æ•ˆï¼›åˆ†å¸ƒå¼éƒ¨ç½²æ—¶ï¼Œå­˜åœ¨ Session å…±äº«çš„é—®é¢˜ã€‚</p></li><li><p>ä½¿ç”¨ Redis å­˜å‚¨ç™»å½•å‡­è¯ï¼šå¤„ç†æ¯æ¬¡è¯·æ±‚æ—¶ï¼Œéƒ½è¦æŸ¥è¯¢ç”¨æˆ·çš„ç™»å½•å‡­è¯ï¼Œè®¿é—®çš„é¢‘ç‡éå¸¸é«˜ã€‚</p></li><li><p>ä½¿ç”¨ Redis ç¼“å­˜ç”¨æˆ·ä¿¡æ¯ï¼šæ¯æ¬¡å¤„ç†è¯·æ±‚æ—¶ï¼Œéƒ½è¦æ ¹æ®å‡­è¯æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œè®¿é—®çš„é¢‘ç‡éå¸¸é«˜ã€‚</p></li></ol><h2 id="6-1-å­˜å‚¨éªŒè¯ç "><a href="#6-1-å­˜å‚¨éªŒè¯ç " class="headerlink" title="6.1 å­˜å‚¨éªŒè¯ç "></a>6.1 å­˜å‚¨éªŒè¯ç </h2><ul><li>æ›´æ–°å·¥å…·ç±» RedisUtil<ul><li>æ–°å¢éªŒè¯ç å‰ç¼€å¸¸é‡ <code>kaptcha</code></li><li>æ–°å¢æ–¹æ³• <code>getKaptchaKey()</code>ï¼Œé€šè¿‡ç”¨æˆ·å‡­è¯ï¼ˆç”±äºæœªç™»å½•ï¼Œé‡‡ç”¨ cookie å®ç°ï¼‰è·å¾—å¯¹åº”éªŒè¯ç çš„ keyï¼ˆåˆ©ç”¨ String å­˜å‚¨éªŒè¯ç ï¼‰ã€‚</li></ul></li></ul><pre><code class="java">private static final String PREFIX_KAPTCHA = &quot;kaptcha&quot;;// ç™»å½•éªŒè¯ç public static String getKaptchaKey(String owner) &#123;    return PREFIX_KAPTCHA + SPLIT + owner;&#125;</code></pre><ul><li>æ›´æ–°è¡¨ç°å±‚çš„ LoginController ç±»<ul><li>é‡æ„æ–¹æ³• <code>getKaptcha()</code>ï¼Œå°†éªŒè¯ç å­˜å…¥ redisï¼Œkey ä¸ºå½“å‰éšæœºç”Ÿæˆçš„å­—ç¬¦ä¸²ï¼ŒåŒæ—¶å°†è¯¥å­—ç¬¦ä¸²å­˜å…¥ cookieã€‚</li><li>é‡æ„æ–¹æ³• <code>login()</code>ï¼Œä» cookie ä¸­è·å–éšæœºå­—ç¬¦ä¸²ï¼Œç”ŸæˆéªŒè¯ç çš„ keyï¼Œç„¶åè·å– key å¯¹åº”çš„ value å³éªŒè¯ç ã€‚</li></ul></li></ul><pre><code class="java">@GetMapping(&quot;/kaptcha&quot;)public void getKaptcha(HttpServletResponse response/*, HttpSession session*/) &#123;    // ç”ŸæˆéªŒè¯ç     String text = kaptchaProducer.createText();    BufferedImage image = kaptchaProducer.createImage(text);    // åŸæ¥çš„åšæ³•ï¼šå°†éªŒè¯ç å­˜å…¥ session    // session.setAttribute(&quot;kaptcha&quot;, text);    // éªŒè¯ç çš„å½’å±    String kaptchaOwner = CommunityUtil.generateUUID();    Cookie cookie = new Cookie(&quot;kaptchaOwner&quot;, kaptchaOwner);    cookie.setMaxAge(60);    cookie.setPath(contextPath);    response.addCookie(cookie);    // å°†éªŒè¯ç å­˜å…¥Redis    String redisKey = RedisKeyUtil.getKaptchaKey(kaptchaOwner);    redisTemplate.opsForValue().set(redisKey, text, 60, TimeUnit.SECONDS);    // å°†å›¾ç‰‡è¾“å‡ºç»™æµè§ˆå™¨    response.setContentType(&quot;image/png&quot;);    try &#123;        OutputStream os = response.getOutputStream();        ImageIO.write(image, &quot;png&quot;, os);    &#125; catch (IOException e) &#123;        logger.error(&quot;å“åº”éªŒè¯ç å¤±è´¥:&quot; + e.getMessage());    &#125;&#125;@PostMapping(&quot;/login&quot;)public String login(String username, String password, String code, boolean rememberme,                    Model model, /*HttpSession session, */HttpServletResponse response,                    @CookieValue(&quot;kaptchaOwner&quot;) String kaptchaOwner) &#123;    // æ£€æŸ¥éªŒè¯ç     // String kaptcha = (String) session.getAttribute(&quot;kaptcha&quot;);    String kaptcha = null;    if (StringUtils.isNotBlank(kaptchaOwner)) &#123;        String redisKey = RedisKeyUtil.getKaptchaKey(kaptchaOwner);        kaptcha = (String) redisTemplate.opsForValue().get(redisKey);    &#125;    if (StringUtils.isBlank(kaptcha) || StringUtils.isBlank(code) || !kaptcha.equalsIgnoreCase(code)) &#123;        model.addAttribute(&quot;codeMsg&quot;, &quot;éªŒè¯ç ä¸æ­£ç¡®!&quot;);        return &quot;/site/login&quot;;    &#125;    // æ£€æŸ¥è´¦å·,å¯†ç     int expiredSeconds = rememberme ? REMEMBER_EXPIRED_SECONDS : DEFAULT_EXPIRED_SECONDS;    Map&lt;String, Object&gt; map = userService.login(username, password, expiredSeconds);    if (map.containsKey(&quot;ticket&quot;)) &#123;        Cookie cookie = new Cookie(&quot;ticket&quot;, map.get(&quot;ticket&quot;).toString());        cookie.setPath(contextPath);        cookie.setMaxAge(expiredSeconds);        response.addCookie(cookie);        return &quot;redirect:/index&quot;;    &#125; else &#123;        model.addAttribute(&quot;usernameMsg&quot;, map.get(&quot;usernameMsg&quot;));        model.addAttribute(&quot;passwordMsg&quot;, map.get(&quot;passwordMsg&quot;));        return &quot;/site/login&quot;;    &#125;&#125;</code></pre><h2 id="6-2-å­˜å‚¨ç™»å½•å‡­è¯"><a href="#6-2-å­˜å‚¨ç™»å½•å‡­è¯" class="headerlink" title="6.2 å­˜å‚¨ç™»å½•å‡­è¯"></a>6.2 å­˜å‚¨ç™»å½•å‡­è¯</h2><ul><li>æ›´æ–°å·¥å…·ç±» RedisUtil<ul><li>æ–°å¢ç™»å½•å‡­è¯å‰ç¼€å¸¸é‡ <code>ticket</code></li><li>æ–°å¢æ–¹æ³• <code>getTicketKey</code>() ï¼Œé€šè¿‡å­—ç¬¦ä¸²è·å¾—ç™»å½•å‡­è¯çš„å¯¹åº” key ï¼ˆåˆ©ç”¨ String å­˜å‚¨ï¼‰ã€‚</li></ul></li></ul><pre><code class="java">private static final String PREFIX_TICKET = &quot;ticket&quot;;// ç™»å½•çš„å‡­è¯public static String getTicketKey(String ticket) &#123;    return PREFIX_TICKET + SPLIT + ticket;&#125;</code></pre><ul><li><p>æ›´æ–°ä¸šåŠ¡å±‚çš„ UserService ç±»</p><ul><li><p>é‡æ„æ–¹æ³• <code>login()</code> ï¼Œå°†ç™»å½•å‡­è¯å­˜å…¥ redis ä¸­ã€‚</p></li><li><p>é‡æ„æ–¹æ³• <code>logout</code>() ï¼Œå…ˆä» redis ä¸­è·å–ç™»å½•å‡­è¯å¯¹è±¡ï¼Œå°†çŠ¶æ€è®¾ä¸ºæ— æ•ˆå†é‡æ–°å­˜å‚¨è¿› redisã€‚</p></li><li><p>é‡æ„æ–¹æ³• <code>findLoginTicket</code>() ï¼Œæ ¹æ® ticket å­—ç¬¦ä¸²è·å¾—å¯¹åº”ç™»å½•å‡­è¯çš„ keyï¼Œç„¶åä» redis æŸ¥è¯¢ç™»å½•å‡­è¯ã€‚</p></li></ul></li></ul><pre><code class="java">public Map&lt;String, Object&gt; login(String username, String password, int expiredSeconds) &#123;    Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();    // ç©ºå€¼å¤„ç†    if (StringUtils.isBlank(username)) &#123;        map.put(&quot;usernameMsg&quot;, &quot;è´¦å·ä¸èƒ½ä¸ºç©º!&quot;);        return map;    &#125;    if (StringUtils.isBlank(password)) &#123;        map.put(&quot;passwordMsg&quot;, &quot;å¯†ç ä¸èƒ½ä¸ºç©º!&quot;);        return map;    &#125;    // éªŒè¯è´¦å·    User user = userMapper.selectByName(username);    if (user == null) &#123;        map.put(&quot;usernameMsg&quot;, &quot;è¯¥è´¦å·ä¸å­˜åœ¨!&quot;);        return map;    &#125;    // éªŒè¯çŠ¶æ€    if (user.getStatus() == 0) &#123;        map.put(&quot;usernameMsg&quot;, &quot;è¯¥è´¦å·æœªæ¿€æ´»!&quot;);        return map;    &#125;    // éªŒè¯å¯†ç     password = CommunityUtil.md5(password + user.getSalt());    if (!user.getPassword().equals(password)) &#123;        map.put(&quot;passwordMsg&quot;, &quot;å¯†ç ä¸æ­£ç¡®!&quot;);        return map;    &#125;    // ç”Ÿæˆç™»å½•å‡­è¯    LoginTicket loginTicket = new LoginTicket();    loginTicket.setUserId(user.getId());    loginTicket.setTicket(CommunityUtil.generateUUID());    loginTicket.setStatus(0);    loginTicket.setExpired(new Date(System.currentTimeMillis() + expiredSeconds * 1000));        // loginTicketMapper.insertLoginTicket(loginTicket);    String redisKey = RedisKeyUtil.getTicketKey(loginTicket.getTicket());    redisTemplate.opsForValue().set(redisKey, loginTicket);    map.put(&quot;ticket&quot;, loginTicket.getTicket());    return map;&#125;public void logout(String ticket) &#123;        // loginTicketMapper.updateStatus(ticket, 1);    String redisKey = RedisKeyUtil.getTicketKey(ticket);    LoginTicket loginTicket = (LoginTicket) redisTemplate.opsForValue().get(redisKey);    loginTicket.setStatus(1);    redisTemplate.opsForValue().set(redisKey, loginTicket);&#125;public LoginTicket findLoginTicket(String ticket) &#123;        // return loginTicketMapper.selectByTicket(ticket);    String redisKey = RedisKeyUtil.getTicketKey(ticket);    return (LoginTicket) redisTemplate.opsForValue().get(redisKey);&#125;public int updateHeader(int userId, String headerUrl) &#123;        // return userMapper.updateHeader(userId, headerUrl);    int rows = userMapper.updateHeader(userId, headerUrl);    clearCache(userId);    return rows;&#125;</code></pre><h2 id="6-3-ç¼“å­˜ç”¨æˆ·ä¿¡æ¯"><a href="#6-3-ç¼“å­˜ç”¨æˆ·ä¿¡æ¯" class="headerlink" title="6.3 ç¼“å­˜ç”¨æˆ·ä¿¡æ¯"></a>6.3 ç¼“å­˜ç”¨æˆ·ä¿¡æ¯</h2><ul><li><p>æ›´æ–°å·¥å…·ç±» RedisUtil </p><ul><li><p>æ–°å¢ç”¨æˆ·å‰ç¼€å¸¸é‡ <code>user</code></p></li><li><p>æ–°å¢ <code>getUserKey</code> æ–¹æ³•ï¼Œé€šè¿‡ç”¨æˆ· id è·å¾—ç”¨æˆ·çš„å¯¹åº” key å€¼ï¼ˆåˆ©ç”¨ String å­˜å‚¨ï¼‰ã€‚</p></li></ul></li></ul><pre><code class="java">private static final String PREFIX_USER = &quot;user&quot;;// ç”¨æˆ·public static String getUserKey(int userId) &#123;    return PREFIX_USER + SPLIT + userId;&#125;</code></pre><ul><li><p>æ›´æ–°ä¸šåŠ¡å±‚çš„ UserService ç±»</p><ul><li><p>æ–°å¢ <code>getCache</code>()ï¼Œä»ç¼“å­˜è·å–ç”¨æˆ·ä¿¡æ¯ã€‚</p></li><li><p>æ–°å¢ <code>initCache()</code>ï¼Œä» MySQL æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯å¹¶å­˜å…¥ redisã€‚</p></li><li><p>æ–°å¢ <code>clearCache()</code>ï¼Œç”¨æˆ·ä¿¡æ¯å˜æ›´ï¼ˆæ›´æ–°å¤´åƒï¼Œæ¿€æ´»ï¼‰æ—¶æ¸…é™¤ç¼“å­˜ã€‚</p></li><li><p>é‡æ„ <code>findUserById()</code> æ–¹æ³•ï¼Œé¦–å…ˆè°ƒç”¨ <code>getCache()</code>ä»ç¼“å­˜è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚æœè·å–ä¸º null åˆ™è°ƒç”¨ <code>initCache()</code>ã€‚</p></li></ul></li></ul><pre><code class="java">// 1.ä¼˜å…ˆä»ç¼“å­˜ä¸­å–å€¼private User getCache(int userId) &#123;    String redisKey = RedisKeyUtil.getUserKey(userId);    return (User) redisTemplate.opsForValue().get(redisKey);&#125;// 2.å–ä¸åˆ°æ—¶åˆå§‹åŒ–ç¼“å­˜æ•°æ®private User initCache(int userId) &#123;    User user = userMapper.selectById(userId);    String redisKey = RedisKeyUtil.getUserKey(userId);    redisTemplate.opsForValue().set(redisKey, user, 3600, TimeUnit.SECONDS);    return user;&#125;// 3.æ•°æ®å˜æ›´æ—¶æ¸…é™¤ç¼“å­˜æ•°æ®private void clearCache(int userId) &#123;    String redisKey = RedisKeyUtil.getUserKey(userId);    redisTemplate.delete(redisKey);&#125;public User findUserById(int id) &#123;        // return userMapper.selectById(id);    User user = getCache(id);    if (user == null) &#123;        user = initCache(id);    &#125;    return user;&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Spring Boot </tag>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åˆ†å¸ƒå¼æµåª’ä½“å¹³å° Kafka</title>
      <link href="/2023/03/07/kafka/"/>
      <url>/2023/03/07/kafka/</url>
      
        <content type="html"><![CDATA[<h1 id="Kafka-ç®€ä»‹"><a href="#Kafka-ç®€ä»‹" class="headerlink" title="Kafka ç®€ä»‹"></a>Kafka ç®€ä»‹</h1><p>ğŸŒŸ <a href="http://kafka.apach.org/">Kafkaå®˜ç½‘</a></p><ul><li>Kafka æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„æµåª’ä½“å¹³å°ã€‚</li><li>åº”ç”¨åœºæ™¯ï¼šæ¶ˆæ¯ç³»ç»Ÿã€æ—¥å¿—æ”¶é›†ã€ç”¨æˆ·è¡Œä¸ºè¿½è¸ªã€æµå¼å¤„ç†ã€‚</li></ul><h1 id="Kafka-ç‰¹ç‚¹"><a href="#Kafka-ç‰¹ç‚¹" class="headerlink" title="Kafka ç‰¹ç‚¹"></a>Kafka ç‰¹ç‚¹</h1><ul><li>é«˜ååé‡</li><li>æ¶ˆæ¯æŒä¹…åŒ–</li><li>é«˜å¯é æ€§</li><li>é«˜æ‰©å±•æ€§</li></ul><h1 id="Kafka-æœ¯è¯­"><a href="#Kafka-æœ¯è¯­" class="headerlink" title="Kafka æœ¯è¯­"></a>Kafka æœ¯è¯­</h1><ul><li>Broker</li><li>Zookeeper</li><li>Topic</li><li>Partition</li><li>Offset</li><li>Leader Replica</li><li>Follower Replica</li></ul><h1 id="Kafka-é…ç½®"><a href="#Kafka-é…ç½®" class="headerlink" title="Kafka é…ç½®"></a>Kafka é…ç½®</h1><ol><li>åœ¨ Kafka å®‰è£…åŒ…ä¸‹çš„ config æ–‡ä»¶å¤¹ä¸‹çš„ <code>zookeeper.properties</code>æ–‡ä»¶å†…ä¿®æ”¹ï¼š</li></ol><pre><code class="properties"># é»˜è®¤å­˜æ”¾è·¯å¾„dataDir=/tmp/zookeeper</code></pre><ol start="2"><li>åœ¨ Kafka å®‰è£…åŒ…ä¸‹çš„ config æ–‡ä»¶å¤¹ä¸‹çš„ <code>server.properties</code>æ–‡ä»¶å†…ä¿®æ”¹ï¼š</li></ol><pre><code class="properties"># é»˜è®¤å­˜æ”¾è·¯å¾„log.dirs=/tmp/kafka-logs</code></pre><h1 id="Kafka-å¸¸ç”¨å‘½ä»¤"><a href="#Kafka-å¸¸ç”¨å‘½ä»¤" class="headerlink" title="Kafka å¸¸ç”¨å‘½ä»¤"></a>Kafka å¸¸ç”¨å‘½ä»¤</h1><ol><li>æ‰“å¼€ä¸€ä¸ª terminal çª—å£ï¼Œå¯åŠ¨ Zookeeperï¼š</li></ol><pre><code class="sh"># cd åˆ° Kafka çš„ bin ç›®å½•ä¸‹ï¼Œeg: /usr/local/kafka_2.13-3.4.0/bin~$ zookeeper-server-start.sh config\zookeeper.properties</code></pre><ol start="2"><li>æ‰“å¼€å¦ä¸€ä¸ª terminal çª—å£ï¼Œå¯åŠ¨ Kafkaï¼š</li></ol><pre><code class="sh"># cd åˆ° Kafka çš„ bin ç›®å½•ä¸‹ï¼Œeg: /usr/local/kafka_2.13-3.4.0/bin~$ zookeeper-server-start.sh config\server.properties</code></pre><ol start="3"><li>æ‰“å¼€å¦ä¸€ä¸ª terminal çª—å£ï¼Œå‘å¸ƒ topic ä¸º testï¼Œåˆ›å»º 1 ä¸ªå‰¯æœ¬ï¼Œåˆ›å»º 1 ä¸ªåˆ†åŒºï¼š</li></ol><pre><code class="sh"># cd åˆ° Kafka çš„ bin ç›®å½•ä¸‹ï¼Œeg: /usr/local/kafka_2.13-3.4.0/bin~$ kafka-topics.sh --create --bootstrap-server localhost:9092 --replication-factor 1 --partitions 1 --topic test</code></pre><ol start="4"><li>æŸ¥çœ‹æ˜¯å¦æˆåŠŸå‘å¸ƒ topicï¼š</li></ol><pre><code class="sh"># cd åˆ° Kafka çš„ bin ç›®å½•ä¸‹ï¼Œeg: /usr/local/kafka_2.13-3.4.0/bin~$ kafka-topics.sh --list --bootstrap-server localhost:9092</code></pre><pre><code class="sh"># å‘å¸ƒ topic æˆåŠŸï¼Œterminal æ˜¾ç¤º testtest</code></pre><ol start="5"><li>ç”Ÿäº§è€…å‘å¸ƒæ¶ˆæ¯ï¼š</li></ol><pre><code class="sh"># cd åˆ° Kafka çš„ bin ç›®å½•ä¸‹ï¼Œeg: /usr/local/kafka_2.13-3.4.0/bin~$ kafka-console-producer.sh --broker-list localhost:9092 --topic test</code></pre><ol start="6"><li>æ¶ˆè´¹è€…è®¢é˜…æ¶ˆæ¯ï¼š</li></ol><pre><code class="sh"># cd åˆ° Kafka çš„ bin ç›®å½•ä¸‹ï¼Œeg: /usr/local/kafka_2.13-3.4.0/bin~$ kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic test --from-beginning</code></pre><h1 id="Windows-ä¸‹å…³äº-Kafka-çš„ä½¿ç”¨æ³¨æ„ç‚¹"><a href="#Windows-ä¸‹å…³äº-Kafka-çš„ä½¿ç”¨æ³¨æ„ç‚¹" class="headerlink" title="Windows ä¸‹å…³äº Kafka çš„ä½¿ç”¨æ³¨æ„ç‚¹"></a>Windows ä¸‹å…³äº Kafka çš„ä½¿ç”¨æ³¨æ„ç‚¹</h1><ul><li>é—®é¢˜ï¼šåœ¨ Windows çš„å‘½ä»¤è¡Œé‡Œå¯åŠ¨ Kafka ä¹‹åï¼Œå½“å…³é—­å‘½ä»¤è¡Œçª—å£æ—¶ï¼Œå°±ä¼šå¼ºåˆ¶å…³é—­ Kafkaã€‚è¿™ç§å…³é—­æ–¹å¼ä¸ºæš´åŠ›å…³é—­ï¼Œå¾ˆå¯èƒ½ä¼šå¯¼è‡´ Kafka æ— æ³•å®Œæˆå¯¹æ—¥å¿—æ–‡ä»¶çš„è§£é”ã€‚å±Šæ—¶ï¼Œå†æ¬¡å¯åŠ¨ Kafka çš„æ—¶å€™ï¼Œå°±ä¼šæç¤ºæ—¥å¿—æ–‡ä»¶è¢«é”ï¼Œæ— æ³•æˆåŠŸå¯åŠ¨ã€‚</li><li>æ–¹æ¡ˆï¼šå°† Kafka çš„æ—¥å¿—æ–‡ä»¶å…¨éƒ¨åˆ é™¤ï¼Œå†æ¬¡å¯åŠ¨å³å¯ã€‚</li><li>å»ºè®®ï¼šä¸è¦æš´åŠ›å…³é—­ Kafkaï¼Œå»ºè®®é€šè¿‡åœ¨å‘½ä»¤è¡Œæ‰§è¡Œ <code>kafka-server-stop</code> å‘½ä»¤æ¥å…³é—­å®ƒã€‚</li><li>å…¶ä»–ï¼šå°†æ¥åœ¨ Linux ä¸Šéƒ¨ç½² Kafka ä¹‹åï¼Œé‡‡ç”¨åå°è¿è¡Œçš„æ–¹å¼ï¼Œå°±ä¼šé¿å…è¿™æ ·çš„é—®é¢˜ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Kafka </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Welcome to My HomePage!</title>
      <link href="/2023/03/05/hello-world/"/>
      <url>/2023/03/05/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><pre><code class="bash">$ hexo new &quot;My New Post&quot;</code></pre><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><pre><code class="bash">$ hexo server</code></pre><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><pre><code class="bash">$ hexo generate</code></pre><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><pre><code class="bash">$ hexo deploy</code></pre><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MacOSä¸‹å®‰è£…Node.jsé¿å‘æŒ‡å—</title>
      <link href="/2023/03/05/macos_nodejs/"/>
      <url>/2023/03/05/macos_nodejs/</url>
      
        <content type="html"><![CDATA[<ul><li><p>ä¸å»ºè®®çš„æ–¹æ³•ï¼šç›´æ¥åˆ° Node å®˜ç½‘ä¸‹è½½<code>.pkg</code>æ–‡ä»¶è¿›è¡Œå®‰è£…ã€‚</p></li><li><p>å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼šä½¿ç”¨<code>npm install -g hexo-cli</code>ç­‰æŒ‡ä»¤ä¼šæŠ¥é”™æ²¡æœ‰å†™å…¥çš„æƒé™ï¼Œç”šè‡³å°è¯•å„ç§<code>sudo</code>æƒé™éƒ½æ— æ•ˆã€‚</p></li><li><p>npm å®˜ç½‘æ•™ç¨‹ä¹Ÿä¸æ¨èé‡‡ç”¨<code>installer</code>è¿›è¡Œå®‰è£…ã€‚</p></li></ul><h2 id="å®‰è£…Node-jså’Œnpmçš„æ­£ç¡®æ–¹æ³•"><a href="#å®‰è£…Node-jså’Œnpmçš„æ­£ç¡®æ–¹æ³•" class="headerlink" title="å®‰è£…Node.jså’Œnpmçš„æ­£ç¡®æ–¹æ³•"></a>å®‰è£…Node.jså’Œnpmçš„æ­£ç¡®æ–¹æ³•</h2><p>ğŸŒŸ ä½¿ç”¨ node ç‰ˆæœ¬ç®¡ç†å·¥<code>nvm</code>(node version manager)å®‰è£… Node.js å’Œ npmã€‚</p><h3 id="Step-1"><a href="#Step-1" class="headerlink" title="Step 1"></a>Step 1</h3><p>å®‰è£…<code>nvm</code>ï¼š</p><pre><code>~$ curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash</code></pre><p>éªŒè¯<code>nvm</code>æ˜¯å¦å®‰è£…æˆåŠŸï¼š</p><pre><code>~$ command -v nvm</code></pre><p>è‹¥æˆåŠŸåˆ™å‡ºç°ä¸€è¡Œ<code>nvm</code>å­—ç¬¦(è‹¥æœªå‡ºç°åˆ™é‡å¯<code>terminal</code>)ï¼ŒæŸ¥è¯¢<code>nvm</code>ç‰ˆæœ¬ï¼š</p><pre><code>~$ nvm --version</code></pre><p>è¿”å›<code>nvm</code>ç‰ˆæœ¬å·ï¼š<code>0.34.0</code></p><h3 id="Step-2"><a href="#Step-2" class="headerlink" title="Step 2"></a>Step 2</h3><p>ä½¿ç”¨<code>nvm</code>å®‰è£…<code>node</code>ï¼š</p><pre><code>~$ nvm install node # &quot;node&quot; is an alias for the latest version</code></pre><h3 id="Step-3"><a href="#Step-3" class="headerlink" title="Step 3"></a>Step 3</h3><p>ä½¿ç”¨<code>npm</code>æŒ‡ä»¤å®‰è£…<code>hexo</code>ï¼š</p><pre><code>~$ npm install -g hexo-cli</code></pre><p>åˆå§‹åŒ–<code>hexo</code>ï¼ŒæŒ‡å®šæ–‡ä»¶å¤¹åä¸º blogï¼š</p><pre><code>~$ hexo init blog</code></pre><p>è¿›å…¥ blog æ–‡ä»¶å¤¹ä¸‹ï¼Œå®‰è£…<code>npm</code>ï¼š</p><pre><code>~ $ cd blog~ $ npm istall</code></pre><h2 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q &amp; A"></a>Q &amp; A</h2><p>Q1ï¼š<code>zsh: command not found: nvm</code></p><p>A1ï¼šè¿›å…¥ .nvm æ–‡ä»¶å¤¹ï¼ŒæŸ¥çœ‹æ˜¯å¦å­˜åœ¨ .bash_profile æ–‡ä»¶ï¼Œè‹¥å­˜åœ¨è¯¥æ–‡ä»¶åˆ™ç›´æ¥æ‰“å¼€ï¼š</p><pre><code>cd ~/.nvmopen .bash_profile</code></pre><p>è‹¥ä¸å­˜åœ¨åˆ™å…ˆåˆ›å»º .bash_profile æ–‡ä»¶ï¼š</p><pre><code>touch .bash_profile</code></pre><p>ç„¶ååœ¨ .bash_profile æ–‡ä»¶å†…å†™å…¥ï¼š</p><pre><code>export NVM_DIR=&quot;$HOME/.nvm&quot;[ -s &quot;$NVM_DIR/nvm.sh&quot; ] &amp;&amp; \. &quot;$NVM_DIR/nvm.sh&quot; # This loads nvm</code></pre><p>å†™å…¥å®Œæ¯•åï¼Œå…³é—­æ–‡ä»¶ï¼Œæ‰§è¡Œ .bash_profile æ–‡ä»¶ï¼š</p><pre><code>source .bash_profile</code></pre><p>Q2ï¼šæ¯æ¬¡å…³é—­<code>terminal</code>åï¼Œåˆå‡ºç°<code>zsh: command not found: nvm</code>ç­‰æ— æ³•æ‰¾åˆ°æŸæŒ‡ä»¤çš„æƒ…å†µï¼Œéœ€è¦é‡æ–°æ‰§è¡Œ .bash_profile æ–‡ä»¶ã€‚</p><p>A2ï¼šåŸå› æ˜¯é‡‡ç”¨çš„<code>terminal</code>æ˜¯<code>zsh</code>ï¼Œéœ€è¦å°†é…ç½®æ·»åŠ åˆ° .zshrc æ–‡ä»¶ä¸­ã€‚</p><p>æ‰“å¼€  .zshrc æ–‡ä»¶ï¼š</p><pre><code>open ~/.zshrc</code></pre><p>åœ¨ .zshrc æ–‡ä»¶å†…å†™å…¥ï¼š</p><pre><code>export NVM_DIR=~/.nvm[ -s &quot;$NVM_DIR/nvm.sh&quot; ] &amp;&amp; . &quot;$NVM_DIR/nvm.sh&quot;</code></pre><p>å†™å…¥å®Œæ¯•åï¼Œå…³é—­æ–‡ä»¶ï¼Œæ‰§è¡Œ .zshrc æ–‡ä»¶ï¼š</p><pre><code>source ~/.zshrc</code></pre>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>LeetCodeç®—æ³•ç¬”è®°ä¹‹é“¾è¡¨(åŒæŒ‡é’ˆè§£æ³•)</title>
      <link href="/2023/03/01/linkedlist/"/>
      <url>/2023/03/01/linkedlist/</url>
      
        <content type="html"><![CDATA[<p>ğŸŒŸ LeetCodeç®—æ³•ç¬”è®°ä¹‹é“¾è¡¨ï¼Œå¤ä¹ æ•´ç†åŒæŒ‡é’ˆè§£å†³é“¾è¡¨é¢˜ç›®ã€‚</p><h1 id="141-Linked-List-Cycle"><a href="#141-Linked-List-Cycle" class="headerlink" title="141. Linked List Cycle"></a>141. Linked List Cycle</h1><p><a href="https://leetcode.cn/problems/linked-list-cycle/">é¢˜æºï¼š141. Linked List Cycle</a></p><p>Given head, the head of a linked list, determine if the linked list has a cycle in it.</p><p>There is a cycle in a linked list if there is some node in the list that can be reached again by continuously following theÂ nextÂ pointer. Internally, posÂ is used to denote the index of the node thatÂ tailâ€™sÂ nextÂ pointer is connected to.Â Note thatÂ posÂ is not passed as a parameter.</p><p>ReturnÂ <code>true</code> if there is a cycle in the linked list. Otherwise, return <code>false</code>.</p><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ul><li>è®¾ç½®åŒæŒ‡é’ˆï¼Œæ…¢æŒ‡é’ˆ slow æ¯æ¬¡å‰è¿›ä¸€æ­¥ï¼Œå¿«æŒ‡é’ˆ fast æ¯æ¬¡å‰è¿›ä¸¤æ­¥ã€‚</li><li>å¦‚æœ fast æœ€ç»ˆé‡åˆ°ç©ºæŒ‡é’ˆï¼Œè¯´æ˜é“¾è¡¨ä¸­æ²¡æœ‰ç¯.</li><li>å¦‚æœ fast æœ€ç»ˆå’Œ slow ç›¸é‡ï¼Œé‚£è‚¯å®šæ˜¯ fast è¶…è¿‡äº† slow ä¸€åœˆï¼Œè¯´æ˜é“¾è¡¨ä¸­å«æœ‰ç¯ã€‚</li></ul><h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><pre><code class="java">/** * Definition for singly-linked list. * class ListNode &#123; *     int val; *     ListNode next; *     ListNode(int x) &#123; *         val = x; *         next = null; *     &#125; * &#125; */public class Solution &#123;    public boolean hasCycle(ListNode head) &#123;        ListNode fast = head, slow = head;        while (fast != null &amp;&amp; fast.next != null) &#123;            fast = fast.next.next;            slow = slow.next;            if (fast == slow) return true;        &#125;        return false;    &#125;&#125;</code></pre><h1 id="142-Linked-List-Cycle-II"><a href="#142-Linked-List-Cycle-II" class="headerlink" title="142. Linked List Cycle II"></a>142. Linked List Cycle II</h1><p><a href="https://leetcode.cn/problems/linked-list-cycle-ii/">é¢˜æºï¼š142. Linked List Cycle II</a></p><p>Given head, the head of a linked list, determine if the linked list has a cycle in it.</p><p>There is a cycle in a linked list if there is some node in the list that can be reached again by continuously following the next pointer. Internally, pos is used to denote the index of the node that tailâ€™s next pointer is connected to. Note that pos is not passed as a parameter.</p><p>Return <code>true</code> if there is a cycle in the linked list. Otherwise, return <code>false</code>.</p><h2 id="Solution-1"><a href="#Solution-1" class="headerlink" title="Solution"></a>Solution</h2><ul><li><p>è®¾ç½®åŒæŒ‡é’ˆï¼Œæ…¢æŒ‡é’ˆ slow æ¯æ¬¡å‰è¿›ä¸€æ­¥ï¼Œå¿«æŒ‡é’ˆ fast æ¯æ¬¡å‰è¿›ä¸¤æ­¥ã€‚</p></li><li><p>å½“å¿«ã€æ…¢æŒ‡é’ˆç›¸é‡æ—¶ï¼š</p><ul><li>è®©å…¶ä¸­ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å¤´èŠ‚ç‚¹ï¼›</li><li>æ­¤æ—¶ï¼Œè®¾ç½®å¿«ã€æ…¢æŒ‡é’ˆå‰è¿›é€Ÿåº¦ä¸€è‡´ï¼Œå‡æ¯æ¬¡å‰è¿›ä¸€æ­¥ã€‚</li></ul></li><li><p>åŸç†ï¼šå½“å¿«ã€æ…¢æŒ‡é’ˆåˆ†åˆ«ä»¥ 2vã€v çš„é€Ÿåº¦å‰è¿›å¹¶ç¬¬ä¸€æ¬¡ç›¸é‡æ—¶ï¼š</p><ul><li>å¦‚æœæ…¢æŒ‡é’ˆèµ°äº† k æ­¥ï¼Œåˆ™å¿«æŒ‡é’ˆä¸€å®šèµ°äº† 2k æ­¥ã€‚</li><li>å¿«æŒ‡é’ˆæ¯”æ…¢æŒ‡é’ˆå¤šèµ°çš„ k æ­¥ï¼Œå…¶å®å°±æ˜¯å¿«æŒ‡é’ˆåœ¨ç¯å†…è½¬åœˆï¼Œå³ k å€¼ä¸ºç¯é•¿åº¦çš„ <em>æ•´æ•°å€</em>ã€‚</li><li>å‡è®¾ç›¸é‡ç‚¹ M è·ç¦»ç¯çš„èµ·ç‚¹ C çš„è·ç¦»ä¸º mï¼Œåˆ™æ…¢æŒ‡é’ˆä»å¤´èŠ‚ç‚¹ H åˆ°ç¯çš„èµ·ç‚¹ C çš„ç§»åŠ¨è·ç¦»HC ä¸º <code>k - m</code>ã€‚</li><li>ä¹Ÿå°±æ˜¯è¯´å¦‚æœå¿«ã€æ…¢æŒ‡é’ˆåœ¨ç›¸é‡ç‚¹ M æ—¶ï¼Œé‡ç½®æ…¢æŒ‡é’ˆï¼Œè®©æ…¢æŒ‡é’ˆå†æ¬¡ä»å¤´èŠ‚ç‚¹ H å‡ºå‘ï¼Œå‰è¿› <code>k - m</code> æ­¥å³å¯åˆ°è¾¾ç¯çš„èµ·ç‚¹ Cã€‚</li><li>æ­¤æ—¶ï¼Œå¦‚æœå¿«æŒ‡é’ˆä»ç›¸é‡ç‚¹ç»§ç»­å‰è¿›ï¼Œä¸”é€Ÿåº¦å’Œæ…¢æŒ‡é’ˆä¿æŒä¸€è‡´éƒ½ä¸º vï¼Œæ°å·§ä¹Ÿéœ€å‰è¿› <code>k - m</code> æ­¥å³å¯åˆ°è¾¾ç¯çš„èµ·ç‚¹ Cã€‚</li></ul></li></ul><h2 id="Code-1"><a href="#Code-1" class="headerlink" title="Code"></a>Code</h2><pre><code class="java">/** * Definition for singly-linked list. * class ListNode &#123; *     int val; *     ListNode next; *     ListNode(int x) &#123; *         val = x; *         next = null; *     &#125; * &#125; */public class Solution &#123;    public ListNode detectCycle(ListNode head) &#123;        ListNode fast = head, slow = head;          // ç¬¬ä¸€ä¸ª while å¾ªç¯æ˜¯ä¸ºäº†å¯»æ‰¾ç›¸é‡ç‚¹ M        while (fast != null &amp;&amp; fast.next != null) &#123;            fast = fast.next.next;            slow = slow.next;            if (slow == fast) break;        &#125;        if (fast == null || fast.next == null) return null;        slow = head;          // ç¬¬äºŒä¸ª while å¾ªç¯æ˜¯ä¸ºäº†é‡ç½®æ…¢æŒ‡é’ˆåˆ°å¤´èŠ‚ç‚¹å¹¶å¯»æ‰¾ä¸¤ä¸ªæŒ‡é’ˆæœ€ç»ˆçš„ç›®çš„åœ°å³ ç¯èµ·ç‚¹        while (slow != fast) &#123;            fast = fast.next;            slow = slow.next;        &#125;        return slow;    &#125;&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Algorithm </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
