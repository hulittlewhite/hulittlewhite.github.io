<!DOCTYPE html>
<html>
	<head>
		
<title>æ ¡å›­ç¤¾åŒºè®ºå›é¡¹ç›®ä¹‹ Redis-Quiet</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" type="image/x-icon" href="/image/favicon.ico">

<link rel="stylesheet" href="/css/index.css">



<meta name="keywords" content="Java,Spring Boot,Redis,">
<meta name="description" content="">


<script src="/js/jquery.min.js"></script>


<script src="/js/index.js"></script>


<script src="/js/fancybox.umd.js"></script>


<script src="/js/fancybox-images.js"></script>


<script src="/js/gitalk.min.js"></script>


<script src="/js/hljs.min.js"></script>
 
<script>hljs.highlightAll();</script>

	<meta name="generator" content="Hexo 6.3.0"></head>

	<body>
		<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?e2863d3856a812993ba034f5145bf77c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

	<div class="header">
		<div class="header-top" id="header-top">
			<div class="h-left">
				<a href="/">
					<img src="/image/logo.png" alt="Quiet">
				</a>
			</div>
			<div class="h-right">
				<ul>
					
						
								<li>
									<a href="/">
										HOME
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/archives">
										ARCHIVE
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/categories">
										CATEGORIES
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/tags">
										TAGS
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/links">
										LINKS
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/about">
										ABOUT
									</a>
									<span class="dot"></span>
								</li>
								
									
				</ul>
			</div>
			<div class="h-right-close">
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
					<path fill="none" d="M0 0h24v24H0z" />
					<path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z" fill="rgba(68,68,68,1)" />
				</svg>
			</div>
		</div>
	</div>
	<div class="sidebar">
    <div class="topo">
        <h2>LebronLe</h2>
    </div>
    <ul>
        
        <li>
            <a href="/">HOME</a>
        </li>
        
        <li>
            <a href="/archives">ARCHIVE</a>
        </li>
        
        <li>
            <a href="/categories">CATEGORIES</a>
        </li>
        
        <li>
            <a href="/tags">TAGS</a>
        </li>
        
        <li>
            <a href="/links">LINKS</a>
        </li>
        
        <li>
            <a href="/about">ABOUT</a>
        </li>
        
    </ul>
    <div class="my_foot">
        
        <a target="_blank" rel="noopener" href="https://github.com/79E/hexo-theme-quiet">
            <img src="https://cdn.jsdelivr.net/gh/duogongneng/MyBlogImg/imggithub.png" alt="Quietä¸»é¢˜">
        </a>
        
    </div>
</div>
<div class='shelter'>
</div>
<style>
    .shelter{
        background-color: #333;
        opacity:0.5;
        cursor: pointer;
        display: none; 
        position: fixed;
        left: 0;
        top: 0; 
        right: 0;
        bottom: 0;
        z-index: 1998;
    }
    .sidebar {
        width: 66%;
        height: 100%;
        position: fixed;
        top: 0;
        right: -100%;
        bottom: 0;
        background: #fff;
        z-index: 1999;
        text-align: center;
        box-shadow: -6px 0 20px rgba(98, 94, 94, .815);
    }

    .topo {
        width: 100%;
        height: 200px;
        background: url(https://api.ixiaowai.cn/gqapi/gqapi.php) no-repeat;
        background-size: 100% 100%;
        position: relative;
        display: flex;
        align-items: flex-end
    }

    .topo h2 {
        color: #fff;
        z-index: 1;
        position: relative;
        margin: 0 0 10px 10px;
        font-size: 1.2em;
        box-sizing: border-box
    }

    .topo:before {
        content: '';
        background-image: url(/image/pattern.png);
        background-repeat: repeat;
        height: 100%;
        left: 0;
        position: absolute;
        top: 0;
        width: 100%;
        z-index: 1
    }

    .sidebar ul {
        width: 100%;
        margin-top: 50px
    }

    .sidebar ul li {
        height: 50px;
        list-style: none;
        font-size: 1.2em;
        text-align: right;
        margin-right: 10px
    }

    .sidebar ul li a {
        display: grid;
        color: #5d606a;
        text-overflow: ellipsis;
        width: 100%;
        text-decoration: none
    }

    .my_foot {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        position: absolute;
        bottom: 0
    }

    .my_foot a {
        text-decoration: none;
        margin-right: 10px;
        display: inline-block
    }

    .my_foot a img {
        width: 30px;
        height: 30px
    }
</style>

<script>
    $( function () {
	$( '.h-right-close>svg' )
		.click( function () {
			$( '.sidebar' )
				.animate( {
					right: "0"
				}, 500 );
			$( '.shelter' )
				.fadeIn( "slow" )
		} );
	$( '.shelter' )
		.click( function ( e ) {
			$( '.sidebar' )
				.animate( {
					right: "-100%"
				}, 500 );
			$( '.shelter' )
				.fadeOut( "slow" )
		} )
} )

</script>

<div class="post">
    <div class="post-header-background post-header-img"
    style="background: url('https://api.ixiaowai.cn/gqapi/gqapi.php')" 
>
    <div class="post-header-background-content">
        <ul class="post-header-tag">
            
            
            <li><a href="/tags/Java">Java</a></li>
            
            <li><a href="/tags/Spring Boot">Spring Boot</a></li>
            
            <li><a href="/tags/Redis">Redis</a></li>
            
            
        </ul>
        
        <h1>æ ¡å›­ç¤¾åŒºè®ºå›é¡¹ç›®ä¹‹ Redis</h1>
        <div class="post-header-info">
            <div class="post-header-info-author">
                
                    <svg t="1604839279282" class="icon" viewBox="0 0 1024 1024" version="1.1"
                        xmlns="http://www.w3.org/2000/svg" p-id="2901" width="20" height="20">
                        <path
                            d="M513 956.3c-247.7 0-448-200.3-448-448S265.3 66.2 513 66.2s448 200.3 448 448-200.3 442.1-448 442.1z m0-830.9c-212.2 0-388.8 170.7-388.8 388.8C124.2 726.3 294.9 903 513 903c212.2 0 388.8-170.7 388.8-388.8S725.2 125.4 513 125.4z m0 430.2c-94.2 0-170.7-76.5-170.7-170.7S418.8 207.8 513 207.8s170.7 76.5 170.7 170.7S607.2 555.6 513 555.6z m0-289.1c-64.6 0-112 52.8-112 112s47.4 117.9 112 117.9 112-52.8 112-112-47.4-117.9-112-117.9z m0 689.8c-135.7 0-259-58.7-341.9-158.9l-11.8-17.8 11.8-17.8c76.5-117.9 206.2-188.5 347.8-188.5 135.7 0 265 64.6 341.9 182.6l11.8 17.8-11.8 17.8C778 897.1 648.7 956.3 513 956.3zM230.3 773.2C300.9 849.7 406.9 897 513 897c112 0 218.1-47.4 288.6-129.8-70.5-88.2-170.7-135.6-282.7-135.6s-218.1 53.3-288.6 141.6z"
                            p-id="2902" fill="#ffffff"></path>
                    </svg>
                    
                <span class="post-header-info-author-text"> <a href="../../about">LebronLe</a></span>
                <div class="post-header-info-author-categories">
                    
                         <a href="../../categories/Java/" target="_blank" >Java</a>
                    
                </div>
                <p>2023-03-07 01:25:50</p>
            </div>
        </div>
    </div>
</div>
    <div class="post-content" id="content">
  
  <div id="article" class="post-content-info">
    

    <p>ğŸŒŸ æœ¬å¸–è®°å½• Spring Boot æ•´åˆ Redis å®ç°æ ¡å›­ç¤¾åŒºè®ºå›é¡¹ç›®çš„ç‚¹èµã€å…³æ³¨åŠŸèƒ½ï¼ŒåŒæ—¶ä¼˜åŒ–äº†ç™»å½•æ¨¡å—ä¸­çš„éªŒè¯ç å­˜å‚¨ã€ç™»å½•å‡­è¯å­˜å‚¨ã€ç”¨æˆ·ä¿¡æ¯ç¼“å­˜åŠŸèƒ½ã€‚</p>
<p>ğŸŒŸ å‡†å¤‡å·¥ä½œï¼š</p>
<ol>
<li>å¼•å…¥ Redis ä¾èµ–åˆ° pom.xml æ–‡ä»¶ä¸­ï¼š</li>
</ol>
<pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<ol start="2">
<li>åœ¨ application.properties æ–‡ä»¶ä¸­é…ç½® Redisï¼š</li>
</ol>
<pre><code class="properties"># RedisProperties
spring.redis.database=11
spring.redis.host=localhost
spring.redis.port=6379
</code></pre>
<ol start="3">
<li>ç¼–å†™é…ç½®ç±» RedisConfigï¼š</li>
</ol>
<pre><code class="java">@Configuration
public class RedisConfig &#123;
    @Bean
    public RedisTemplate&lt;String, Object&gt; redisTemplate(RedisConnectionFactory factory) &#123;
        RedisTemplate&lt;String, Object&gt; template = new RedisTemplate&lt;&gt;();
        template.setConnectionFactory(factory);

        // è®¾ç½® key çš„åºåˆ—åŒ–æ–¹å¼
        template.setKeySerializer(RedisSerializer.string());
        // è®¾ç½® value çš„åºåˆ—åŒ–æ–¹å¼
        template.setValueSerializer(RedisSerializer.json());
        // è®¾ç½® hash çš„ key çš„åºåˆ—åŒ–æ–¹å¼
        template.setHashKeySerializer(RedisSerializer.string());
        // è®¾ç½® hash çš„ value çš„åºåˆ—åŒ–æ–¹å¼
        template.setHashValueSerializer(RedisSerializer.json());

        template.afterPropertiesSet();
        return template;
    &#125;
&#125;
</code></pre>
<h1 id="1- ç‚¹èµæ¨¡å—"><a href="#1- ç‚¹èµæ¨¡å—" class="headerlink" title="1. ç‚¹èµæ¨¡å—"></a>1. ç‚¹èµæ¨¡å— </h1><p> ç‚¹èµæ¨¡å—åŒ…å«ï¼š</p>
<ol>
<li>ç‚¹èµï¼š(1) æ”¯æŒå¯¹å¸–å­ã€è¯„è®ºè¿›è¡Œç‚¹èµï¼›(2) ç¬¬ä¸€æ¬¡ç‚¹å‡»â€œèµâ€å®Œæˆç‚¹èµæ“ä½œï¼Œç¬¬äºŒæ¬¡ç‚¹å‡»â€œå·²èµâ€å®Œæˆå–æ¶ˆç‚¹èµæ“ä½œã€‚</li>
<li>é¦–é¡µï¼šç»Ÿè®¡å¸–å­çš„ç‚¹èµæ•°ã€‚</li>
<li>è¯¦æƒ…é¡µï¼š(1) ç»Ÿè®¡å¸–å­çš„ç‚¹èµæ•°ï¼›(2) æ˜¾ç¤ºç‚¹èµçŠ¶æ€ã€‚</li>
</ol>
<h2 id="åˆ›å»ºå·¥å…·ç±» -RedisKeyUtil"><a href="# åˆ›å»ºå·¥å…·ç±» -RedisKeyUtil" class="headerlink" title="åˆ›å»ºå·¥å…·ç±» RedisKeyUtil"></a>åˆ›å»ºå·¥å…·ç±» RedisKeyUtil</h2><ul>
<li>å®šä¹‰åˆ†éš”ç¬¦ <code>:</code></li>
<li>å®šä¹‰å®ä½“è·å¾—èµçš„ key å‰ç¼€å¸¸é‡  <code>like:entity</code></li>
<li>æ–°å¢æ–¹æ³• <code>getEntityLikeKey(int entityType, int entityId)</code>ï¼Œé€šè¿‡å®ä½“ç±»å‹å’Œå®ä½“ id ç”Ÿæˆå¯¹åº”å®ä½“è·å¾—èµçš„ keyï¼Œè¿™ä¸ª key çš„å‘ˆç°å½¢å¼ä¸º <code>like:entity:entityType:entityId</code>ã€‚</li>
</ul>
<pre><code class="jade">public class RedisKeyUtil &#123;
    private static final String SPLIT = &quot;:&quot;;
    private static final String PREFIX_ENTITY_LIKE = &quot;like:entity&quot;;

    // æŸä¸ªå®ä½“çš„èµ
    // like:entity:entityType:entityId -&gt; set(userId)
    public static String getEntityLikeKey(int entityType, int entityId) &#123;
        return PREFIX_ENTITY_LIKE + SPLIT + entityType + SPLIT + entityId;
    &#125;
&#125;
</code></pre>
<h2 id="åˆ›å»ºä¸šåŠ¡å±‚çš„ -LikeService- ç±»"><a href="# åˆ›å»ºä¸šåŠ¡å±‚çš„ -LikeService- ç±»" class="headerlink" title="åˆ›å»ºä¸šåŠ¡å±‚çš„ LikeService ç±»"></a>åˆ›å»ºä¸šåŠ¡å±‚çš„ LikeService ç±»</h2><ul>
<li>æ³¨å…¥ <code>RedisTemplate</code> å®ä¾‹</li>
</ul>
<pre><code class="java">@Autowired
private RedisTemplate redisTemplate;
</code></pre>
<ul>
<li>æ–°å¢æ–¹æ³• <code>like()</code> å®ç°ç‚¹èµåŠŸèƒ½ï¼š<ul>
<li>é¦–å…ˆï¼Œè°ƒç”¨å·¥å…·ç±» <code>RedisKeyUtil</code> ä¸­çš„æ–¹æ³• <code>getEntityLikeKey()</code> è·å¾—å®ä½“ç‚¹èµçš„ keyï¼›</li>
<li>ç„¶åï¼Œé€šè¿‡ <code>RedisTemplate</code> å®ä¾‹ï¼Œè°ƒç”¨ set é›†åˆçš„æ–¹æ³• <code>isMember()</code> æŸ¥è¯¢ userId æ˜¯å¦å­˜åœ¨äºå¯¹åº” key çš„ set é›†åˆä¸­ï¼Œå¦‚æœå­˜åœ¨åˆ™ç§»å‡ºç‚¹èµçš„ç”¨æˆ·é›†åˆï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ·»åŠ åˆ°ç‚¹èµçš„ç”¨æˆ·é›†åˆä¸­ã€‚</li>
</ul>
</li>
</ul>
<pre><code class="java"> // ç‚¹èµ
public void like(int userId, int entityType, int entityId) &#123;
    String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);
    boolean isMember = redisTemplate.opsForSet().isMember(entityLikeKey, userId);
      // åˆ¤æ–­æ˜¯å¦ç‚¹è¿‡èµ
    if (isMember) &#123;
        redisTemplate.opsForSet().remove(entityLikeKey, userId);
    &#125; else &#123;
        redisTemplate.opsForSet().add(entityLikeKey, userId);
    &#125;
&#125;
</code></pre>
<ul>
<li>æ–°å¢æ–¹æ³• <code>findEntityLikeCount()</code>ï¼šæŸ¥è¯¢æŸå®ä½“çš„ç‚¹èµæ•°ï¼Œé€šè¿‡è°ƒç”¨ set é›†åˆçš„æ–¹æ³• <code>size()</code> æŸ¥è¯¢å…ƒç´ çš„ä¸ªæ•°ã€‚</li>
</ul>
<pre><code class="java">// æŸ¥è¯¢æŸå®ä½“ç‚¹èµçš„æ•°é‡
public long findEntityLikeCount(int entityType, int entityId) &#123;
    String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);
    return redisTemplate.opsForSet().size(entityLikeKey);
&#125;
</code></pre>
<ul>
<li>æ–°å¢æ–¹æ³• <code>findEntityLikeStatus()</code>ï¼šæŸ¥è¯¢æŸç”¨æˆ·å¯¹æŸå®ä½“çš„ç‚¹èµçŠ¶æ€ï¼Œé€»è¾‘å®ç°åŒæ–¹æ³• <code>like()</code>ï¼Œå³é€šè¿‡è°ƒç”¨ set é›†åˆçš„æ–¹æ³• <code>isMember()</code> å®ç°ã€‚</li>
</ul>
<pre><code class="java">// æŸ¥è¯¢æŸäººå¯¹æŸå®ä½“çš„ç‚¹èµçŠ¶æ€
public int findEntityLikeStatus(int userId, int entityType, int entityId) &#123;
    String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);
    // 1 è¡¨ç¤ºå·²èµï¼›0 è¡¨ç¤ºæœªèµ
    return redisTemplate.opsForSet().isMember(entityLikeKey, userId) ? 1 : 0;
&#125;
</code></pre>
<h2 id="åˆ›å»ºè¡¨ç°å±‚çš„ -LikeController- ç±»"><a href="# åˆ›å»ºè¡¨ç°å±‚çš„ -LikeController- ç±»" class="headerlink" title="åˆ›å»ºè¡¨ç°å±‚çš„ LikeController ç±»"></a>åˆ›å»ºè¡¨ç°å±‚çš„ LikeController ç±»</h2><ul>
<li>æ³¨å…¥ <code>LikeService</code> å’Œ <code>HostHolder</code> å®ä¾‹</li>
<li>æ–°å¢æ–¹æ³• <code>like()</code>ï¼šå®ç°ç‚¹èµåŠŸèƒ½ï¼Œè°ƒç”¨ä¸šåŠ¡å±‚çš„æ–¹æ³• <code>like()</code> è¿›è¡Œç‚¹èµï¼Œè°ƒç”¨ <code>findEntityLikeCount()</code> å’Œ <code>findEntityLikeStatus()</code> æŸ¥è¯¢ç‚¹èµæ•°å’Œç‚¹èµçŠ¶æ€ï¼Œå¹¶å°è£…åˆ° map é›†åˆä¸­ï¼Œç„¶åé€šè¿‡å·¥å…·ç±»å°è£…æˆ JSON æ•°æ®è¿”å›ã€‚</li>
</ul>
<pre><code class="java">@Controller
public class LikeController &#123;
    @Autowired
    private LikeService likeService;

    @Autowired
    private HostHolder hostHolder;

    @PostMapping(&quot;/like&quot;)
    @ResponseBody
    public String like(int entityType, int entityId) &#123;
        User user = hostHolder.getUser();
        // ç‚¹èµ
        likeService.like(user.getId(), entityType, entityId);
        // æ•°é‡
        long likeCount = likeService.findEntityLikeCount(entityType, entityId);
        // çŠ¶æ€
        int likeStatus = likeService.findEntityLikeStatus(user.getId(), entityType, entityId);
        // è¿”å›çš„ç»“æœ
        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();
        map.put(&quot;likeCount&quot;, likeCount);
        map.put(&quot;likeStatus&quot;, likeStatus);

        return CommunityUtil.getJSONString(0, null, map);
    &#125;
&#125;
</code></pre>
<h2 id="æ›´æ–°è¡¨ç°å±‚çš„ -HomeController- ç±»"><a href="# æ›´æ–°è¡¨ç°å±‚çš„ -HomeController- ç±»" class="headerlink" title="æ›´æ–°è¡¨ç°å±‚çš„ HomeController ç±»"></a>æ›´æ–°è¡¨ç°å±‚çš„ HomeController ç±»</h2><ul>
<li><p>æ³¨å…¥  <code>LikeService</code> å®ä¾‹</p>
</li>
<li><p>æ›´æ–°æ–¹æ³•  <code>getIndexPage()</code>ï¼šæ–°å¢æ›´æ–°é¦–é¡µå¸–å­ç‚¹èµæ•°åŠŸèƒ½ï¼Œè°ƒç”¨ä¸šåŠ¡å±‚çš„ <code>LikeService</code> ç±»çš„æ–¹æ³•è·å¾—ç‚¹èµæ•°ï¼Œå¹¶å­˜å‚¨åˆ° map é›†åˆä¸­ã€‚</p>
</li>
</ul>
<pre><code class="java">@GetMapping(&quot;/index&quot;)
public String getIndexPage(Model model, Page page) &#123;
    // æ–¹æ³•è°ƒç”¨ä¹‹å‰ï¼ŒSpringMVC ä¼šè‡ªåŠ¨å®ä¾‹åŒ– Model å’Œ Pageï¼Œå¹¶å°† Page æ³¨å…¥åˆ° Model ä¸­ã€‚
    // æ‰€ä»¥ï¼Œåœ¨ thymeleaf ä¸­å¯ä»¥ç›´æ¥è®¿é—® Page å¯¹è±¡ä¸­çš„æ•°æ®ã€‚
    page.setRows(discussPostService.findDiscussPostRows(0));
    page.setPath(&quot;/index&quot;);

    List&lt;DiscussPost&gt; list = discussPostService.findDiscussPosts(0, page.getOffset(), page.getLimit());
    List&lt;Map&lt;String, Object&gt;&gt; discussPosts = new ArrayList&lt;&gt;();
    if (list != null) &#123;
        for (DiscussPost post : list) &#123;
            Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();
            map.put(&quot;post&quot;, post);
            User user = userService.findUserById(post.getUserId());
            map.put(&quot;user&quot;, user);

            long likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_POST, post.getId());
            map.put(&quot;likeCount&quot;, likeCount);

            discussPosts.add(map);
        &#125;
    &#125;
    model.addAttribute(&quot;discussPosts&quot;, discussPosts);
    return &quot;/index&quot;;
&#125;
</code></pre>
<h2 id="æ›´æ–°è¡¨ç°å±‚çš„ -DiscussPostController- ç±»"><a href="# æ›´æ–°è¡¨ç°å±‚çš„ -DiscussPostController- ç±»" class="headerlink" title="æ›´æ–°è¡¨ç°å±‚çš„ DiscussPostController ç±»"></a>æ›´æ–°è¡¨ç°å±‚çš„ DiscussPostController ç±»</h2><ul>
<li>æ³¨å…¥  <code>LikeService</code> å®ä¾‹</li>
<li>æ›´æ–°æ–¹æ³• <code>addDiscussPost()</code>ï¼šæ–°å¢æ›´æ–°è¯¦æƒ…é¡µå¸–å­ï¼ˆè¯„è®ºã€å›å¤ï¼‰çš„ç‚¹èµæ•°åŠŸèƒ½ï¼Œè°ƒç”¨ä¸šåŠ¡å±‚çš„ <code>LikeService</code> ç±»çš„æ–¹æ³•è·å¾—ç‚¹èµæ•°å’Œç‚¹èµçŠ¶æ€ï¼Œå¹¶å°†å…¶å­˜å…¥è§†å›¾å¯¹è±¡ä¸­ã€‚</li>
</ul>
<pre><code class="java">@GetMapping(&quot;/detail/&#123;discussPostId&#125;&quot;)
public String getDiscussPost(@PathVariable(&quot;discussPostId&quot;) int discussPostId, Model model, Page page) &#123;
    // å¸–å­
    DiscussPost post = discussPostService.findDiscussPostById(discussPostId);
    model.addAttribute(&quot;post&quot;, post);
    // ä½œè€…
    User user = userService.findUserById(post.getUserId());
    model.addAttribute(&quot;user&quot;, user);
    // ç‚¹èµæ•°é‡
    long likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_POST, discussPostId);
    model.addAttribute(&quot;likeCount&quot;, likeCount);
    // ç‚¹èµçŠ¶æ€
    int likeStatus = hostHolder.getUser() == null ? 0 :
            likeService.findEntityLikeStatus(hostHolder.getUser().getId(), ENTITY_TYPE_POST, discussPostId);
    model.addAttribute(&quot;likeStatus&quot;, likeStatus);

    // è¯„è®ºåˆ†é¡µä¿¡æ¯
    page.setLimit(5);
    page.setPath(&quot;/discuss/detail/&quot; + discussPostId);
    page.setRows(post.getCommentCount());

    // è¯„è®º: ç»™å¸–å­çš„è¯„è®º
    // å›å¤: ç»™è¯„è®ºçš„è¯„è®º
    // è¯„è®ºåˆ—è¡¨
    List&lt;Comment&gt; commentList = commentService.findCommentsByEntity(ENTITY_TYPE_POST, post.getId(), page.getOffset(), page.getLimit());
    // è¯„è®º VO åˆ—è¡¨
    List&lt;Map&lt;String, Object&gt;&gt; commentVoList = new ArrayList&lt;&gt;();
    if (commentList != null) &#123;
        for (Comment comment : commentList) &#123;
            // è¯„è®º VO
            Map&lt;String, Object&gt; commentVo = new HashMap&lt;&gt;();
            // è¯„è®º
            commentVo.put(&quot;comment&quot;, comment);
            // ä½œè€…
            commentVo.put(&quot;user&quot;, userService.findUserById(comment.getUserId()));
            // ç‚¹èµæ•°é‡
            likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_COMMENT, comment.getId());
            commentVo.put(&quot;likeCount&quot;, likeCount);
            // ç‚¹èµçŠ¶æ€
            likeStatus = hostHolder.getUser() == null ? 0 :
                    likeService.findEntityLikeStatus(hostHolder.getUser().getId(), ENTITY_TYPE_COMMENT, comment.getId());
            commentVo.put(&quot;likeStatus&quot;, likeStatus);

            // å›å¤åˆ—è¡¨
            List&lt;Comment&gt; replyList = commentService.findCommentsByEntity(ENTITY_TYPE_COMMENT, comment.getId(), 0, Integer.MAX_VALUE);
            // å›å¤ VO åˆ—è¡¨
            List&lt;Map&lt;String, Object&gt;&gt; replyVoList = new ArrayList&lt;&gt;();
            if (replyList != null) &#123;
                for (Comment reply : replyList) &#123;
                    Map&lt;String, Object&gt; replyVo = new HashMap&lt;&gt;();
                    // å›å¤
                    replyVo.put(&quot;reply&quot;, reply);
                    // ä½œè€…
                    replyVo.put(&quot;user&quot;, userService.findUserById(reply.getUserId()));
                    // å›å¤ç›®æ ‡
                    User target = reply.getTargetId() == 0 ? null : userService.findUserById(reply.getTargetId());
                    replyVo.put(&quot;target&quot;, target);
                    // ç‚¹èµæ•°é‡
                    likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_COMMENT, reply.getId());
                    replyVo.put(&quot;likeCount&quot;, likeCount);
                    // ç‚¹èµçŠ¶æ€
                    likeStatus = hostHolder.getUser() == null ? 0 :
                            likeService.findEntityLikeStatus(hostHolder.getUser().getId(), ENTITY_TYPE_COMMENT, reply.getId());
                    replyVo.put(&quot;likeStatus&quot;, likeStatus);

                    replyVoList.add(replyVo);
                &#125;
            &#125;
            commentVo.put(&quot;replys&quot;, replyVoList);

            // å›å¤æ•°é‡
            int replyCount = commentService.findCommentCount(ENTITY_TYPE_COMMENT, comment.getId());
            commentVo.put(&quot;replyCount&quot;, replyCount);

            commentVoList.add(commentVo);
        &#125;
    &#125;

    model.addAttribute(&quot;comments&quot;, commentVoList);

    return &quot;/site/discuss-detail&quot;;
&#125;
</code></pre>
<h1 id="2- æ”¶åˆ°çš„èµ"><a href="#2- æ”¶åˆ°çš„èµ" class="headerlink" title="2. æ”¶åˆ°çš„èµ"></a>2. æ”¶åˆ°çš„èµ</h1><ol>
<li>é‡æ„ç‚¹èµåŠŸèƒ½ï¼šä»¥ç”¨æˆ·ä¸º keyï¼Œè®°å½•ç‚¹èµæ•°é‡ï¼›<code>increment(key)</code>ã€<code>decrement(key)</code></li>
<li>å¼€å‘ä¸ªäººä¸»é¡µï¼šä»¥ç”¨æˆ·ä¸º keyï¼ŒæŸ¥è¯¢ç‚¹èµæ•°ã€‚</li>
</ol>
<h2 id="æ›´æ–°å·¥å…·ç±» -RedisUtil"><a href="# æ›´æ–°å·¥å…·ç±» -RedisUtil" class="headerlink" title="æ›´æ–°å·¥å…·ç±» RedisUtil"></a>æ›´æ–°å·¥å…·ç±» RedisUtil</h2><ul>
<li><p>æ–°å¢ç”¨æˆ·è·å¾—èµ key çš„å‰ç¼€å¸¸é‡ <code>like:user</code></p>
</li>
<li><p>æ–°å¢æ–¹æ³• <code>getUserLikeKey(int userId)</code>ï¼Œé€šè¿‡ç”¨æˆ· id ç”Ÿæˆå¯¹åº”ç”¨æˆ·è·å¾—èµçš„ keyã€‚</p>
</li>
</ul>
<pre><code class="java">public class RedisKeyUtil &#123;
    private static final String SPLIT = &quot;:&quot;;
    private static final String PREFIX_ENTITY_LIKE = &quot;like:entity&quot;;
    private static final String PREFIX_USER_LIKE = &quot;like:user&quot;;

    // æŸä¸ªå®ä½“çš„èµ
    // like:entity:entityType:entityId -&gt; set(userId)
    public static String getEntityLikeKey(int entityType, int entityId) &#123;
        return PREFIX_ENTITY_LIKE + SPLIT + entityType + SPLIT + entityId;
    &#125;

    // æŸä¸ªç”¨æˆ·çš„èµ
    // like:user:userId -&gt; int
    public static String getUserLikeKey(int userId) &#123;
        return PREFIX_USER_LIKE + SPLIT + userId;
    &#125;
&#125;
</code></pre>
<h2 id="æ›´æ–°ä¸šåŠ¡å±‚çš„ -LikeService ç±»"><a href="# æ›´æ–°ä¸šåŠ¡å±‚çš„ -LikeService ç±»" class="headerlink" title="æ›´æ–°ä¸šåŠ¡å±‚çš„ LikeService ç±»"></a>æ›´æ–°ä¸šåŠ¡å±‚çš„ LikeService ç±»</h2><ul>
<li>é‡æ„æ–¹æ³• <code>like()</code>ï¼Œåœ¨å‚æ•°åˆ—è¡¨ä¸­æ–°å¢ï¼šentityUserIdï¼ˆè¡¨ç¤ºè¢«ç‚¹èµç”¨æˆ·çš„ idï¼‰ï¼Œè¯¥å‚æ•°ç”¨æ¥æ›´æ–°ç”¨æˆ·çš„è¢«ç‚¹èµæ•°é‡ã€‚<ul>
<li>è°ƒç”¨ <code>RedisTemplate</code> å®ä¾‹çš„æ–¹æ³• <code>execute()</code> å®ç°äº‹åŠ¡ï¼Œä¿è¯è¢«ç‚¹èµç”¨æˆ·ä¸ç‚¹èµç”¨æˆ·çš„æ•°æ®æ›´æ–°ä¿æŒä¸€è‡´ã€‚è°ƒç”¨ <code>isMember()</code> æŸ¥è¯¢ç”¨æˆ·çš„ç‚¹èµçŠ¶æ€ï¼Œä¹‹åè°ƒç”¨ <code>multi()</code> å¼€å¯äº‹åŠ¡ã€‚</li>
<li>å½“ç”¨æˆ·å·²ç‚¹èµæ—¶ï¼Œè°ƒç”¨æ–¹æ³• <code>remove()</code> å°†å½“å‰ç”¨æˆ·ä»ç‚¹èµçš„ç”¨æˆ·é›†åˆä¸­ç§»é™¤ï¼Œè°ƒç”¨æ–¹æ³• <code>decrement()</code> å°†è¢«ç‚¹èµç”¨æˆ·çš„è¢«ç‚¹èµæ•°å‡å» 1ï¼›å½“ç”¨æˆ·æœªç‚¹èµæ—¶ï¼Œè°ƒç”¨æ–¹æ³• <code>add()</code> å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ°ç‚¹èµçš„ç”¨æˆ·é›†åˆä¸­ï¼Œè°ƒç”¨æ–¹æ³• <code>increment()</code> å°†è¢«ç‚¹èµç”¨æˆ·çš„ç‚¹èµæ•°åŠ ä¸Š 1ã€‚</li>
</ul>
</li>
<li>æ–°å¢æ–¹æ³• <code>findUserLikeCount()</code>ï¼Œä»¥ç”¨æˆ· id ä¸º keyï¼Œè°ƒç”¨æ–¹æ³• <code>get()</code> æŸ¥è¯¢ç”¨æˆ·æ‰€è·ç‚¹èµæ•°ã€‚</li>
</ul>
<pre><code class="java">@Service
public class LikeService &#123;
    @Autowired
    private RedisTemplate redisTemplate;

    // ç‚¹èµ
    public void like(int userId, int entityType, int entityId, int entityUserId) &#123;
        redisTemplate.execute(new SessionCallback() &#123;
            @Override
            public Object execute(RedisOperations operations) throws DataAccessException &#123;
                String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);
                String userLikeKey = RedisKeyUtil.getUserLikeKey(entityUserId);

                boolean isMember = operations.opsForSet().isMember(entityLikeKey, userId);

                operations.multi();

                if (isMember) &#123;
                    operations.opsForSet().remove(entityLikeKey, userId);
                    operations.opsForValue().decrement(userLikeKey);
                &#125; else &#123;
                    operations.opsForSet().add(entityLikeKey, userId);
                    operations.opsForValue().increment(userLikeKey);
                &#125;
                return operations.exec();
            &#125;
        &#125;);
    &#125;

    // æŸ¥è¯¢æŸå®ä½“ç‚¹èµçš„æ•°é‡
    public long findEntityLikeCount(int entityType, int entityId) &#123;
        String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);
        return redisTemplate.opsForSet().size(entityLikeKey);
    &#125;

    // æŸ¥è¯¢æŸäººå¯¹æŸå®ä½“çš„ç‚¹èµçŠ¶æ€
    public int findEntityLikeStatus(int userId, int entityType, int entityId) &#123;
        String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);
        return redisTemplate.opsForSet().isMember(entityLikeKey, userId) ? 1 : 0;
    &#125;

    // æŸ¥è¯¢æŸä¸ªç”¨æˆ·è·å¾—çš„èµ
    public int findUserLikeCount(int userId) &#123;
        String userLikeKey = RedisKeyUtil.getUserLikeKey(userId);
        Integer count = (Integer) redisTemplate.opsForValue().get(userLikeKey);
        return count == null ? 0 : count.intValue();
    &#125;
&#125;
</code></pre>
<h2 id="æ›´æ–°è¡¨ç°å±‚çš„ -LikeController- ç±»"><a href="# æ›´æ–°è¡¨ç°å±‚çš„ -LikeController- ç±»" class="headerlink" title="æ›´æ–°è¡¨ç°å±‚çš„ LikeController ç±»"></a>æ›´æ–°è¡¨ç°å±‚çš„ LikeController ç±»</h2><ul>
<li>æ›´æ–°æ–¹æ³• <code>like()</code>ï¼šåœ¨å‚æ•°åˆ—è¡¨ä¸­æ–°å¢å‚æ•° entityUserIdï¼ˆè¡¨ç¤ºè¢«ç‚¹èµç”¨æˆ·çš„ idï¼‰ã€‚</li>
</ul>
<pre><code class="java">@Controller
public class LikeController &#123;
    @Autowired
    private LikeService likeService;

    @Autowired
    private HostHolder hostHolder;

    @PostMapping(&quot;/like&quot;)
    @ResponseBody
    public String like(int entityType, int entityId, int entityUserId) &#123;
        User user = hostHolder.getUser();

        // ç‚¹èµ
        likeService.like(user.getId(), entityType, entityId, entityUserId);

        // æ•°é‡
        long likeCount = likeService.findEntityLikeCount(entityType, entityId);
        // çŠ¶æ€
        int likeStatus = likeService.findEntityLikeStatus(user.getId(), entityType, entityId);
        // è¿”å›çš„ç»“æœ
        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();
        map.put(&quot;likeCount&quot;, likeCount);
        map.put(&quot;likeStatus&quot;, likeStatus);

        return CommunityUtil.getJSONString(0, null, map);
    &#125;

&#125;
</code></pre>
<h2 id="æ›´æ–°è¡¨ç°å±‚çš„ -UserController- ç±»"><a href="# æ›´æ–°è¡¨ç°å±‚çš„ -UserController- ç±»" class="headerlink" title="æ›´æ–°è¡¨ç°å±‚çš„ UserController ç±»"></a>æ›´æ–°è¡¨ç°å±‚çš„ UserController ç±»</h2><ul>
<li>æ–°å¢æ–¹æ³•<code>getProfilePage()</code>ï¼šè°ƒç”¨ä¸šåŠ¡å±‚çš„æ–¹æ³•æŸ¥è¯¢ç”¨æˆ·å’Œç‚¹èµæ•°ï¼Œå¹¶å°†ä¸¤é¡¹ä¿¡æ¯å­˜å‚¨äº Model å¯¹è±¡ä¸­ã€‚</li>
</ul>
<pre><code class="java">// ä¸ªäººä¸»é¡µ
@RequestMapping(path = &quot;/profile/&#123;userId&#125;&quot;, method = RequestMethod.GET)
public String getProfilePage(@PathVariable(&quot;userId&quot;) int userId, Model model) &#123;
    User user = userService.findUserById(userId);
    if (user == null) &#123;
        throw new RuntimeException(&quot; è¯¥ç”¨æˆ·ä¸å­˜åœ¨!&quot;);
    &#125;

    // ç”¨æˆ·
    model.addAttribute(&quot;user&quot;, user);
    // ç‚¹èµæ•°é‡
    int likeCount = likeService.findUserLikeCount(userId);
    model.addAttribute(&quot;likeCount&quot;, likeCount);

    return &quot;/site/profile&quot;;
&#125;
</code></pre>
<h1 id="3- å…³æ³¨"><a href="#3- å…³æ³¨" class="headerlink" title="3. å…³æ³¨"></a>3. å…³æ³¨ </h1><h2 id="æ›´æ–°å·¥å…·ç±» -RedisUtil-1"><a href="# æ›´æ–°å·¥å…·ç±» -RedisUtil-1" class="headerlink" title="æ›´æ–°å·¥å…·ç±» RedisUtil"></a> æ›´æ–°å·¥å…·ç±» RedisUtil</h2><ul>
<li>æ–°å¢ç”¨æˆ·å…³æ³¨å®ä½“ï¼ˆå¸–å­ã€è¯„è®ºã€ç”¨æˆ·ç­‰ï¼‰çš„å‰ç¼€å¸¸é‡ followee å’Œç²‰ä¸ï¼ˆç”¨æˆ·ï¼‰çš„å‰ç¼€å¸¸é‡ followerã€‚</li>
<li>æ–°å¢æ–¹æ³• <code>getFolloweeKey(int userId, int entityType)</code>ï¼Œé€šè¿‡ç”¨æˆ· id å’Œå®ä½“ç±»å‹ç”Ÿæˆç”¨æˆ·å…³æ³¨å®ä½“çš„ keyã€‚</li>
<li>æ–°å¢æ–¹æ³• <code>getFollowerKey(int entityType, int entityId)</code>ï¼Œé€šè¿‡å®ä½“ç±»å‹å’Œå®ä½“ id ç”Ÿæˆå®ä½“ç”¨æˆ·ç²‰ä¸çš„ keyã€‚</li>
</ul>
<pre><code class="java">public class RedisKeyUtil &#123;
    private static final String SPLIT = &quot;:&quot;;
    private static final String PREFIX_ENTITY_LIKE = &quot;like:entity&quot;;
    private static final String PREFIX_USER_LIKE = &quot;like:user&quot;;
    private static final String PREFIX_FOLLOWEE = &quot;followee&quot;;
    private static final String PREFIX_FOLLOWER = &quot;follower&quot;;

    // æŸä¸ªå®ä½“çš„èµ
    // like:entity:entityType:entityId -&gt; set(userId)
    public static String getEntityLikeKey(int entityType, int entityId) &#123;
        return PREFIX_ENTITY_LIKE + SPLIT + entityType + SPLIT + entityId;
    &#125;

    // æŸä¸ªç”¨æˆ·çš„èµ
    // like:user:userId -&gt; int
    public static String getUserLikeKey(int userId) &#123;
        return PREFIX_USER_LIKE + SPLIT + userId;
    &#125;

    // æŸä¸ªç”¨æˆ·å…³æ³¨çš„å®ä½“
    // followee:userId:entityType -&gt; zset(entityId,now)
    public static String getFolloweeKey(int userId, int entityType) &#123;
        return PREFIX_FOLLOWEE + SPLIT + userId + SPLIT + entityType;
    &#125;

    // æŸä¸ªå®ä½“æ‹¥æœ‰çš„ç²‰ä¸
    // follower:entityType:entityId -&gt; zset(userId,now)
    public static String getFollowerKey(int entityType, int entityId) &#123;
        return PREFIX_FOLLOWER + SPLIT + entityType + SPLIT + entityId;
    &#125;
&#125;
</code></pre>
<h2 id="åˆ›å»ºä¸šåŠ¡å±‚çš„ -FollowService- ç±»"><a href="# åˆ›å»ºä¸šåŠ¡å±‚çš„ -FollowService- ç±»" class="headerlink" title="åˆ›å»ºä¸šåŠ¡å±‚çš„ FollowService ç±»"></a>åˆ›å»ºä¸šåŠ¡å±‚çš„ FollowService ç±»</h2><ul>
<li><p>æ–°å¢æ–¹æ³• <code>follow()</code>ï¼Œå½“ç”¨æˆ·å…³æ³¨æŸå®ä½“æ—¶ï¼š</p>
<ul>
<li>è°ƒç”¨æ–¹æ³• <code>add() </code>å°†å½“å‰å®ä½“ id å’Œæ—¶é—´ä½œä¸º value å’Œ score åŠ å…¥åˆ°ç”¨æˆ·çš„å…³æ³¨é›†åˆä¸­ã€‚</li>
<li>è°ƒç”¨æ–¹æ³• <code>add()</code> å°†å½“å‰ç”¨æˆ· id å’Œæ—¶é—´ä½œä¸º value å’Œ score åŠ å…¥åˆ°å®ä½“çš„ç²‰ä¸é›†åˆä¸­ã€‚</li>
</ul>
</li>
<li><p>æ–°å¢æ–¹æ³• <code>unfollow()</code>ï¼Œå½“ç”¨æˆ·å–å…³æŸå®ä½“æ—¶ï¼š</p>
<ul>
<li>è°ƒç”¨æ–¹æ³• <code>remove()</code> å°†å½“å‰å®ä½“ä»ç”¨æˆ·çš„å…³æ³¨é›†åˆä¸­ç§»é™¤ã€‚</li>
<li>è°ƒç”¨æ–¹æ³• <code>remove()</code> å°†ç”¨æˆ·ä»å®ä½“çš„ç²‰ä¸é›†åˆä¸­ç§»é™¤ã€‚</li>
</ul>
</li>
</ul>
<pre><code class="java">@Service
public class FollowService &#123;
    @Autowired
    private RedisTemplate redisTemplate;

    public void follow(int userId, int entityType, int entityId) &#123;
        redisTemplate.execute(new SessionCallback() &#123;
            @Override
            public Object execute(RedisOperations operations) throws DataAccessException &#123;
                String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);
                String followerKey = RedisKeyUtil.getFollowerKey(entityType, entityId);

                operations.multi();

                operations.opsForZSet().add(followeeKey, entityId, System.currentTimeMillis());
                operations.opsForZSet().add(followerKey, userId, System.currentTimeMillis());

                return operations.exec();
            &#125;
        &#125;);
    &#125;

    public void unfollow(int userId, int entityType, int entityId) &#123;
        redisTemplate.execute(new SessionCallback() &#123;
            @Override
            public Object execute(RedisOperations operations) throws DataAccessException &#123;
                String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);
                String followerKey = RedisKeyUtil.getFollowerKey(entityType, entityId);

                operations.multi();

                operations.opsForZSet().remove(followeeKey, entityId);
                operations.opsForZSet().remove(followerKey, userId);

                return operations.exec();
            &#125;
        &#125;);
    &#125;
&#125;
</code></pre>
<h2 id="åˆ›å»ºè¡¨ç°å±‚çš„ -FollowController"><a href="# åˆ›å»ºè¡¨ç°å±‚çš„ -FollowController" class="headerlink" title="åˆ›å»ºè¡¨ç°å±‚çš„ FollowController"></a>åˆ›å»ºè¡¨ç°å±‚çš„ FollowController</h2><ul>
<li>æ–°å¢æ–¹æ³• <code>follow()</code>ï¼šè°ƒç”¨ HostHolder å¯¹è±¡çš„æ–¹æ³•è·å–ç”¨æˆ·ï¼Œè°ƒç”¨ä¸šåŠ¡å±‚çš„ <code>FollowService</code> ç±»çš„å¯¹è±¡çš„æ–¹æ³• <code>follow()</code> å®ç°ç‚¹èµçš„åŠŸèƒ½ã€‚</li>
<li>æ–°å¢æ–¹æ³• <code>unfollow()</code>ï¼šè°ƒç”¨ HostHolder å¯¹è±¡çš„æ–¹æ³•è·å–ç”¨æˆ·ï¼Œè°ƒç”¨ä¸šåŠ¡å±‚çš„ <code>FollowService</code> ç±»çš„å¯¹è±¡çš„æ–¹æ³• <code>unfollow()</code> å®ç°å–æ¶ˆç‚¹èµçš„åŠŸèƒ½ã€‚</li>
</ul>
<pre><code class="java">@Controller
public class FollowController &#123;
    @Autowired
    private FollowService followService;

    @Autowired
    private HostHolder hostHolder;

    @PostMapping(&quot;/follow&quot;)
    @ResponseBody
    public String follow(int entityType, int entityId) &#123;
        User user = hostHolder.getUser();

        followService.follow(user.getId(), entityType, entityId);

        return CommunityUtil.getJSONString(0, &quot; å·²å…³æ³¨!&quot;);
    &#125;

    @PostMapping(&quot;/unfollow&quot;)
    @ResponseBody
    public String unfollow(int entityType, int entityId) &#123;
        User user = hostHolder.getUser();

        followService.unfollow(user.getId(), entityType, entityId);

        return CommunityUtil.getJSONString(0, &quot; å·²å–æ¶ˆå…³æ³¨!&quot;);
    &#125;
&#125;
</code></pre>
<h1 id="4- ä¸ªäººä¸»é¡µ"><a href="#4- ä¸ªäººä¸»é¡µ" class="headerlink" title="4. ä¸ªäººä¸»é¡µ"></a>4. ä¸ªäººä¸»é¡µ </h1><h2 id="æ›´æ–°ä¸šåŠ¡å±‚çš„ -FollowService- ç±»"><a href="# æ›´æ–°ä¸šåŠ¡å±‚çš„ -FollowService- ç±»" class="headerlink" title="æ›´æ–°ä¸šåŠ¡å±‚çš„ FollowService ç±»"></a> æ›´æ–°ä¸šåŠ¡å±‚çš„ FollowService ç±»</h2><ul>
<li><p>æ–°å¢æ–¹æ³• <code>findFolloweeCount()</code>ï¼Œè°ƒç”¨ zset é›†åˆçš„æ–¹æ³• <code>zcard()</code> æŸ¥è¯¢æŸç”¨æˆ·å…³æ³¨çš„å®ä½“æ•°é‡ã€‚</p>
</li>
<li><p>æ–°å¢æ–¹æ³• <code>findFollowerCount()</code>ï¼Œè°ƒç”¨ zset é›†åˆçš„æ–¹æ³• <code>zcard()</code> æŸ¥è¯¢æŸå®ä½“çš„ç²‰ä¸æ•°é‡ã€‚</p>
</li>
<li><p>æ–°å¢æ–¹æ³• <code>hasFollowed()</code>ï¼Œæ ¹æ® zset é›†åˆçš„æ–¹æ³• <code>zscore()</code> çš„è¿”å›å€¼æŸ¥è¯¢å½“å‰ç”¨æˆ·æ˜¯å¦å…³æ³¨äº†æŸå®ä½“ã€‚</p>
</li>
</ul>
<pre><code class="java">// æŸ¥è¯¢å…³æ³¨çš„å®ä½“çš„æ•°é‡
public long findFolloweeCount(int userId, int entityType) &#123;
    String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);
    return redisTemplate.opsForZSet().zCard(followeeKey);
&#125;

// æŸ¥è¯¢å®ä½“çš„ç²‰ä¸çš„æ•°é‡
public long findFollowerCount(int entityType, int entityId) &#123;
    String followerKey = RedisKeyUtil.getFollowerKey(entityType, entityId);
    return redisTemplate.opsForZSet().zCard(followerKey);
&#125;

// æŸ¥è¯¢å½“å‰ç”¨æˆ·æ˜¯å¦å·²å…³æ³¨è¯¥å®ä½“
public boolean hasFollowed(int userId, int entityType, int entityId) &#123;
    String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);
    return redisTemplate.opsForZSet().score(followeeKey, entityId) != null;
&#125;
</code></pre>
<h2 id="æ›´æ–°è¡¨ç°å±‚çš„ -UserController- ç±» -1"><a href="# æ›´æ–°è¡¨ç°å±‚çš„ -UserController- ç±» -1" class="headerlink" title="æ›´æ–°è¡¨ç°å±‚çš„ UserController ç±»"></a>æ›´æ–°è¡¨ç°å±‚çš„ UserController ç±»</h2><ul>
<li><p>è°ƒç”¨ä¸šåŠ¡å±‚çš„ <code>LikeService</code> ç±»ä¸­çš„æ–¹æ³• <code>findUserLikeCount()</code> æŸ¥è¯¢ç”¨æˆ·è·èµæ•°ï¼Œå¹¶æ·»åŠ åˆ° Model ä¸­ã€‚</p>
</li>
<li><p>è°ƒç”¨ä¸šåŠ¡å±‚çš„ <code>FollowService</code> ç±»ä¸­çš„æ–¹æ³• <code>findFolloweeCount()</code> æŸ¥è¯¢å…³æ³¨æ•°é‡ï¼Œè°ƒç”¨æ–¹æ³• <code>findFollowerCount()</code> æŸ¥è¯¢ç²‰ä¸æ•°é‡ï¼Œè°ƒç”¨æ–¹æ³• <code>hasFollowed()</code> æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å…³æ³¨ï¼Œå¹¶å°†ä¸‰é¡¹ä¿¡æ¯å­˜å‚¨äº Model å¯¹è±¡ä¸­ã€‚</p>
</li>
<li><p>æ›´æ–°è·å–ä¸ªäººä¸»é¡µæ–¹æ³• <code>getProfilePage()</code>ï¼šæ–°å¢å…³æ³¨æ•°ã€ç²‰ä¸æ•°ã€åˆ¤æ–­æ˜¯å¦å·²å…³æ³¨ï¼Œå¹¶å°†ä¸‰é¡¹ä¿¡æ¯å­˜å‚¨äº Model å¯¹è±¡ä¸­ã€‚</p>
</li>
</ul>
<pre><code class="java">// ä¸ªäººä¸»é¡µ
@RequestMapping(path = &quot;/profile/&#123;userId&#125;&quot;, method = RequestMethod.GET)
public String getProfilePage(@PathVariable(&quot;userId&quot;) int userId, Model model) &#123;
    User user = userService.findUserById(userId);
    if (user == null) &#123;
        throw new RuntimeException(&quot; è¯¥ç”¨æˆ·ä¸å­˜åœ¨!&quot;);
    &#125;

    // ç”¨æˆ·
    model.addAttribute(&quot;user&quot;, user);
    // ç‚¹èµæ•°é‡
    int likeCount = likeService.findUserLikeCount(userId);
    model.addAttribute(&quot;likeCount&quot;, likeCount);

    // å…³æ³¨æ•°é‡
    long followeeCount = followService.findFolloweeCount(userId, ENTITY_TYPE_USER);
    model.addAttribute(&quot;followeeCount&quot;, followeeCount);
    // ç²‰ä¸æ•°é‡
    long followerCount = followService.findFollowerCount(ENTITY_TYPE_USER, userId);
    model.addAttribute(&quot;followerCount&quot;, followerCount);
    // æ˜¯å¦å·²å…³æ³¨
    boolean hasFollowed = false;
    if (hostHolder.getUser() != null) &#123;
        hasFollowed = followService.hasFollowed(hostHolder.getUser().getId(), ENTITY_TYPE_USER, userId);
    &#125;
    model.addAttribute(&quot;hasFollowed&quot;, hasFollowed);

    return &quot;/site/profile&quot;;
&#125;
</code></pre>
<h1 id="5- å…³æ³¨åˆ—è¡¨å’Œç²‰ä¸åˆ—è¡¨"><a href="#5- å…³æ³¨åˆ—è¡¨å’Œç²‰ä¸åˆ—è¡¨" class="headerlink" title="5. å…³æ³¨åˆ—è¡¨å’Œç²‰ä¸åˆ—è¡¨"></a>5. å…³æ³¨åˆ—è¡¨å’Œç²‰ä¸åˆ—è¡¨ </h1><h2 id="æ›´æ–°ä¸šåŠ¡å±‚çš„ -FollowService- ç±» -1"><a href="# æ›´æ–°ä¸šåŠ¡å±‚çš„ -FollowService- ç±» -1" class="headerlink" title="æ›´æ–°ä¸šåŠ¡å±‚çš„ FollowService ç±»"></a> æ›´æ–°ä¸šåŠ¡å±‚çš„ FollowService ç±»</h2><ul>
<li><p>æ–°å¢æ–¹æ³• <code>findFollowees()</code>ï¼šæŸ¥è¯¢ç”¨æˆ·å…³æ³¨åˆ—è¡¨ã€‚é€šè¿‡ zset é›†åˆçš„æ–¹æ³• <code>reverseRange()</code> è·å– value å³å…³æ³¨ç”¨æˆ·çš„ userIdï¼Œå†æŸ¥è¯¢å‡ºå…¶å¯¹åº”çš„ userï¼Œä¹‹åé€šè¿‡ score è·å–å…³æ³¨æ—¶é—´ï¼Œå­˜å…¥ map é›†åˆä¸­ï¼Œå°† map æ·»åŠ åˆ° list åˆ—è¡¨ä¸­å¹¶è¿”å›ã€‚</p>
</li>
<li><p>æ–°å¢æ–¹æ³• <code>findFollowers()</code>ï¼šæŸ¥è¯¢ç”¨æˆ·ç²‰ä¸åˆ—è¡¨ã€‚é€šè¿‡ zset é›†åˆçš„æ–¹æ³• <code>reverseRange()</code> è·å– value å³ç²‰ä¸çš„ userIdï¼Œå†æŸ¥è¯¢å‡ºå…¶å¯¹åº”çš„ userï¼Œä¹‹åé€šè¿‡ score è·å–å…³æ³¨æ—¶é—´ï¼Œå­˜å…¥ map é›†åˆä¸­ï¼Œå°† map æ·»åŠ åˆ° list åˆ—è¡¨ä¸­å¹¶è¿”å›ã€‚</p>
</li>
<li><p>æ–°å¢æ–¹æ³• <code>hasFollowed()</code>ï¼Œæ ¹æ® zset é›†åˆçš„æ–¹æ³• <code>zscore()</code> çš„è¿”å›å€¼æŸ¥è¯¢å½“å‰ç”¨æˆ·æ˜¯å¦å…³æ³¨äº†æŸå®ä½“ã€‚</p>
</li>
</ul>
<pre><code class="java">// æŸ¥è¯¢æŸç”¨æˆ·å…³æ³¨çš„äºº
public List&lt;Map&lt;String, Object&gt;&gt; findFollowees(int userId, int offset, int limit) &#123;
    String followeeKey = RedisKeyUtil.getFolloweeKey(userId, ENTITY_TYPE_USER);
    Set&lt;Integer&gt; targetIds = redisTemplate.opsForZSet().reverseRange(followeeKey, offset, offset + limit - 1);

    if (targetIds == null) &#123;
        return null;
    &#125;

    List&lt;Map&lt;String, Object&gt;&gt; list = new ArrayList&lt;&gt;();
    for (Integer targetId : targetIds) &#123;
        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();
        User user = userService.findUserById(targetId);
        map.put(&quot;user&quot;, user);
        Double score = redisTemplate.opsForZSet().score(followeeKey, targetId);
        map.put(&quot;followTime&quot;, new Date(score.longValue()));
        list.add(map);
    &#125;

    return list;
&#125;

// æŸ¥è¯¢æŸç”¨æˆ·çš„ç²‰ä¸
public List&lt;Map&lt;String, Object&gt;&gt; findFollowers(int userId, int offset, int limit) &#123;
    String followerKey = RedisKeyUtil.getFollowerKey(ENTITY_TYPE_USER, userId);
    Set&lt;Integer&gt; targetIds = redisTemplate.opsForZSet().reverseRange(followerKey, offset, offset + limit - 1);

    if (targetIds == null) &#123;
        return null;
    &#125;

    List&lt;Map&lt;String, Object&gt;&gt; list = new ArrayList&lt;&gt;();
    for (Integer targetId : targetIds) &#123;
        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();
        User user = userService.findUserById(targetId);
        map.put(&quot;user&quot;, user);
        Double score = redisTemplate.opsForZSet().score(followerKey, targetId);
        map.put(&quot;followTime&quot;, new Date(score.longValue()));
        list.add(map);
    &#125;

    return list;
&#125;
</code></pre>
<h2 id="æ›´æ–°è¡¨ç°å±‚çš„ -FollowController- ç±»"><a href="# æ›´æ–°è¡¨ç°å±‚çš„ -FollowController- ç±»" class="headerlink" title="æ›´æ–°è¡¨ç°å±‚çš„ FollowController ç±»"></a>æ›´æ–°è¡¨ç°å±‚çš„ FollowController ç±»</h2><ul>
<li>æ–°å¢æ–¹æ³• <code>getFollowees()</code>ï¼Œè·å–å…³æ³¨åˆ—è¡¨ï¼Œå­˜å…¥ Model å¯¹è±¡ä¸­ã€‚</li>
<li>æ–°å¢æ–¹æ³• <code>getFollowers()</code>ï¼Œè·å–ç²‰ä¸åˆ—è¡¨ï¼Œå­˜å…¥ Model å¯¹è±¡ä¸­ã€‚</li>
</ul>
<pre><code class="java">@GetMapping(&quot;/followees/&#123;userId&#125;&quot;)
public String getFollowees(@PathVariable(&quot;userId&quot;) int userId, Page page, Model model) &#123;
    User user = userService.findUserById(userId);
    if (user == null) &#123;
        throw new RuntimeException(&quot; è¯¥ç”¨æˆ·ä¸å­˜åœ¨!&quot;);
    &#125;
    model.addAttribute(&quot;user&quot;, user);

    page.setLimit(5);
    page.setPath(&quot;/followees/&quot; + userId);
    page.setRows((int) followService.findFolloweeCount(userId, ENTITY_TYPE_USER));

    List&lt;Map&lt;String, Object&gt;&gt; userList = followService.findFollowees(userId, page.getOffset(), page.getLimit());
    if (userList != null) &#123;
        for (Map&lt;String, Object&gt; map : userList) &#123;
            User u = (User) map.get(&quot;user&quot;);
            map.put(&quot;hasFollowed&quot;, hasFollowed(u.getId()));
        &#125;
    &#125;
    model.addAttribute(&quot;users&quot;, userList);

    return &quot;/site/followee&quot;;
&#125;

@GetMapping(&quot;/followers/&#123;userId&#125;&quot;)
public String getFollowers(@PathVariable(&quot;userId&quot;) int userId, Page page, Model model) &#123;
    User user = userService.findUserById(userId);
    if (user == null) &#123;
        throw new RuntimeException(&quot; è¯¥ç”¨æˆ·ä¸å­˜åœ¨!&quot;);
    &#125;
    model.addAttribute(&quot;user&quot;, user);

    page.setLimit(5);
    page.setPath(&quot;/followers/&quot; + userId);
    page.setRows((int) followService.findFollowerCount(ENTITY_TYPE_USER, userId));

    List&lt;Map&lt;String, Object&gt;&gt; userList = followService.findFollowers(userId, page.getOffset(), page.getLimit());
    if (userList != null) &#123;
        for (Map&lt;String, Object&gt; map : userList) &#123;
            User u = (User) map.get(&quot;user&quot;);
            map.put(&quot;hasFollowed&quot;, hasFollowed(u.getId()));
        &#125;
    &#125;
    model.addAttribute(&quot;users&quot;, userList);

    return &quot;/site/follower&quot;;
&#125;

private boolean hasFollowed(int userId) &#123;
    if (hostHolder.getUser() == null) &#123;
        return false;
    &#125;

    return followService.hasFollowed(hostHolder.getUser().getId(), ENTITY_TYPE_USER, userId);
&#125;
</code></pre>
<h1 id="6- ä¼˜åŒ–ç™»å½•æ¨¡å—"><a href="#6- ä¼˜åŒ–ç™»å½•æ¨¡å—" class="headerlink" title="6. ä¼˜åŒ–ç™»å½•æ¨¡å—"></a>6. ä¼˜åŒ–ç™»å½•æ¨¡å—</h1><ol>
<li><p>ä½¿ç”¨ Redis å­˜å‚¨éªŒè¯ç ï¼šéªŒè¯ç éœ€è¦é¢‘ç¹è®¿é—®ä¸åˆ·æ–°ï¼Œå¯¹æ€§èƒ½è¦æ±‚è¾ƒé«˜ï¼›éªŒè¯ç ä¸éœ€è¦æ°¸ä¹…ä¿å­˜ï¼Œé€šå¸¸åœ¨å¾ˆçŸ­çš„æ—¶é—´å†…å°±ä¼šå¤±æ•ˆï¼›åˆ†å¸ƒå¼éƒ¨ç½²æ—¶ï¼Œå­˜åœ¨ Session å…±äº«çš„é—®é¢˜ã€‚</p>
</li>
<li><p>ä½¿ç”¨ Redis å­˜å‚¨ç™»å½•å‡­è¯ï¼šå¤„ç†æ¯æ¬¡è¯·æ±‚æ—¶ï¼Œéƒ½è¦æŸ¥è¯¢ç”¨æˆ·çš„ç™»å½•å‡­è¯ï¼Œè®¿é—®çš„é¢‘ç‡éå¸¸é«˜ã€‚</p>
</li>
<li><p>ä½¿ç”¨ Redis ç¼“å­˜ç”¨æˆ·ä¿¡æ¯ï¼šæ¯æ¬¡å¤„ç†è¯·æ±‚æ—¶ï¼Œéƒ½è¦æ ¹æ®å‡­è¯æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œè®¿é—®çš„é¢‘ç‡éå¸¸é«˜ã€‚</p>
</li>
</ol>
<h2 id="6-1- å­˜å‚¨éªŒè¯ç "><a href="#6-1- å­˜å‚¨éªŒè¯ç " class="headerlink" title="6.1 å­˜å‚¨éªŒè¯ç "></a>6.1 å­˜å‚¨éªŒè¯ç </h2><ul>
<li>æ›´æ–°å·¥å…·ç±» RedisUtil<ul>
<li>æ–°å¢éªŒè¯ç å‰ç¼€å¸¸é‡ <code>kaptcha</code></li>
<li>æ–°å¢æ–¹æ³• <code>getKaptchaKey()</code>ï¼Œé€šè¿‡ç”¨æˆ·å‡­è¯ï¼ˆç”±äºæœªç™»å½•ï¼Œé‡‡ç”¨ cookie å®ç°ï¼‰è·å¾—å¯¹åº”éªŒè¯ç çš„ keyï¼ˆåˆ©ç”¨ String å­˜å‚¨éªŒè¯ç ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<pre><code class="java">private static final String PREFIX_KAPTCHA = &quot;kaptcha&quot;;

// ç™»å½•éªŒè¯ç 
public static String getKaptchaKey(String owner) &#123;
    return PREFIX_KAPTCHA + SPLIT + owner;
&#125;
</code></pre>
<ul>
<li>æ›´æ–°è¡¨ç°å±‚çš„ LoginController ç±»<ul>
<li>é‡æ„æ–¹æ³• <code>getKaptcha()</code>ï¼Œå°†éªŒè¯ç å­˜å…¥ redisï¼Œkey ä¸ºå½“å‰éšæœºç”Ÿæˆçš„å­—ç¬¦ä¸²ï¼ŒåŒæ—¶å°†è¯¥å­—ç¬¦ä¸²å­˜å…¥ cookieã€‚</li>
<li>é‡æ„æ–¹æ³• <code>login()</code>ï¼Œä» cookie ä¸­è·å–éšæœºå­—ç¬¦ä¸²ï¼Œç”ŸæˆéªŒè¯ç çš„ keyï¼Œç„¶åè·å– key å¯¹åº”çš„ value å³éªŒè¯ç ã€‚</li>
</ul>
</li>
</ul>
<pre><code class="java">@GetMapping(&quot;/kaptcha&quot;)
public void getKaptcha(HttpServletResponse response/*, HttpSession session*/) &#123;
    // ç”ŸæˆéªŒè¯ç 
    String text = kaptchaProducer.createText();
    BufferedImage image = kaptchaProducer.createImage(text);

    // åŸæ¥çš„åšæ³•ï¼šå°†éªŒè¯ç å­˜å…¥ session
    // session.setAttribute(&quot;kaptcha&quot;, text);

    // éªŒè¯ç çš„å½’å±
    String kaptchaOwner = CommunityUtil.generateUUID();
    Cookie cookie = new Cookie(&quot;kaptchaOwner&quot;, kaptchaOwner);
    cookie.setMaxAge(60);
    cookie.setPath(contextPath);
    response.addCookie(cookie);
    // å°†éªŒè¯ç å­˜å…¥ Redis
    String redisKey = RedisKeyUtil.getKaptchaKey(kaptchaOwner);
    redisTemplate.opsForValue().set(redisKey, text, 60, TimeUnit.SECONDS);

    // å°†å›¾ç‰‡è¾“å‡ºç»™æµè§ˆå™¨
    response.setContentType(&quot;image/png&quot;);
    try &#123;
        OutputStream os = response.getOutputStream();
        ImageIO.write(image, &quot;png&quot;, os);
    &#125; catch (IOException e) &#123;
        logger.error(&quot; å“åº”éªŒè¯ç å¤±è´¥:&quot; + e.getMessage());
    &#125;
&#125;

@PostMapping(&quot;/login&quot;)
public String login(String username, String password, String code, boolean rememberme,
                    Model model, /*HttpSession session, */HttpServletResponse response,
                    @CookieValue(&quot;kaptchaOwner&quot;) String kaptchaOwner) &#123;
    // æ£€æŸ¥éªŒè¯ç 
    // String kaptcha = (String) session.getAttribute(&quot;kaptcha&quot;);
    String kaptcha = null;
    if (StringUtils.isNotBlank(kaptchaOwner)) &#123;
        String redisKey = RedisKeyUtil.getKaptchaKey(kaptchaOwner);
        kaptcha = (String) redisTemplate.opsForValue().get(redisKey);
    &#125;

    if (StringUtils.isBlank(kaptcha) || StringUtils.isBlank(code) || !kaptcha.equalsIgnoreCase(code)) &#123;
        model.addAttribute(&quot;codeMsg&quot;, &quot; éªŒè¯ç ä¸æ­£ç¡®!&quot;);
        return &quot;/site/login&quot;;
    &#125;

    // æ£€æŸ¥è´¦å·, å¯†ç 
    int expiredSeconds = rememberme ? REMEMBER_EXPIRED_SECONDS : DEFAULT_EXPIRED_SECONDS;
    Map&lt;String, Object&gt; map = userService.login(username, password, expiredSeconds);
    if (map.containsKey(&quot;ticket&quot;)) &#123;
        Cookie cookie = new Cookie(&quot;ticket&quot;, map.get(&quot;ticket&quot;).toString());
        cookie.setPath(contextPath);
        cookie.setMaxAge(expiredSeconds);
        response.addCookie(cookie);
        return &quot;redirect:/index&quot;;
    &#125; else &#123;
        model.addAttribute(&quot;usernameMsg&quot;, map.get(&quot;usernameMsg&quot;));
        model.addAttribute(&quot;passwordMsg&quot;, map.get(&quot;passwordMsg&quot;));
        return &quot;/site/login&quot;;
    &#125;
&#125;
</code></pre>
<h2 id="6-2- å­˜å‚¨ç™»å½•å‡­è¯"><a href="#6-2- å­˜å‚¨ç™»å½•å‡­è¯" class="headerlink" title="6.2 å­˜å‚¨ç™»å½•å‡­è¯"></a>6.2 å­˜å‚¨ç™»å½•å‡­è¯</h2><ul>
<li>æ›´æ–°å·¥å…·ç±» RedisUtil<ul>
<li>æ–°å¢ç™»å½•å‡­è¯å‰ç¼€å¸¸é‡ <code>ticket</code></li>
<li>æ–°å¢æ–¹æ³• <code>getTicketKey</code>() ï¼Œé€šè¿‡å­—ç¬¦ä¸²è·å¾—ç™»å½•å‡­è¯çš„å¯¹åº” key ï¼ˆåˆ©ç”¨ String å­˜å‚¨ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<pre><code class="java">private static final String PREFIX_TICKET = &quot;ticket&quot;;

// ç™»å½•çš„å‡­è¯
public static String getTicketKey(String ticket) &#123;
    return PREFIX_TICKET + SPLIT + ticket;
&#125;
</code></pre>
<ul>
<li><p>æ›´æ–°ä¸šåŠ¡å±‚çš„ UserService ç±»</p>
<ul>
<li><p>é‡æ„æ–¹æ³• <code>login()</code> ï¼Œå°†ç™»å½•å‡­è¯å­˜å…¥ redis ä¸­ã€‚</p>
</li>
<li><p>é‡æ„æ–¹æ³• <code>logout</code>() ï¼Œå…ˆä» redis ä¸­è·å–ç™»å½•å‡­è¯å¯¹è±¡ï¼Œå°†çŠ¶æ€è®¾ä¸ºæ— æ•ˆå†é‡æ–°å­˜å‚¨è¿› redisã€‚</p>
</li>
<li><p>é‡æ„æ–¹æ³• <code>findLoginTicket</code>() ï¼Œæ ¹æ® ticket å­—ç¬¦ä¸²è·å¾—å¯¹åº”ç™»å½•å‡­è¯çš„ keyï¼Œç„¶åä» redis æŸ¥è¯¢ç™»å½•å‡­è¯ã€‚</p>
</li>
</ul>
</li>
</ul>
<pre><code class="java">public Map&lt;String, Object&gt; login(String username, String password, int expiredSeconds) &#123;
    Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();

    // ç©ºå€¼å¤„ç†
    if (StringUtils.isBlank(username)) &#123;
        map.put(&quot;usernameMsg&quot;, &quot; è´¦å·ä¸èƒ½ä¸ºç©º!&quot;);
        return map;
    &#125;
    if (StringUtils.isBlank(password)) &#123;
        map.put(&quot;passwordMsg&quot;, &quot; å¯†ç ä¸èƒ½ä¸ºç©º!&quot;);
        return map;
    &#125;

    // éªŒè¯è´¦å·
    User user = userMapper.selectByName(username);
    if (user == null) &#123;
        map.put(&quot;usernameMsg&quot;, &quot; è¯¥è´¦å·ä¸å­˜åœ¨!&quot;);
        return map;
    &#125;

    // éªŒè¯çŠ¶æ€
    if (user.getStatus() == 0) &#123;
        map.put(&quot;usernameMsg&quot;, &quot; è¯¥è´¦å·æœªæ¿€æ´»!&quot;);
        return map;
    &#125;

    // éªŒè¯å¯†ç 
    password = CommunityUtil.md5(password + user.getSalt());
    if (!user.getPassword().equals(password)) &#123;
        map.put(&quot;passwordMsg&quot;, &quot; å¯†ç ä¸æ­£ç¡®!&quot;);
        return map;
    &#125;

    // ç”Ÿæˆç™»å½•å‡­è¯
    LoginTicket loginTicket = new LoginTicket();
    loginTicket.setUserId(user.getId());
    loginTicket.setTicket(CommunityUtil.generateUUID());
    loginTicket.setStatus(0);
    loginTicket.setExpired(new Date(System.currentTimeMillis() + expiredSeconds * 1000));
        // loginTicketMapper.insertLoginTicket(loginTicket);

    String redisKey = RedisKeyUtil.getTicketKey(loginTicket.getTicket());
    redisTemplate.opsForValue().set(redisKey, loginTicket);

    map.put(&quot;ticket&quot;, loginTicket.getTicket());
    return map;
&#125;

public void logout(String ticket) &#123;
        // loginTicketMapper.updateStatus(ticket, 1);
    String redisKey = RedisKeyUtil.getTicketKey(ticket);
    LoginTicket loginTicket = (LoginTicket) redisTemplate.opsForValue().get(redisKey);
    loginTicket.setStatus(1);
    redisTemplate.opsForValue().set(redisKey, loginTicket);
&#125;

public LoginTicket findLoginTicket(String ticket) &#123;
        // return loginTicketMapper.selectByTicket(ticket);
    String redisKey = RedisKeyUtil.getTicketKey(ticket);
    return (LoginTicket) redisTemplate.opsForValue().get(redisKey);
&#125;

public int updateHeader(int userId, String headerUrl) &#123;
        // return userMapper.updateHeader(userId, headerUrl);
    int rows = userMapper.updateHeader(userId, headerUrl);
    clearCache(userId);
    return rows;
&#125;
</code></pre>
<h2 id="6-3- ç¼“å­˜ç”¨æˆ·ä¿¡æ¯"><a href="#6-3- ç¼“å­˜ç”¨æˆ·ä¿¡æ¯" class="headerlink" title="6.3 ç¼“å­˜ç”¨æˆ·ä¿¡æ¯"></a>6.3 ç¼“å­˜ç”¨æˆ·ä¿¡æ¯</h2><ul>
<li><p>æ›´æ–°å·¥å…·ç±» RedisUtil </p>
<ul>
<li><p>æ–°å¢ç”¨æˆ·å‰ç¼€å¸¸é‡ <code>user</code></p>
</li>
<li><p>æ–°å¢ <code>getUserKey</code> æ–¹æ³•ï¼Œé€šè¿‡ç”¨æˆ· id è·å¾—ç”¨æˆ·çš„å¯¹åº” key å€¼ï¼ˆåˆ©ç”¨ String å­˜å‚¨ï¼‰ã€‚</p>
</li>
</ul>
</li>
</ul>
<pre><code class="java">private static final String PREFIX_USER = &quot;user&quot;;

// ç”¨æˆ·
public static String getUserKey(int userId) &#123;
    return PREFIX_USER + SPLIT + userId;
&#125;
</code></pre>
<ul>
<li><p>æ›´æ–°ä¸šåŠ¡å±‚çš„ UserService ç±»</p>
<ul>
<li><p>æ–°å¢ <code>getCache</code>()ï¼Œä»ç¼“å­˜è·å–ç”¨æˆ·ä¿¡æ¯ã€‚</p>
</li>
<li><p>æ–°å¢ <code>initCache()</code>ï¼Œä» MySQL æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯å¹¶å­˜å…¥ redisã€‚</p>
</li>
<li><p>æ–°å¢ <code>clearCache()</code>ï¼Œç”¨æˆ·ä¿¡æ¯å˜æ›´ï¼ˆæ›´æ–°å¤´åƒï¼Œæ¿€æ´»ï¼‰æ—¶æ¸…é™¤ç¼“å­˜ã€‚</p>
</li>
<li><p>é‡æ„ <code>findUserById()</code> æ–¹æ³•ï¼Œé¦–å…ˆè°ƒç”¨ <code>getCache()</code>ä»ç¼“å­˜è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚æœè·å–ä¸º null åˆ™è°ƒç”¨ <code>initCache()</code>ã€‚</p>
</li>
</ul>
</li>
</ul>
<pre><code class="java">// 1. ä¼˜å…ˆä»ç¼“å­˜ä¸­å–å€¼
private User getCache(int userId) &#123;
    String redisKey = RedisKeyUtil.getUserKey(userId);
    return (User) redisTemplate.opsForValue().get(redisKey);
&#125;

// 2. å–ä¸åˆ°æ—¶åˆå§‹åŒ–ç¼“å­˜æ•°æ®
private User initCache(int userId) &#123;
    User user = userMapper.selectById(userId);
    String redisKey = RedisKeyUtil.getUserKey(userId);
    redisTemplate.opsForValue().set(redisKey, user, 3600, TimeUnit.SECONDS);
    return user;
&#125;

// 3. æ•°æ®å˜æ›´æ—¶æ¸…é™¤ç¼“å­˜æ•°æ®
private void clearCache(int userId) &#123;
    String redisKey = RedisKeyUtil.getUserKey(userId);
    redisTemplate.delete(redisKey);
&#125;

public User findUserById(int id) &#123;
        // return userMapper.selectById(id);
    User user = getCache(id);
    if (user == null) &#123;
        user = initCache(id);
    &#125;
    return user;
&#125;
</code></pre>

  </div>
  <div id="gitalk-container"></div>
</div>

<script>
  
Fancybox.bind('[data-fancybox="fancybox-gallery-img"]', {
  dragToClose: true,
  Toolbar: true,
  closeButton: "top",
  Image: {
    zoom: true,
  },
  on: {
    initCarousel: (fancybox) => {
      const slide = fancybox.Carousel.slides[fancybox.Carousel.page];
      fancybox.$container.style.setProperty(
        "--bg-image",
        `url("${slide.$thumb.src}")`
      );
    },
    "Carousel.change": (fancybox, carousel, to, from) => {
      const slide = carousel.slides[to];
      fancybox.$container.style.setProperty(
        "--bg-image",
        `url("${slide.$thumb.src}")`
      );
    },
  },
});
</script>

<style>
    #noneimg img {
        display: none;
        z-index: 9999;
        /* width: 600px !important; */
        min-width: 0%;
        max-width: 90%;
        max-height: 80%;
        border-radius: 0px;
        position: fixed;
        box-shadow: 0 0 0px #c3c3c300 !important;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        margin: auto !important;
    }

    @media screen and (max-width:600px) {
        #noneimg img {
            max-width: 88%
        }
    }
</style>

    <div class="post-paging">
    
    <a href="/2023/03/07/community5/">
        <div class="post-paging-last">
            <span>ä¸Šä¸€ç¯‡</span>
            <p>æ ¡å›­ç¤¾åŒºè®ºå›é¡¹ç›®ä¹‹ Kafka</p>
        </div>
    </a>
    

    
    <a href="/2023/03/07/Kafka/">
        <div class="post-paging-next">
            <span>ä¸‹ä¸€ç¯‡</span>
            <p>åˆ†å¸ƒå¼æµåª’ä½“å¹³å° Kafka</p>
        </div>
    </a>
    
</div>
</div>
		
<div class="footer">
	<div class="Copyright">
		Â©2023 By LebronLe. Themeï¼š<a
			style="text-decoration: none;display: contents; color: #898F9F;"
			target="_blank" rel="noopener" href="https://github.com/79e/hexo-theme-quiet">Quiet</a>
	</div>
	<div class="contact">
		
		<a target="_blank" rel="noopener" href="https://github.com/79E/hexo-theme-quiet">
			<img src="https://cdn.jsdelivr.net/gh/duogongneng/MyBlogImg/imggithub.png" alt="Quietä¸»é¢˜">
		</a>
		
	</div>
</div>

<script src="/js/gotop.js"></script>


<style type="text/css">
    @media screen and (min-width: 600px) {
        .goTop>span {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            opacity: 0.8;
            background: rgba(18, 24, 58, 0.06);
            text-align: center;
            transition: border .5s;
            border: 1px solid rgba(18, 24, 58, 0.06);

            -moz-transition: border .5s;
            /* Firefox 4 */
            -webkit-transition: border .5s;
            /* Safari å’Œ Chrome */
            -o-transition: border .5s;
            /* Opera */
        }

        .goTop>span:hover {
            border: 1px solid #6680B3;
        }


        .goTop {
            position: fixed;
            right: 30px;
            bottom: 80px;
        }

        .goTop>span>svg {
            width: 20px;
            height: 20px;
            opacity: 0.7;
        }

    }

    @media screen and (max-width: 600px) {
        .goTop {
            display: none;
        }
    }
</style>
<div class="goTop" id="js-go_top">
    <span>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
            <g>
                <path d="M13 12v8h-2v-8H4l8-8 8 8z"></path>
            </g>
        </svg>
    </span>
</div>
<script>
    $( '#js-go_top' )
	.gotoTop( {
		offset: 500,
		speed: 300,
		animationShow: {
			'transform': 'translate(0,0)',
			'transition': 'transform .5s ease-in-out'
		},
		animationHide: {
			'transform': 'translate(100px,0)',
			'transition': 'transform .5s ease-in-out'
		}
	} );
</script>


<!-- Baidu Analytics -->
<script defer>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?e2863d3856a812993ba034f5145bf77c";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>



    <!-- Gitalk -->
    <script>
        const data = '{"clientID":"515c62b1616878ab4696","clientSecret":"8e7686de9c499016b4944eb232e1f5e4ddf0aacc","repo":"BlogComment","owner":"hulittlewhite","admin":"hulittlewhite"}'
        const gitalk = new Gitalk({
            ...JSON.parse( data),
            id:location.pathname,
            distractionFreeMode:false
        })
        
        if(Boolean('true')){
            gitalk.render('gitalk-container')
        }
    </script>


<script>
	console.log('\n %c Hexo-Quiet ä¸»é¢˜ %c https://github.com/79e/hexo-theme-quiet \n', 'color: #fadfa3; background: #030307; padding:5px 0;', 'background: #fadfa3; padding:5px 0;')
</script>
	</body>
</html>

